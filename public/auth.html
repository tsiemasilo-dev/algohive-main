<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AlgoHive — Sign in</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  
  <style>
    :root {
      /* --- HIVE THEME (Trading) --- */
      --olive: #7e8d52;
      --olive-700: #576138;
      --ink: #0B1215;
      
      /* --- MONEY THEME (Banking) --- */
      --money-primary: #7c3aed; /* violet-600 */
      --money-dark: #4c1d95;    /* violet-900 */
      --money-bg: #050510;      /* Dark BG for visual side */
      
      --money-grad-start: #3c1a70;
      --money-grad-mid: #6426b0;
      --money-grad-end: #8a3eda;
    }
    
    body { 
      background: #f6f7f6; 
      overflow-x: hidden; 
      font-family: 'Inter', sans-serif; 
      transition: background-color 0.8s cubic-bezier(0.22, 1, 0.36, 1);
    }

    /* --- ANIMATIONS --- */
    .btn-shine { position: relative; overflow: hidden; transition: transform .25s ease, box-shadow .25s ease; }
    .btn-shine::before { content: ""; position: absolute; inset: 0; pointer-events: none; background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.7) 50%, transparent 100%); transform: translateX(-120%); transition: transform .8s ease; }
    .btn-shine:hover::before { transform: translateX(120%); }
    .btn-shine:hover { transform: translateY(-1px); box-shadow: 0 10px 24px -16px rgba(11,18,21,0.4); }
    .btn-shine:disabled { box-shadow: none; transform: none; }
    
    .auth-left { animation: heroSlideUp .7s ease-out .25s both; overflow: hidden; }
    .auth-right { animation: heroScaleIn .9s cubic-bezier(.2,.8,.2,1) .35s both; transition: background-color 0.8s cubic-bezier(0.22, 1, 0.36, 1); }
    
    .auth-right[data-mode="hive"] { background-color: #f7f9ff; }
    .auth-right[data-mode="money"] { background-color: var(--money-bg); }
    
    @keyframes heroScaleIn { 0% { transform: scale(1.06); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes heroSlideUp { 0% { transform: translateY(16px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
    .swap-anim { animation: heroSlideUp .5s ease both; }

    /* --- ACCOUNT PILLS (Shared Structure) --- */
    .account-pill { display: inline-flex; align-items: center; gap: 0.75rem; border-radius: 9999px; border: 1px solid #e5e7eb; background: #fff; padding: 0.55rem 0.95rem; font-weight: 600; font-size: 0.9rem; color: #0b1215; box-shadow: 0 10px 30px -22px rgba(11, 18, 21, 0.35); transition: all .2s ease; cursor: pointer; }
    .account-pill__dot { height: 10px; width: 10px; border-radius: 9999px; background: #d1d5db; box-shadow: 0 0 0 6px rgba(0,0,0,0.05); transition: all .2s ease; }
    
    /* Hive Specific Pill Colors */
    .theme-hive .account-pill--active { border-color: rgba(126,141,82,0.7); background: linear-gradient(135deg, rgba(126,141,82,0.12), rgba(126,141,82,0.05)); color: #2f361d; }
    .theme-hive .account-pill--active .account-pill__dot { background: var(--olive); box-shadow: 0 0 0 8px rgba(126,141,82,0.18); }
    .theme-hive .account-pill:hover { border-color: rgba(126,141,82,0.55); transform: translateY(-1px); }

    /* Money Specific Pill Colors */
    .theme-money .account-pill--active { border-color: rgba(124, 58, 237, 0.7); background: linear-gradient(135deg, rgba(124, 58, 237, 0.12), rgba(124, 58, 237, 0.05)); color: var(--money-dark); }
    .theme-money .account-pill--active .account-pill__dot { background: var(--money-primary); box-shadow: 0 0 0 8px rgba(124, 58, 237, 0.18); }
    .theme-money .account-pill:hover { border-color: rgba(124, 58, 237, 0.55); transform: translateY(-1px); }

    /* --- SLIDER MECHANISM --- */
    #auth-track {
      display: flex;
      width: 200%; /* 2 slides */
      height: 100%;
      will-change: transform;
      transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .auth-slide {
      width: 50%;
      height: 100%;
      flex-shrink: 0;
      padding: 0 1rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    /* --- APP SWITCHER --- */
    .segmented-control { position: relative; display: flex; background: #f1f5f9; padding: 4px; border-radius: 99px; width: fit-content; user-select: none; border: 1px solid #e2e8f0; }
    .segmented-bg { position: absolute; top: 4px; left: 4px; bottom: 4px; width: calc(50% - 4px); background: white; border-radius: 99px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1); z-index: 0; }
    .segmented-btn { position: relative; z-index: 1; padding: 6px 24px; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: color 0.2s ease; text-align: center; min-width: 80px; }
    
    .segmented-control[data-state="hive"] .segmented-bg { transform: translateX(0); }
    .segmented-control[data-state="hive"] .btn-hive { color: var(--ink); }
    .segmented-control[data-state="hive"] .btn-money { color: #94a3b8; }

    .segmented-control[data-state="money"] .segmented-bg { transform: translateX(100%); }
    .segmented-control[data-state="money"] .btn-hive { color: #94a3b8; }
    .segmented-control[data-state="money"] .btn-money { color: var(--money-primary); }

    /* --- BRANDING VISIBILITY --- */
    .brand-hive { display: flex; opacity: 1; transition: opacity 0.3s ease; }
    .brand-money { display: none; opacity: 0; transition: opacity 0.3s ease; }
    
    body[data-app="money"] .brand-hive { display: none; opacity: 0; }
    body[data-app="money"] .brand-money { display: flex; opacity: 1; }

    /* --- PASSWORD STRENGTH BAR --- */
    .password-strength-container {
      margin-top: 0.5rem;
    }
    .password-strength-bar {
      height: 6px;
      border-radius: 3px;
      background: #e5e7eb;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    .password-strength-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease, background-color 0.3s ease;
      width: 0%;
    }
    .password-strength-fill.weak { background: #ef4444; width: 25%; }
    .password-strength-fill.medium { background: #f59e0b; width: 50%; }
    .password-strength-fill.strong { background: #22c55e; width: 75%; }
    .password-strength-fill.very-strong { background: #10b981; width: 100%; }
    .password-strength-text {
      font-size: 0.75rem;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .password-strength-text.weak { color: #ef4444; }
    .password-strength-text.medium { color: #f59e0b; }
    .password-strength-text.strong { color: #22c55e; }
    .password-strength-text.very-strong { color: #10b981; }
    
    /* Money theme password strength colors - all purple spectrum */
    .theme-money .password-strength-fill.weak { background: #ddd6fe; }
    .theme-money .password-strength-fill.medium { background: #a78bfa; }
    .theme-money .password-strength-fill.strong { background: var(--money-primary); }
    .theme-money .password-strength-fill.very-strong { background: #6d28d9; }
    .theme-money .password-strength-text.weak { color: #c4b5fd; }
    .theme-money .password-strength-text.medium { color: #a78bfa; }
    .theme-money .password-strength-text.strong { color: var(--money-primary); }
    .theme-money .password-strength-text.very-strong { color: #6d28d9; }
    .theme-money .password-requirements li.valid { color: var(--money-primary); }
    .theme-money .password-requirements li.valid .check-icon { background: var(--money-primary); border-color: var(--money-primary); }
    .password-requirements {
      margin-top: 0.75rem;
      padding: 0.75rem;
      background: #f8fafc;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
    }
    .password-requirements p {
      font-size: 0.7rem;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .password-requirements ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.25rem 0.5rem;
    }
    .password-requirements li {
      font-size: 0.7rem;
      color: #94a3b8;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      transition: color 0.2s ease;
    }
    .password-requirements li.valid {
      color: #22c55e;
    }
    .password-requirements li .check-icon {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1.5px solid currentColor;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      transition: all 0.2s ease;
    }
    .password-requirements li.valid .check-icon {
      background: #22c55e;
      border-color: #22c55e;
      color: white;
    }

    /* --- TEXT COLORS --- */
    .text-hive { color: var(--olive); }
    .text-hive-hover:hover { color: var(--olive-700); }
    .focus-hive:focus { border-color: var(--olive); --tw-ring-color: rgba(126,141,82,0.25); }
    .bg-hive { background-color: var(--olive); }
    .bg-hive-hover:hover { background-color: var(--olive-700); }

    .text-money { color: var(--money-primary); }
    .text-money-hover:hover { color: var(--money-dark); }
    .focus-money:focus { border-color: var(--money-primary); --tw-ring-color: rgba(124, 58, 237, 0.25); }
    .bg-money { background-color: var(--money-primary); }
    .bg-money-hover:hover { background-color: var(--money-dark); }
    .bg-money-grad { background: linear-gradient(150deg, var(--money-grad-start) 0%, var(--money-grad-mid) 42%, var(--money-grad-end) 100%); }

    /* --- RIGHT PANEL VISUALS --- */
    .orb-gradient { background-image: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.75), rgba(255,255,255,0) 60%), radial-gradient(circle at 80% 20%, rgba(126,141,82,0.18), rgba(255,255,255,0) 55%), radial-gradient(circle at 50% 80%, rgba(126,141,82,0.12), rgba(255,255,255,0) 55%); }

    .scene-container { 
        position: absolute; 
        inset: 0; 
        transition: opacity 0.8s ease, visibility 0.8s ease; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
    }
    
   
    .scene-hidden { 
        opacity: 0 !important; 
        visibility: hidden !important;
        pointer-events: none; 
        z-index: 0;
    }
    .scene-visible { 
        opacity: 1 !important; 
        visibility: visible !important;
        pointer-events: auto; 
        z-index: 20;
    }

  </style>
  <script nonce="ALGOHIVE">
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
</head>

<body class="min-h-screen antialiased text-slate-900" data-app="hive">
  <div class="flex min-h-screen flex-col bg-transparent lg:flex-row lg:items-stretch">
    
    <main class="auth-left relative mx-auto w-full max-w-2xl bg-white px-6 py-12 shadow-sm sm:px-10 sm:py-14 lg:flex lg:min-h-screen lg:max-w-lg lg:flex-col lg:justify-between lg:px-0 lg:py-20 lg:shadow">
      
      <div class="flex flex-col gap-4 px-6 sm:flex-row sm:items-center sm:justify-between sm:px-10 lg:px-16 mb-6">
          <div>
              <div class="brand-hive items-center gap-2">
                <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png" alt="AlgoHive" class="h-8 w-auto" />
                <span class="text-lg font-semibold tracking-tight text-[var(--ink)]">AlgoHive</span>
              </div>
              <div class="brand-money items-center gap-2">
                <img src="https://aazofjsssobejhkyyiqv.supabase.co/storage/v1/object/public/AlgoHive/ICON%20AHM.svg" alt="AlgoMoney" class="h-8 w-8 object-contain" />
                <span class="text-lg font-bold tracking-tight text-slate-900">AlgoMoney</span>
              </div>
          </div>

          <div class="segmented-control self-start sm:self-auto" id="appSwitcher" data-state="hive">
              <div class="segmented-bg"></div>
              <div class="segmented-btn btn-hive" id="btn-hive-trigger">Markets</div>
              <div class="segmented-btn btn-money" id="btn-money-trigger">Money</div>
          </div>
      </div>

      <div id="auth-track">
        
        <div class="auth-slide theme-hive px-6 sm:px-10 lg:px-16" id="slide-hive">
              <div class="flex-1 mt-4">
                <header class="mb-9 space-y-3">
                  <div id="hive-heading-in" class="space-y-2">
                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-hive">Welcome back</p>
                    <h1 class="text-3xl font-semibold text-slate-900 sm:text-[34px]">Sign in to AlgoHive</h1>
                    <p class="text-sm text-slate-500">Need to register? <button id="hive-switch-to-signup" type="button" class="font-semibold text-hive text-hive-hover">Sign up.</button></p>
                  </div>
                  <div id="hive-heading-up" class="hidden space-y-2">
                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-hive">Join the hive</p>
                    <h1 class="text-3xl font-semibold text-slate-900 sm:text-[34px]">Create your account</h1>
                    <p class="text-sm text-slate-500">Already have an account? <button id="hive-switch-to-signin" type="button" class="font-semibold text-hive text-hive-hover">Log in.</button></p>
                  </div>
                </header>

                <section class="mb-8 space-y-3">
                  <div class="flex flex-wrap items-center gap-2 text-xs font-semibold uppercase tracking-[0.28em] text-hive">
                    <span>Account mode</span>
                    <span class="h-[1px] w-10 bg-current opacity-30"></span>
                  </div>
                  <div class="flex flex-wrap gap-3">
                    <button type="button" class="account-pill" data-account="paper">
                      <span class="account-pill__dot" aria-hidden="true"></span>
                      Demo Account
                    </button>
                    <button type="button" class="account-pill" data-account="live">
                      <span class="account-pill__dot" aria-hidden="true"></span>
                      Live Account
                    </button>
                  </div>
                  <p id="hive-live-note" class="hidden text-sm font-semibold text-amber-700">Will Require Additional Verification</p>
                  <p id="hive-live-status" class="hidden text-sm font-semibold text-rose-700">currently under maintenance</p>
                </section>

                <div id="hive-msg" class="hidden mb-5 max-w-md rounded-lg border px-3 py-2 text-sm text-left"></div>

                <section id="hive-panel-in" class="space-y-8">
                  <form id="hive-login-form" class="space-y-5 text-left sm:max-w-md">
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-slate-700">Email or username</label>
                      <input name="email" type="email" placeholder="john@algohive.com" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:outline-none focus:ring-2 focus-hive" required />
                    </div>
                    <div class="space-y-2">
                      <div class="flex items-center justify-between text-sm">
                        <label class="font-medium text-slate-700">Password</label>
                        <button type="button" id="hive-forgot-btn" class="font-medium text-hive text-hive-hover">Forgot password?</button>
                      </div>
                      <input name="password" type="password" placeholder="••••••••" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:outline-none focus:ring-2 focus-hive" required />
                    </div>
                    <button type="submit" class="btn-shine w-full rounded-2xl bg-hive px-4 py-3 text-sm font-semibold text-white shadow-sm transition bg-hive-hover">Log in</button>
                  </form>
                </section>

                <div id="hive-forgot-wrap" class="mt-8 hidden w-full max-w-md rounded-2xl border border-slate-200 bg-slate-50/70 p-5">
                  <h2 class="mb-3 text-sm font-semibold text-slate-700">Reset password</h2>
                  <form id="hive-forgot-form" class="space-y-3">
                    <div class="space-y-1">
                      <label class="text-xs font-medium text-slate-600">Email</label>
                      <input name="email" type="email" placeholder="you@example.com" class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm shadow-sm transition focus:outline-none focus:ring-2 focus-hive" required />
                    </div>
                    <div class="flex flex-col gap-2 sm:flex-row">
                      <button type="submit" class="btn-shine flex-1 rounded-2xl bg-hive px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition bg-hive-hover">Send reset link</button>
                      <button type="button" id="hive-forgot-cancel" class="rounded-2xl border border-slate-200 px-4 py-2.5 text-sm font-semibold text-slate-600 hover:border-slate-300">Cancel</button>
                    </div>
                  </form>
                </div>

                <section id="hive-panel-up" class="hidden space-y-6">
                  <form id="hive-signup-form" class="space-y-5 text-left sm:max-w-md">
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-slate-700">Email</label>
                      <input id="hive-signup-email" name="email" type="email" placeholder="john@algohive.com" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:outline-none focus:ring-2 focus-hive" required />
                    </div>
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-slate-700">Password</label>
                      <input id="hive-signup-password" name="password" type="password" placeholder="Create a strong password" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:outline-none focus:ring-2 focus-hive" required />
                      <div class="password-strength-container" id="hive-password-strength">
                        <div class="password-strength-bar">
                          <div class="password-strength-fill" id="hive-strength-fill"></div>
                        </div>
                        <div class="password-strength-text" id="hive-strength-text"></div>
                      </div>
                      <div class="password-requirements" id="hive-password-requirements">
                        <p>Password must have:</p>
                        <ul>
                          <li id="hive-req-length"><span class="check-icon"></span>8+ characters</li>
                          <li id="hive-req-upper"><span class="check-icon"></span>Uppercase (A-Z)</li>
                          <li id="hive-req-lower"><span class="check-icon"></span>Lowercase (a-z)</li>
                          <li id="hive-req-number"><span class="check-icon"></span>Number (0-9)</li>
                          <li id="hive-req-special"><span class="check-icon"></span>Special (!@#$...)</li>
                        </ul>
                      </div>
                    </div>
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-slate-700">Confirm password</label>
                      <input id="hive-signup-confirm" name="confirm_password" type="password" placeholder="Re-enter your password" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:outline-none focus:ring-2 focus-hive" required />
                      <p id="hive-confirm-hint" class="hidden text-xs font-medium text-rose-600">Passwords must match.</p>
                    </div>
                    <label class="flex items-start gap-3 rounded-2xl bg-slate-50/90 p-4 text-xs text-slate-600">
                      <input id="hive-agree" type="checkbox" class="mt-0.5 h-4 w-4 rounded border-slate-300 text-hive focus:ring-2 focus-hive" />
                      <span>
                        I agree to the
                        <a href="/terms.html" class="font-semibold text-hive text-hive-hover">Terms &amp; Conditions</a>,
                        <a href="/privacy.html" class="font-semibold text-hive text-hive-hover">Privacy Policy</a>,
                        <a href="/risk.html" class="font-semibold text-hive text-hive-hover">Risk Disclosure</a>, and
                        <a href="/investment-disclaimer.html" class="font-semibold text-hive text-hive-hover">Investment Disclaimer</a>.
                      </span>
                    </label>
                    <button id="hive-signup-btn" type="submit" class="btn-shine w-full rounded-2xl bg-hive px-4 py-3 text-sm font-semibold text-white shadow-sm transition bg-hive-hover disabled:cursor-not-allowed disabled:opacity-60" disabled>
                      Start with a demo account
                    </button>
                    <p class="text-[11px] leading-relaxed text-slate-500">We’ll email a confirmation link to activate your account.</p>
                  </form>
                </section>
              </div>
              <footer class="mt-14 border-t border-slate-100 pt-6 text-left text-[11px] leading-5 text-slate-500">
              AlgoHive (Pty) Ltd is an authorised Financial Services Provider (<b>FSP 55118</b>) regulated by the Financial Sector Conduct Authority and a registered Credit Provider (<b>NCRCP22892</b>) under the National Credit Act. All investment activity carries risk, including the possible loss of capital and liquidity constraints. Any information provided here is educational in nature, does not constitute personalised financial advice, and should not be relied on as a recommendation to buy or sell securities. Please consider whether investing is appropriate for your circumstances and consult an independent adviser where necessary.
              </footer>
        </div>

        <div class="auth-slide theme-money px-6 sm:px-10 lg:px-16" id="slide-money">
            <div class="flex-1 mt-4">
              <header class="mb-9 space-y-3">
                <div id="money-heading-in" class="space-y-2">
                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-money">Welcome back</p>
                    <h1 class="text-3xl font-semibold text-slate-900 sm:text-[34px]">Sign in to AlgoMoney</h1>
                    <p class="text-sm text-slate-500">Need to register? <button id="money-switch-to-signup" type="button" class="font-semibold text-money text-money-hover">Sign up.</button></p>
                </div>
                <div id="money-heading-up" class="hidden space-y-2">
                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-money">Join AlgoMoney</p>
                    <h1 class="text-3xl font-semibold text-slate-900 sm:text-[34px]">Create your account</h1>
                    <p class="text-sm text-slate-500">Already have an account? <button id="money-switch-to-signin" type="button" class="font-semibold text-money text-money-hover">Log in.</button></p>
                </div>
              </header>

              <div id="money-msg" class="hidden mb-5 max-w-md rounded-lg border px-3 py-2 text-sm text-left"></div>

              <section id="money-panel-in" class="space-y-8">
                <form id="money-login-form" class="space-y-5 text-left sm:max-w-md">
                  <div class="space-y-2">
                    <label class="text-sm font-medium text-slate-700">Email or username</label>
                    <input name="email" type="email" placeholder="you@algomoney.com" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:outline-none focus:ring-2 focus-money" required />
                  </div>
                  <div class="space-y-2">
                     <div class="flex items-center justify-between text-sm">
                        <label class="font-medium text-slate-700">Password</label>
                        <button type="button" id="money-forgot-btn" class="font-medium text-money text-money-hover">Forgot password?</button>
                      </div>
                    <input name="password" type="password" placeholder="••••••••" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:outline-none focus:ring-2 focus-money" required />
                  </div>
                  <button type="submit" class="btn-shine w-full rounded-2xl bg-money-grad px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:opacity-90">
                     Log in
                  </button>
                </form>
              </section>

              <div id="money-forgot-wrap" class="mt-8 hidden w-full max-w-md rounded-2xl border border-slate-200 bg-slate-50/70 p-5">
                 <h2 class="mb-3 text-sm font-semibold text-slate-700">Reset password</h2>
                 <form id="money-forgot-form" class="space-y-3">
                   <div class="space-y-1">
                     <label class="text-xs font-medium text-slate-600">Email</label>
                     <input name="email" type="email" placeholder="you@example.com" class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm shadow-sm transition focus:outline-none focus:ring-2 focus-money" required />
                   </div>
                   <div class="flex flex-col gap-2 sm:flex-row">
                     <button type="submit" class="btn-shine flex-1 rounded-2xl bg-money-grad px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:opacity-90">Send reset link</button>
                     <button type="button" id="money-forgot-cancel" class="rounded-2xl border border-slate-200 px-4 py-2.5 text-sm font-semibold text-slate-600 hover:border-slate-300">Cancel</button>
                   </div>
                 </form>
               </div>

              <section id="money-panel-up" class="hidden space-y-6">
                <form id="money-signup-form" class="space-y-5 text-left sm:max-w-md">
                  <div class="space-y-2">
                    <label class="text-sm font-medium text-slate-700">Email</label>
                    <input id="money-signup-email" name="email" type="email" placeholder="you@algomoney.com" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:outline-none focus:ring-2 focus-money" required />
                  </div>
                  <div class="space-y-2">
                    <label class="text-sm font-medium text-slate-700">Password</label>
                    <input id="money-signup-password" name="password" type="password" placeholder="Create a strong password" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:outline-none focus:ring-2 focus-money" required />
                    <div class="password-strength-container" id="money-password-strength">
                      <div class="password-strength-bar">
                        <div class="password-strength-fill" id="money-strength-fill"></div>
                      </div>
                      <div class="password-strength-text" id="money-strength-text"></div>
                    </div>
                    <div class="password-requirements" id="money-password-requirements">
                      <p>Password must have:</p>
                      <ul>
                        <li id="money-req-length"><span class="check-icon"></span>8+ characters</li>
                        <li id="money-req-upper"><span class="check-icon"></span>Uppercase (A-Z)</li>
                        <li id="money-req-lower"><span class="check-icon"></span>Lowercase (a-z)</li>
                        <li id="money-req-number"><span class="check-icon"></span>Number (0-9)</li>
                        <li id="money-req-special"><span class="check-icon"></span>Special (!@#$...)</li>
                      </ul>
                    </div>
                  </div>
                  <div class="space-y-2">
                    <label class="text-sm font-medium text-slate-700">Confirm password</label>
                    <input id="money-signup-confirm" name="confirm_password" type="password" placeholder="Re-enter your password" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:outline-none focus:ring-2 focus-money" required />
                    <p id="money-confirm-hint" class="hidden text-xs font-medium text-rose-600">Passwords must match.</p>
                  </div>
                  <label class="flex items-start gap-3 rounded-2xl bg-slate-50/90 p-4 text-xs text-slate-600">
                      <input id="money-agree" type="checkbox" class="mt-0.5 h-4 w-4 rounded border-slate-300 text-money focus:ring-2 focus-money" />
                      <span>
                        I agree to the
                        <a href="/terms.html" class="font-semibold text-money text-money-hover">Terms &amp; Conditions</a>,
                        <a href="/privacy.html" class="font-semibold text-money text-money-hover">Privacy Policy</a>,
                        <a href="/risk.html" class="font-semibold text-money text-money-hover">Risk Disclosure</a>, and
                        <a href="/investment-disclaimer.html" class="font-semibold text-money text-money-hover">Investment Disclaimer</a>.
                      </span>
                  </label>
                  <button id="money-signup-btn" type="submit" class="btn-shine w-full rounded-2xl bg-money-grad px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:opacity-90 disabled:opacity-60 disabled:cursor-not-allowed" disabled>
                     Sign up for AlgoMoney
                  </button>
                  <p class="text-[11px] leading-relaxed text-slate-500">We’ll email a confirmation link to activate your account.</p>
                </form>
              </section>
            </div>
             
             <footer class="mt-14 border-t border-slate-100 pt-6 text-left text-[11px] leading-5 text-slate-500">
               AlgoMoney is a devision of AlgoHive (Pty) Ltd. AlgoHive (Pty) Ltd is an authorised Financial Services Provider (<b>FSP 55118</b>) regulated by the Financial Sector Conduct Authority and a registered Credit Provider (<b>NCRCP22892</b>) under the National Credit Act.
             </footer>
        </div>

      </div>
    </main>

    <!-- Password Update Modal (for weak passwords on login) - Non-dismissable -->
    <div id="password-update-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
      <div class="relative mx-4 w-full max-w-md rounded-3xl bg-white p-8 shadow-2xl">
        <div class="mb-6 text-center">
          <div class="mx-auto mb-4 flex h-14 w-14 items-center justify-center rounded-full bg-amber-100">
            <svg class="h-7 w-7 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
          </div>
          <h2 class="text-xl font-bold text-slate-900">Update Your Password</h2>
          <p class="mt-2 text-sm text-slate-600">Your current password doesn't meet our updated security requirements. Please create a stronger password to continue.</p>
        </div>
        
        <form id="password-update-form" class="space-y-4">
          
          <div>
            <label class="text-sm font-medium text-slate-700">New Password</label>
            <input id="pwd-new" name="new_password" type="password" placeholder="Enter your new password" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm transition focus:border-violet-500 focus:outline-none focus:ring-2 focus:ring-violet-500/20" required />
            <div class="password-strength-container" id="update-password-strength">
              <div class="password-strength-bar">
                <div class="password-strength-fill" id="update-strength-fill"></div>
              </div>
              <div class="password-strength-text" id="update-strength-text"></div>
            </div>
            <div class="password-requirements mt-2" id="update-password-requirements">
              <p class="text-xs font-medium text-slate-500">Password must have:</p>
              <ul class="mt-1 grid grid-cols-2 gap-x-2 gap-y-1 text-xs text-slate-500">
                <li id="update-req-length"><span class="check-icon"></span>8+ characters</li>
                <li id="update-req-upper"><span class="check-icon"></span>Uppercase (A-Z)</li>
                <li id="update-req-lower"><span class="check-icon"></span>Lowercase (a-z)</li>
                <li id="update-req-number"><span class="check-icon"></span>Number (0-9)</li>
                <li id="update-req-special"><span class="check-icon"></span>Special (!@#$...)</li>
              </ul>
            </div>
          </div>
          
          <div>
            <label class="text-sm font-medium text-slate-700">Confirm New Password</label>
            <input id="pwd-confirm" name="confirm_password" type="password" placeholder="Re-enter your new password" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm transition focus:border-violet-500 focus:outline-none focus:ring-2 focus:ring-violet-500/20" required />
            <p id="pwd-confirm-hint" class="mt-1 hidden text-xs font-medium text-rose-600">Passwords must match.</p>
          </div>
          
          <div id="pwd-update-msg" class="hidden rounded-xl p-3 text-sm"></div>
          
          <div class="flex gap-3">
            <button id="pwd-cancel-btn" type="button" class="flex-1 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50">
              Cancel & Sign Out
            </button>
            <button id="pwd-update-btn" type="submit" class="btn-shine flex-1 rounded-xl bg-gradient-to-r from-violet-600 to-violet-500 px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:opacity-90 disabled:cursor-not-allowed disabled:opacity-60" disabled>
              Update Password
            </button>
          </div>
        </form>
      </div>
    </div>

    <aside id="visual-panel" class="auth-right relative hidden w-full bg-[#f7f9ff] px-6 py-14 shadow-inner lg:flex lg:flex-1 lg:items-stretch lg:rounded-none lg:px-20 lg:py-20" data-mode="hive">
      
      <div id="scene-hive" class="scene-container scene-visible absolute inset-0 orb-gradient flex items-center justify-center">
        <div id="authLogoSphere" class="flex w-full max-w-[620px] items-center justify-center">
          <div class="w-full aspect-square" id="authSphereRoot"></div>
        </div>
      </div>

      <div id="scene-money" class="scene-container scene-hidden absolute inset-0 flex items-center justify-center overflow-hidden">
         <video id="money-bg-video" autoplay loop muted playsinline class="w-full h-full object-cover">
            <source src="https://aazofjsssobejhkyyiqv.supabase.co/storage/v1/object/public/AlgoHive/Coin%20Auth%20Page.mp4" type="video/mp4">
         </video>
      </div>

    </aside>
  </div>

  <script nonce="ALGOHIVE">
    // --- SLIDER CONTROLLER ---
    window.goToSlide = function(index) {
        const track = document.getElementById('auth-track');
        const toggle = document.getElementById('appSwitcher');
        const visual = document.getElementById('visual-panel');
        const sceneHive = document.getElementById('scene-hive');
        const sceneMoney = document.getElementById('scene-money');
        
        if (track && toggle) {
            const offset = index * 50; 
            track.style.transform = 'translateX(-' + offset + '%)';
            const mode = index === 0 ? 'hive' : 'money';
            toggle.setAttribute('data-state', mode);
            document.body.setAttribute('data-app', mode);
            
            // Visual Panel Background
            if(visual) visual.setAttribute('data-mode', mode);
            
            // Scene Toggle
            if(mode === 'money') {
                sceneHive.classList.replace('scene-visible', 'scene-hidden');
                sceneMoney.classList.replace('scene-hidden', 'scene-visible');
                // Ensure video plays when revealed
                const vid = document.getElementById('money-bg-video');
                if(vid) vid.play().catch(e => console.log(e));
            } else {
                sceneMoney.classList.replace('scene-visible', 'scene-hidden');
                sceneHive.classList.replace('scene-hidden', 'scene-visible');
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        // Attach click handlers safely
        const btnHive = document.getElementById('btn-hive-trigger');
        const btnMoney = document.getElementById('btn-money-trigger');

        if(btnHive) btnHive.addEventListener('click', () => window.goToSlide(0));
        if(btnMoney) btnMoney.addEventListener('click', () => window.goToSlide(1));
    });
  </script>

  <script type="text/babel" nonce="ALGOHIVE">
    const { useEffect, useRef, useState } = React;
    const SUPABASE_URL = "https://aazofjsssobejhkyyiqv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhem9manNzc29iZWpoa3l5aXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMTI1NDUsImV4cCI6MjA3MzY4ODU0NX0.guYlxaV5RwTlTVFoUhpER0KWEIGPay8svLsxMwyRUyM";

    const defaultSphereImages = [
      { id: "apple", src: "https://logo.clearbit.com/apple.com" },
      { id: "microsoft", src: "https://logo.clearbit.com/microsoft.com" },
      { id: "google", src: "https://logo.clearbit.com/google.com" },
      { id: "amazon", src: "https://logo.clearbit.com/amazon.com" },
      { id: "nvidia", src: "https://logo.clearbit.com/nvidia.com" },
      { id: "meta", src: "https://logo.clearbit.com/meta.com" },
      { id: "visa", src: "https://logo.clearbit.com/visa.com" },
      { id: "netflix", src: "https://logo.clearbit.com/netflix.com" },
      { id: "bitcoin", src: "https://cryptologos.cc/logos/bitcoin-btc-logo.png" },
      { id: "ethereum", src: "https://cryptologos.cc/logos/ethereum-eth-logo.png" },
      { id: "solana", src: "https://cryptologos.cc/logos/solana-sol-logo.png" }
    ];

    const supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const TRADING_LOGOS_KEY = "ah_trading_universe_logos";

    const normalizeLogos = (rows) => {
      const seen = new Set();
      return rows.map((row) => ({ id: (row.symbol || `logo-${row.id}`).toLowerCase(), src: row.logo })).filter((row) => typeof row.src === 'string' && row.src.trim().startsWith('http')).filter(({ src }) => { if (seen.has(src)) return false; seen.add(src); return true; });
    };

    const fetchCachedLogos = () => {
      try {
        const cached = sessionStorage.getItem(TRADING_LOGOS_KEY);
        if (!cached) return null;
        const parsed = JSON.parse(cached);
        const cachedLogos = normalizeLogos(parsed?.source === 'trading_universe' && Array.isArray(parsed.logos) ? parsed.logos : []);
        return cachedLogos.length ? cachedLogos : null;
      } catch (err) { console.warn("Unable to read cached logos", err); return null; }
    };

    async function fetchTradingLogos() {
      const cached = fetchCachedLogos();
      if (cached) return cached;
      if (!supabase) return defaultSphereImages;
      const { data, error } = await supabase.from('trading_universe').select('id, symbol, logo').not('logo', 'is', null).neq('logo', '').limit(60);
      if (error || !data?.length) return defaultSphereImages;
      const logos = normalizeLogos(data);
      if (logos.length) { try { sessionStorage.setItem(TRADING_LOGOS_KEY, JSON.stringify({ source: 'trading_universe', logos })); } catch (err) {} }
      return logos.length ? logos : defaultSphereImages;
    }

    const Sphere = ({ images, size = 620 }) => {
      const [rot, setRot] = useState({ x: 15, y: 0 });
      const [vel, setVel] = useState({ x: 0, y: 0 });
      const [dragging, setDragging] = useState(false);
      const [points, setPoints] = useState([]);
      const last = useRef({ x: 0, y: 0 });
      const radius = size * 0.45; const baseSize = size * 0.14;

      useEffect(() => {
        const pts = []; const count = images.length; const phi = Math.PI * (3 - Math.sqrt(5));
        for (let i = 0; i < count; i++) {
          const y = 1 - (i / (count - 1)) * 2; const r = Math.sqrt(1 - y * y); const theta = phi * i;
          pts.push({ x: Math.cos(theta) * r * radius, y: y * radius, z: Math.sin(theta) * r * radius });
        }
        setPoints(pts);
      }, [images.length, radius]);

      useEffect(() => {
        let id;
        const loop = () => { if (!dragging) { setVel(v => ({ x: v.x * 0.97, y: v.y * 0.97 })); setRot(r => ({ x: r.x + vel.x, y: r.y + vel.y + 0.1 })); } id = requestAnimationFrame(loop); };
        id = requestAnimationFrame(loop); return () => cancelAnimationFrame(id);
      }, [dragging, vel.x, vel.y]);

      const start = (e) => { setDragging(true); setVel({x:0,y:0}); const x=e.clientX||e.touches?.[0]?.clientX||0; const y=e.clientY||e.touches?.[0]?.clientY||0; last.current={x,y}; };
      const move = (e) => { if(!dragging) return; const x=e.clientX||e.touches?.[0]?.clientX||0; const y=e.clientY||e.touches?.[0]?.clientY||0; const dx=x-last.current.x; const dy=y-last.current.y; setRot(r=>({x:r.x-dy*0.45,y:r.y+dx*0.45})); setVel({x:-dy*0.35,y:dx*0.35}); last.current={x,y}; };
      const end = () => setDragging(false);

      const project = (p) => {
        let {x,y,z}=p; const rx=(rot.x*Math.PI)/180; const ry=(rot.y*Math.PI)/180;
        const tx=x*Math.cos(ry)+z*Math.sin(ry); z=-x*Math.sin(ry)+z*Math.cos(ry); x=tx;
        const ty=y*Math.cos(rx)-z*Math.sin(rx); z=y*Math.sin(rx)+z*Math.cos(rx); y=ty;
        const scale=1+z/(radius*3); const visible=z>-radius*0.7;
        return {x,y,scale:Math.max(0.45,scale),visible,opacity:visible?Math.max(0.5,(z+radius)/(radius*1.5)):0,zIndex:Math.round(z)};
      };

      return (
        <div className={`relative ${dragging ? "cursor-grabbing" : "cursor-grab"} select-none`} style={{width:size,height:size}} onMouseDown={start} onMouseMove={move} onMouseUp={end} onMouseLeave={end} onTouchStart={start} onTouchMove={move} onTouchEnd={end}>
          {points.map((p, i) => {
            const proj = project(p); if(!proj.visible) return null; const s=baseSize*proj.scale;
            return <div key={images[i].id} className="absolute" style={{width:s,height:s,left:size/2+proj.x,top:size/2+proj.y,transform:"translate(-50%, -50%)",opacity:proj.opacity,zIndex:1000+proj.zIndex}}>
                <div className="w-full h-full rounded-full overflow-hidden shadow-2xl bg-white p-4">
                  <img src={images[i].src} className="w-full h-full object-contain" draggable={false} loading="lazy" alt={images[i].id} />
                </div>
            </div>;
          })}
        </div>
      );
    };

    const SphereWrapper = () => {
      const [size, setSize] = useState(window.innerWidth >= 1536 ? 720 : 620);
      const [images, setImages] = useState(defaultSphereImages);
      useEffect(() => { let m=true; fetchTradingLogos().then(l => {if(m && l.length) setImages(l)}); return () => m=false; }, []);
      return <Sphere images={images} size={size} />;
    };

    const root = document.getElementById("authSphereRoot");
    if (root) ReactDOM.createRoot(root).render(<SphereWrapper />);
  </script>

  <script type="module" nonce="ALGOHIVE">
    import { signIn, signUp } from "/js/auth.js";
    import { supabase } from "/js/supabase.js";

    let demoSupportsAvatar = true;

    const REQUIRED_FIELDS = [
      "first_name", "last_name", "phone", "dob", "id_number", "nationality",
      "country_residence", "employment_status", "occupation", "employer",
      "income_bracket", "source_of_funds", "net_worth_range", "experience_level",
      "risk_tolerance", "objectives"
    ];
    const REQUIRE_KYC = false;

    function resolveKycBoolean(row){
      const v = row?.kyc_status;
      if (typeof v === "boolean") return v;
      if (typeof v === "string") return ["verified","approved","done","passed","kyc_done"].includes(v.toLowerCase());
      return false;
    }

    function computeProfileComplete(row){
      const core = REQUIRED_FIELDS.every(k => String(row?.[k] ?? "").trim().length > 0);
      return REQUIRE_KYC ? (core && resolveKycBoolean(row)) : core;
    }

    function gateBannerMessage(profileComplete, kycDone) {
      if (!profileComplete && !kycDone) return "Please finish Additional Info and complete KYC first.";
      if (!profileComplete) return "Please finish Additional Info first.";
      if (!kycDone) return "Please complete KYC first.";
      return "";
    }

    async function fetchLiveProfileBasics(user) {
      if (!user) return {};
      const { data, error } = await supabase.from("profiles").select("first_name, last_name, phone, avatar_url").eq("id", user.id).maybeSingle();
      if (error && error.code !== "PGRST116") throw error;
      return data || {};
    }

    async function fetchDemoProfileBasics(user) {
      if (!user) return null;
      try {
        const { data, error } = await supabase.from("demo_profiles").select("id, first_name, last_name, phone, avatar_url, risk_appetite").eq("id", user.id).maybeSingle();
        if (error) throw error;
        return data;
      } catch (err) { return null; }
    }

    async function ensureDemoProfile(accountTypeValue, liveProfile = {}) {
      if (accountTypeValue !== "paper") return null;
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return null;

      const meta = user.user_metadata || {};
      const payload = {
        id: user.id,
        account_mode: "paper",
        first_name: meta.first_name || liveProfile?.first_name || "Demo",
        last_name: meta.last_name || liveProfile?.last_name || "User",
        phone: meta.phone || liveProfile?.phone || null,
        risk_appetite: meta.risk_appetite || "balanced",
        balance: 10000,
        allocated: 0
      };

      const { data, error } = await supabase.from("demo_profiles").insert(payload).select("*").maybeSingle();
      if (error && error.code !== "23505") console.warn("Demo profile ensure error", error); // Ignore duplicate key error
      return data || payload;
    }

    function hasDemoBasics(profile = {}) {
      return ["first_name", "last_name", "phone"].every(k => profile?.[k] && profile[k].trim().length > 0);
    }

    async function hasLiveBrokerageAccount(user) {
      if (!user) return false;
      const { data } = await supabase.from("alpaca_accounts").select("id").eq("user_id", user.id).maybeSingle();
      return !!data;
    }

    async function routePostAuth(preferred = "/home.html", accountTypeValue = "live") {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return; 

        try { 
            sessionStorage.setItem("ah_account_type", accountTypeValue);
            await supabase.auth.updateUser({ data: { account_type: accountTypeValue } });
        } catch (err) { console.warn("Meta update failed", err); }

        const destination = accountTypeValue === "paper" ? "/demo/dashboard.html" : (preferred || "/home.html");

        if (accountTypeValue === "paper") {
            const liveProfile = await fetchLiveProfileBasics(session.user);
            let demoProfile = await fetchDemoProfileBasics(session.user);

            if (!demoProfile) {
                await ensureDemoProfile("paper", liveProfile);
                demoProfile = await fetchDemoProfileBasics(session.user);
            }

            if (!hasDemoBasics({ ...liveProfile, ...demoProfile })) {
                window.location.href = "/demo/onboarding.html";
                return;
            }
            window.location.href = destination;
            return;
        }

        // Live Logic
        let profileComplete = false;
        let kycDone = false;
        
        try {
            const { data } = await supabase.from("profiles").select("*").eq("id", session.user.id).maybeSingle();
            
            // AlgoMoney Specific Check (If destination is money home)
            if (destination.includes('/money/')) {
                 // Use the new column we added to DB, or fallback to manual check
                 profileComplete = data?.algomoney_profile_complete ?? computeProfileComplete(data);
            } else {
                 // Standard Hive Check
                 profileComplete = computeProfileComplete(data);
            }
            
            kycDone = resolveKycBoolean(data);
        } catch (e) {}

        if (!profileComplete || !kycDone) {
            sessionStorage.setItem("ah_gate_reason", gateBannerMessage(profileComplete, kycDone));
            
            // --- FIX: DETECT REDIRECT TARGET ---
            if (destination.includes('/money/')) {
                window.location.href = "/money-onboarding.html"; // Go to Money Onboarding
            } else {
                window.location.href = "/onboarding.html";       // Go to Hive Onboarding
            }
            return;
        }

        window.location.href = destination;
    }

    function showMsg(id, text, type="error") {
        const el = document.getElementById(id);
        if(!el) return;
        el.className = `mb-5 max-w-md rounded-lg border px-3 py-2 text-sm text-left ${type==='error'?'bg-rose-50 text-rose-700 border-rose-200':'bg-emerald-50 text-emerald-700 border-emerald-200'}`;
        el.textContent = text;
        el.classList.remove("hidden");
    }

    // --- SHARED UI LOGIC ---
    function setupFormToggles(prefix) {
        const switchUp = document.getElementById(`${prefix}-switch-to-signup`);
        const switchIn = document.getElementById(`${prefix}-switch-to-signin`);
        const pIn = document.getElementById(`${prefix}-panel-in`);
        const pUp = document.getElementById(`${prefix}-panel-up`);
        const hIn = document.getElementById(`${prefix}-heading-in`);
        const hUp = document.getElementById(`${prefix}-heading-up`);
        const forgotWrap = document.getElementById(`${prefix}-forgot-wrap`);

        if(switchUp) switchUp.onclick = () => { 
            pIn.classList.add('hidden'); hIn.classList.add('hidden'); 
            pUp.classList.remove('hidden'); hUp.classList.remove('hidden'); 
            if(forgotWrap) forgotWrap.classList.add('hidden');
        };
        if(switchIn) switchIn.onclick = () => { 
            pUp.classList.add('hidden'); hUp.classList.add('hidden'); 
            pIn.classList.remove('hidden'); hIn.classList.remove('hidden'); 
            if(forgotWrap) forgotWrap.classList.add('hidden');
        };
    }
    setupFormToggles('hive');
    setupFormToggles('money');

    // --- ACCOUNT PILLS (Hive only now) ---
    const pills = document.querySelectorAll('.account-pill');
    pills.forEach(p => {
        p.onclick = () => {
            pills.forEach(x => x.classList.remove('account-pill--active'));
            p.classList.add('account-pill--active');
            localStorage.setItem("ah_account_type", p.dataset.account);
            updateLiveNote(p.dataset.account);
        };
    });

    function updateLiveNote(type) {
        const note = document.getElementById("hive-live-note");
        const status = document.getElementById("hive-live-status");
        // FIX: specifically target submit button so we don't overwrite forgot-pass button text
        const btn = document.querySelector("#hive-login-form button[type='submit']");
        
        if (note) note.classList.toggle("hidden", type !== "live");
        if (status) {
            status.classList.toggle("hidden", type !== "live");
            status.textContent = type === "live" ? "currently under maintenance" : "";
        }
        if (btn) {
            btn.disabled = (type === "live");
            btn.textContent = type === "live" ? "Unavailable (maintenance)" : "Log in";
        }
    }
    // Init state
    const savedType = localStorage.getItem("ah_account_type") || "live";
    const activePill = document.querySelector(`.account-pill[data-account="${savedType}"]`);
    if(activePill) activePill.classList.add('account-pill--active');
    updateLiveNote(savedType);


    // --- PASSWORD STRENGTH VALIDATION ---
    const PASSWORD_REGEX = {
        length: /.{8,}/,
        upper: /[A-Z]/,
        lower: /[a-z]/,
        number: /[0-9]/,
        special: /[!@#$%^&*()\-_+={}[\]|;:,.?\/]/
    };

    function validatePassword(password) {
        return {
            length: PASSWORD_REGEX.length.test(password),
            upper: PASSWORD_REGEX.upper.test(password),
            lower: PASSWORD_REGEX.lower.test(password),
            number: PASSWORD_REGEX.number.test(password),
            special: PASSWORD_REGEX.special.test(password)
        };
    }

    function isPasswordValid(password) {
        const checks = validatePassword(password);
        return checks.length && checks.upper && checks.lower && checks.number && checks.special;
    }

    function getPasswordStrength(password) {
        if (!password) return { level: '', label: '', score: 0 };
        const checks = validatePassword(password);
        const passed = Object.values(checks).filter(Boolean).length;
        
        if (passed <= 2) return { level: 'weak', label: 'Weak', score: 1 };
        if (passed === 3) return { level: 'medium', label: 'Medium', score: 2 };
        if (passed === 4) return { level: 'strong', label: 'Strong', score: 3 };
        return { level: 'very-strong', label: 'Very Strong', score: 4 };
    }

    function updatePasswordUI(prefix, password) {
        const checks = validatePassword(password);
        const strength = getPasswordStrength(password);
        
        const fillEl = document.getElementById(`${prefix}-strength-fill`);
        const textEl = document.getElementById(`${prefix}-strength-text`);
        
        if (fillEl) {
            fillEl.className = 'password-strength-fill';
            if (strength.level) fillEl.classList.add(strength.level);
        }
        
        if (textEl) {
            textEl.className = 'password-strength-text';
            if (strength.level) {
                textEl.classList.add(strength.level);
                textEl.innerHTML = `<span>${strength.label}</span><span>${strength.score}/4</span>`;
            } else {
                textEl.innerHTML = '';
            }
        }
        
        ['length', 'upper', 'lower', 'number', 'special'].forEach(key => {
            const el = document.getElementById(`${prefix}-req-${key}`);
            if (el) {
                el.classList.toggle('valid', checks[key]);
                const icon = el.querySelector('.check-icon');
                if (icon) icon.innerHTML = checks[key] ? '&#10003;' : '';
            }
        });
        
        return checks;
    }

    // --- GENERIC AUTH HANDLERS ---
    // UPDATED: Added 'redirectUrl' parameter
    function setupAuthLogic(prefix, fixedAccountType = null, redirectUrl = "/home.html") {
        // Validation Logic
        const pass = document.getElementById(`${prefix}-signup-password`);
        const confirm = document.getElementById(`${prefix}-signup-confirm`);
        const hint = document.getElementById(`${prefix}-confirm-hint`);
        const agree = document.getElementById(`${prefix}-agree`);
        const upBtn = document.getElementById(`${prefix}-signup-btn`);

        if (pass && confirm && upBtn) {
            const validate = () => {
                const pVal = pass.value;
                const cVal = confirm.value;
                const match = pVal === cVal;
                
                if(!cVal) {
                   confirm.setCustomValidity("");
                   hint.classList.add("hidden");
                   return true;
                }
                confirm.setCustomValidity(match ? "" : "Mismatch");
                hint.classList.toggle("hidden", match);
                return match;
            };

            const toggle = () => {
                validate();
                updatePasswordUI(prefix, pass.value);
                const passwordValid = isPasswordValid(pass.value);
                upBtn.disabled = !agree.checked || !pass.value || !confirm.value || (pass.value !== confirm.value) || !passwordValid;
            };

            pass.addEventListener("input", toggle);
            confirm.addEventListener("input", toggle);
            agree.addEventListener("change", toggle);
        }

        // Login Submit
        const loginForm = document.getElementById(`${prefix}-login-form`);
        if (loginForm) {
            loginForm.onsubmit = async (e) => {
                e.preventDefault();
                // FIX: specifically target submit button
                const btn = loginForm.querySelector("button[type='submit']");
                const ogText = btn.textContent;
                btn.disabled = true; btn.textContent = "Logging in...";
                
                try {
                    const passwordValue = loginForm.password.value;
                    const { user, error } = await signIn(loginForm.email.value.trim(), passwordValue);
                    if (error) throw error;
                    
                    // Check if password is weak - show password update modal
                    if (!isPasswordValid(passwordValue)) {
                        btn.disabled = false; btn.textContent = ogText;
                        
                        // Store context for the modal (no password stored for security)
                        window._pendingPasswordUpdate = {
                            email: loginForm.email.value.trim(),
                            prefix: prefix,
                            fixedAccountType: fixedAccountType,
                            redirectUrl: redirectUrl
                        };
                        
                        // Show the password update modal
                        const modal = document.getElementById('password-update-modal');
                        if (modal) {
                            modal.classList.remove('hidden');
                            modal.classList.add('flex');
                        }
                        return;
                    }
                    
                    showMsg(`${prefix}-msg`, "Success. Redirecting...", "success");
                    // Determine account type: Fixed (Money=live) or Dynamic (Hive=pill)
                    const accType = fixedAccountType || localStorage.getItem("ah_account_type") || "live";
                    // UPDATED: Use the passed redirectUrl instead of hardcoded string
                    await routePostAuth(redirectUrl, accType);
                } catch (err) {
                    showMsg(`${prefix}-msg`, err.message || "Login failed.");
                    btn.disabled = false; btn.textContent = ogText;
                }
            };
        }

        // Signup Submit
        const signupForm = document.getElementById(`${prefix}-signup-form`);
        if (signupForm) {
            signupForm.onsubmit = async (e) => {
                e.preventDefault();
                const btn = document.getElementById(`${prefix}-signup-btn`);
                
                // Final password validation before submit
                const passwordValue = signupForm.password.value;
                if (!isPasswordValid(passwordValue)) {
                    showMsg(`${prefix}-msg`, "Please ensure your password meets all the requirements.", "error");
                    return;
                }
                
                btn.disabled = true; btn.textContent = "Creating...";
                
                try {
                    const accType = fixedAccountType || localStorage.getItem("ah_account_type") || "live";
                    
                    // --- CHANGED: Removed destructing {data} to avoid undefined error
                    const data = await signUp(signupForm.email.value.trim(), passwordValue, { account_type: accType });
                    
                    if (!data.session) {
                         showMsg(`${prefix}-msg`, "Account created. Please confirm your email.", "success");
                         btn.textContent = "Check email";
                    } else {
                         showMsg(`${prefix}-msg`, "Success. Redirecting...", "success");
                         await routePostAuth(redirectUrl, accType);
                    }
                } catch (err) {
                    const m = err.message.toLowerCase();
                    if (m.includes("already registered")) {
                        showMsg(`${prefix}-msg`, "Account exists. Please log in.", "error");
                    } else {
                        showMsg(`${prefix}-msg`, err.message);
                    }
                    btn.disabled = false; btn.textContent = "Try again";
                }
            };
        }

        // Forgot Password
        const fBtn = document.getElementById(`${prefix}-forgot-btn`);
        const fWrap = document.getElementById(`${prefix}-forgot-wrap`);
        const fCancel = document.getElementById(`${prefix}-forgot-cancel`);
        const fForm = document.getElementById(`${prefix}-forgot-form`);

        if (fBtn && fWrap) {
            fBtn.onclick = () => {
                // Show Login Panel if hidden - ADDED hidden class toggle to prevent overlapping
                document.getElementById(`${prefix}-panel-in`).classList.add('hidden');
                document.getElementById(`${prefix}-heading-in`).classList.remove('hidden');
                document.getElementById(`${prefix}-panel-up`).classList.add('hidden');
                document.getElementById(`${prefix}-heading-up`).classList.add('hidden');
                
                // Prefill
                const emailVal = loginForm?.email?.value;
                if(emailVal && fForm) fForm.email.value = emailVal;
                
                fWrap.classList.remove('hidden');
            };

            if(fCancel) {
                 fCancel.onclick = () => {
                    fWrap.classList.add('hidden');
                    document.getElementById(`${prefix}-panel-in`).classList.remove('hidden');
                 }
            }

            if(fForm) {
                fForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const sBtn = fForm.querySelector("button[type=submit]");
                    const org = sBtn.textContent;
                    sBtn.disabled = true; sBtn.textContent = "Sending...";
                    
                    try {
                        const { error } = await supabase.auth.resetPasswordForEmail(fForm.email.value.trim(), { redirectTo: "https://thealgohive.com/reset" });
                        if(error) throw error;
                        showMsg(`${prefix}-msg`, "Reset link sent (if account exists).", "success");
                        fWrap.classList.add('hidden');
                    } catch(err) {
                        showMsg(`${prefix}-msg`, err.message);
                    } finally {
                        sBtn.disabled = false; sBtn.textContent = org;
                    }
                };
            }
        }
    }

    // Initialize Logic
    setupAuthLogic('hive', null, '/home.html');   // Hive uses local storage toggle, defaults to /home.html
    setupAuthLogic('money', 'live', '/money/home.html'); // Money is always live, redirects to /money/home.html

    // Money Video Speed
    const v = document.getElementById("money-bg-video");
    if(v) v.playbackRate = 1;

    // --- PASSWORD UPDATE MODAL LOGIC ---
    (function setupPasswordUpdateModal() {
        const modal = document.getElementById('password-update-modal');
        const form = document.getElementById('password-update-form');
        const newInput = document.getElementById('pwd-new');
        const confirmInput = document.getElementById('pwd-confirm');
        const confirmHint = document.getElementById('pwd-confirm-hint');
        const submitBtn = document.getElementById('pwd-update-btn');
        const cancelBtn = document.getElementById('pwd-cancel-btn');
        const msgEl = document.getElementById('pwd-update-msg');
        
        if (!modal || !form) return;
        
        // Cancel button - signs out and closes modal
        cancelBtn?.addEventListener('click', async () => {
            cancelBtn.disabled = true;
            cancelBtn.textContent = 'Signing out...';
            try {
                await supabase.auth.signOut();
            } catch (e) {
                console.warn('Sign out error:', e);
            }
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            form.reset();
            msgEl.classList.add('hidden');
            submitBtn.disabled = true;
            cancelBtn.disabled = false;
            cancelBtn.textContent = 'Cancel & Sign Out';
            window._pendingPasswordUpdate = null;
            location.reload();
        });
        
        // Validation - no current password needed since user is already authenticated
        const validateForm = () => {
            const newVal = newInput.value;
            const confirmVal = confirmInput.value;
            
            // Update password strength UI
            updatePasswordUI('update', newVal);
            
            // Check match
            const match = newVal === confirmVal;
            if (confirmVal && !match) {
                confirmHint.classList.remove('hidden');
                confirmInput.setCustomValidity('Mismatch');
            } else {
                confirmHint.classList.add('hidden');
                confirmInput.setCustomValidity('');
            }
            
            // Enable submit only if all valid
            const passwordValid = isPasswordValid(newVal);
            submitBtn.disabled = !newVal || !confirmVal || !match || !passwordValid;
        };
        
        newInput?.addEventListener('input', validateForm);
        confirmInput?.addEventListener('input', validateForm);
        
        // Show message helper
        const showModalMsg = (msg, type = 'error') => {
            msgEl.textContent = msg;
            msgEl.classList.remove('hidden', 'bg-green-50', 'text-green-700', 'bg-red-50', 'text-red-700');
            if (type === 'success') {
                msgEl.classList.add('bg-green-50', 'text-green-700');
            } else {
                msgEl.classList.add('bg-red-50', 'text-red-700');
            }
        };
        
        // Form submit
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const context = window._pendingPasswordUpdate;
            if (!context) {
                showModalMsg('Session expired. Please log in again.');
                return;
            }
            
            const newPassword = newInput.value;
            const confirmPassword = confirmInput.value;
            
            if (newPassword !== confirmPassword) {
                showModalMsg('New passwords do not match.');
                return;
            }
            
            if (!isPasswordValid(newPassword)) {
                showModalMsg('New password does not meet requirements.');
                return;
            }
            
            submitBtn.disabled = true;
            cancelBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            
            try {
                // Update password using Supabase
                const { error } = await supabase.auth.updateUser({ password: newPassword });
                
                if (error) throw error;
                
                // Refresh session to get fresh tokens
                await supabase.auth.refreshSession();
                
                showModalMsg('Password updated successfully! Redirecting...', 'success');
                
                // Redirect after short delay
                setTimeout(() => {
                    const accType = context.fixedAccountType || localStorage.getItem("ah_account_type") || "live";
                    routePostAuth(context.redirectUrl, accType);
                }, 1500);
                
            } catch (err) {
                console.error('Password update error:', err);
                showModalMsg(err.message || 'Failed to update password. Please try again.');
                submitBtn.disabled = false;
                cancelBtn.disabled = false;
                submitBtn.textContent = 'Update Password';
            }
        });
    })();

  </script>
</body>
</html>
