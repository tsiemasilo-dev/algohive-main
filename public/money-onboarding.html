<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AlgoMoney â€” Onboarding</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.sumsub.com/idensic/static/sumsub-kyc.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    
    <style>
        :root {
            /* AlgoMoney Theme */
            --brand: #582c89;
            --brand-700: #3f2263;
            --ink: #0B1215;
        }

        body { background: #f6f7f6; font-family: 'Inter', sans-serif; }

        /* --- PRELOADER --- */
        .preloader { position: fixed; inset: 0; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; background: #f6f7f6; color: var(--ink); transition: opacity .45s ease; }
        .preloader__logo { height: 3rem; width: auto; animation: slideUp .6s ease-out; }
        .preloader__brand { font-size: 1.25rem; font-weight: 600; letter-spacing: -0.01em; animation: slideUp .6s ease-out .08s both; }
        .preloader--hide { opacity: 0; pointer-events: none; }

        /* --- ANIMATIONS & UTILS --- */
        .btn-shine { position: relative; overflow: hidden; transition: transform .25s ease, box-shadow .25s ease; }
        .btn-shine::before { content: ""; position: absolute; inset: 0; pointer-events: none; background: linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, .7) 50%, transparent 100%); transform: translateX(-120%); transition: transform .8s ease; }
        .btn-shine:hover::before { transform: translateX(120%); }
        .btn-shine:hover { transform: translateY(-1px); box-shadow: 0 10px 24px -16px rgba(88, 44, 137, 0.4); }
        .btn-shine:disabled { box-shadow: none; transform: none; opacity: 0.7; cursor: not-allowed; }

        .auth-left { animation: slideUp .7s ease-out .25s both; }
        .auth-right { animation: scaleIn .9s cubic-bezier(.2, .8, .2, 1) .35s both; }
        @keyframes scaleIn { 0% { transform: scale(1.06); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { 0% { transform: translateY(16px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }

        .orb-gradient { background-image: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0) 60%), radial-gradient(circle at 80% 20%, rgba(88, 44, 137, 0.15), rgba(255, 255, 255, 0) 55%), radial-gradient(circle at 50% 80%, rgba(88, 44, 137, 0.1), rgba(255, 255, 255, 0) 55%); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .input-error { border-color: #ef4444 !important; box-shadow: 0 0 0 1px #ef4444; }
        input:focus, select:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 2px rgba(88, 44, 137, 0.2); }

        /* --- STEPS --- */
        .step-flow { position: relative; margin-left: 0.75rem; }
        .step-flow li { position: relative; list-style: none; padding-left: 3rem; padding-bottom: 2.5rem; }
        .step-flow li::before { content: ""; position: absolute; left: 1.125rem; top: 2.5rem; bottom: -0.5rem; width: 1px; background: #e2e8f0; }
        .step-flow li:last-child::before { display: none; }
        .step-circle { transition: all .25s ease; width: 2.25rem; height: 2.25rem; display: flex; align-items: center; justify-content: center; border-radius: 9999px; border: 1px solid #e2e8f0; background: white; color: #64748b; font-size: 0.875rem; font-weight: 600; position: absolute; left: 0; top: 0; z-index: 10; }
        .step-item--active .step-circle { border-color: var(--brand); background: rgba(88, 44, 137, 0.1); color: var(--brand); }
        .step-item--complete .step-circle { background: var(--brand); color: #fff; border-color: var(--brand); }
    </style>
</head>

<body class="min-h-screen antialiased text-slate-900">
    <div id="preloader" class="preloader">
        <img src="https://aazofjsssobejhkyyiqv.supabase.co/storage/v1/object/public/AlgoHive/ICON%20AHM.svg" alt="AlgoMoney" class="preloader__logo h-12 w-auto" />
        <span class="preloader__brand mt-2">AlgoMoney</span>
    </div>

    <div class="flex min-h-screen flex-col bg-transparent lg:flex-row lg:items-stretch">
        
        <main class="auth-left relative hidden w-full max-w-2xl bg-white px-6 py-12 shadow-sm sm:px-10 sm:py-14 no-scrollbar lg:flex lg:h-screen lg:max-w-lg lg:flex-col lg:overflow-y-auto lg:px-16 lg:py-20 lg:shadow lg:sticky lg:top-0">
            <div class="flex items-center gap-2">
                <img src="https://aazofjsssobejhkyyiqv.supabase.co/storage/v1/object/public/AlgoHive/ICON%20AHM.svg" alt="AlgoMoney" class="h-8 w-auto" />
                <span class="text-lg font-semibold tracking-tight text-[var(--ink)]">AlgoMoney</span>
            </div>

            <div class="mt-10 flex flex-1 flex-col gap-12 pr-3 lg:mt-16 lg:pr-6">
                <header class="space-y-3 pr-1">
                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-[var(--brand)]">Start here</p>
                    <h1 class="text-3xl font-semibold text-slate-900 sm:text-[34px]">Create your profile</h1>
                    <p class="text-sm text-slate-500">Complete these steps to unlock AlgoMoney banking features.</p>
                </header>

                <ol class="step-flow" id="stepList">
                    <li data-step-item="1">
                        <span class="step-circle">1</span>
                        <div><h2 class="text-base font-semibold text-slate-900">Basic info</h2><p class="text-sm text-slate-500">Personal details & ID.</p></div>
                    </li>
                    <li data-step-item="2">
                        <span class="step-circle">2</span>
                        <div><h2 class="text-base font-semibold text-slate-900">Identity</h2><p class="text-sm text-slate-500">Nationality & DOB.</p></div>
                    </li>
                    <li data-step-item="3">
                        <span class="step-circle">3</span>
                        <div><h2 class="text-base font-semibold text-slate-900">Employment</h2><p class="text-sm text-slate-500">Income & work status.</p></div>
                    </li>
                    <li data-step-item="4">
                        <span class="step-circle">4</span>
                        <div><h2 class="text-base font-semibold text-slate-900">KYC</h2><p class="text-sm text-slate-500">Identity verification.</p></div>
                    </li>
                </ol>
            </div>
        </main>

        <aside class="auth-right relative flex w-full flex-1 bg-[#f7f9ff] lg:items-stretch lg:rounded-none">
            <div class="absolute inset-0 orb-gradient opacity-90 pointer-events-none"></div>
            <div class="relative z-10 flex w-full items-start justify-center px-4 py-12 sm:px-8 lg:px-16 lg:py-20">
                <div class="w-full max-w-3xl space-y-8">
                    
                    <header class="flex flex-col gap-3 text-left text-slate-800 sm:flex-row sm:items-center sm:justify-between sm:gap-6">
                        <div class="space-y-2">
                            <p class="text-xs font-semibold uppercase tracking-[0.35em] text-[var(--brand)]">Onboarding</p>
                            <h1 class="text-3xl font-semibold sm:text-[34px]">Setup your account</h1>
                        </div>
                        <button id="signOutButton" type="button" class="inline-flex items-center justify-center gap-2 self-start rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:border-[var(--brand)] hover:text-[var(--brand)]">Sign out</button>
                    </header>

                    <section class="rounded-3xl border border-white/40 bg-white/90 p-6 shadow-xl backdrop-blur sm:p-8">
                        <div class="mb-8">
                            <p id="currentStepLabel" class="text-xs font-semibold uppercase tracking-[0.4em] text-[var(--brand-700)]">Step 1 of 4</p>
                            <h2 id="currentStepTitle" class="text-xl font-semibold text-slate-900 mt-1">Tell us about yourself</h2>
                        </div>

                        <form id="form-step-1" class="space-y-8 fade-in">
                            <div class="grid gap-6 md:grid-cols-2">
                                <label class="block space-y-2">
                                    <span class="text-sm font-medium text-slate-700">First Name</span>
                                    <input type="text" id="first_name" class="h-11 w-full rounded-xl border border-slate-200 px-4 text-slate-900 shadow-sm" placeholder="e.g. John" />
                                </label>
                                <label class="block space-y-2">
                                    <span class="text-sm font-medium text-slate-700">Last Name</span>
                                    <input type="text" id="last_name" class="h-11 w-full rounded-xl border border-slate-200 px-4 text-slate-900 shadow-sm" placeholder="e.g. Doe" />
                                </label>
                            </div>
                            <div class="grid gap-6 md:grid-cols-2">
                                <label class="block space-y-2">
                                    <span class="text-sm font-medium text-slate-700">Phone Number</span>
                                    <input type="tel" id="phone" class="h-11 w-full rounded-xl border border-slate-200 px-4 text-slate-900 shadow-sm" placeholder="+27 82 000 0000" />
                                </label>
                                <label class="block space-y-2">
                                    <span class="text-sm font-medium text-slate-700">ID / Passport Number</span>
                                    <input type="text" id="id_number" class="h-11 w-full rounded-xl border border-slate-200 px-4 text-slate-900 shadow-sm" placeholder="ID Number" />
                                </label>
                            </div>
                            <div class="space-y-4 rounded-2xl border border-slate-100 bg-white/70 p-5">
                                <p class="text-sm font-semibold text-slate-900">Residential Address</p>
                                <input type="text" id="address_line1" class="h-11 w-full rounded-xl border border-slate-200 px-4 shadow-sm" placeholder="Street Address" />
                                <div class="grid gap-4 md:grid-cols-2">
                                    <input type="text" id="address_city" class="h-11 w-full rounded-xl border border-slate-200 px-4 shadow-sm" placeholder="City" />
                                    <input type="text" id="address_postal_code" class="h-11 w-full rounded-xl border border-slate-200 px-4 shadow-sm" placeholder="Postal Code" />
                                </div>
                            </div>
                            <div class="flex justify-end pt-4 border-t border-slate-100">
                                <button type="button" id="btn-next-1" class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--brand)] px-6 py-3 text-sm font-semibold text-white shadow-lg">Save & Continue</button>
                            </div>
                        </form>

                        <form id="form-step-2" class="space-y-8 hidden">
                            <div class="grid gap-6 md:grid-cols-2">
                                <label class="block space-y-2">
                                    <span class="text-sm font-medium text-slate-700">Date of Birth</span>
                                    <input type="date" id="dob" class="h-11 w-full rounded-xl border border-slate-200 px-4 text-slate-900 shadow-sm" />
                                </label>
                                <label class="block space-y-2">
                                    <span class="text-sm font-medium text-slate-700">Nationality</span>
                                    <select id="nationality" class="h-11 w-full rounded-xl border border-slate-200 px-4 text-slate-900 shadow-sm bg-white"></select>
                                </label>
                            </div>
                            <div class="flex justify-between pt-4 border-t border-slate-100">
                                <button type="button" id="btn-prev-2" class="text-sm font-semibold text-slate-500 hover:text-slate-800">Back</button>
                                <button type="button" id="btn-next-2" class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--brand)] px-6 py-3 text-sm font-semibold text-white shadow-lg">Save & Continue</button>
                            </div>
                        </form>

                        <form id="form-step-3" class="space-y-8 hidden">
                            <div class="grid gap-6 md:grid-cols-2">
                                <label class="block space-y-2">
                                    <span class="text-sm font-medium text-slate-700">Employment Status</span>
                                    <select id="employment_status" class="h-11 w-full rounded-xl border border-slate-200 px-4 text-slate-900 shadow-sm bg-white">
                                        <option value="">Select...</option>
                                        <option value="Employed">Employed</option>
                                        <option value="Self-employed">Self-employed</option>
                                        <option value="Student">Student</option>
                                        <option value="Unemployed">Unemployed</option>
                                    </select>
                                </label>
                                <label class="block space-y-2">
                                    <span class="text-sm font-medium text-slate-700">Employment Type</span>
                                    <select id="employment_type" class="h-11 w-full rounded-xl border border-slate-200 px-4 text-slate-900 shadow-sm bg-white">
                                        <option value="">Select...</option>
                                        <option value="Permanent">Permanent</option>
                                        <option value="Contract">Contract</option>
                                        <option value="Part-time">Part-time</option>
                                        <option value="Casual">Casual</option>
                                    </select>
                                </label>
                            </div>
                            <div class="grid gap-6 md:grid-cols-2">
                                <label class="block space-y-2">
                                    <span class="text-sm font-medium text-slate-700">Employer Name</span>
                                    <input type="text" id="employer" class="h-11 w-full rounded-xl border border-slate-200 px-4 shadow-sm" />
                                </label>
                                <label class="block space-y-2">
                                    <span class="text-sm font-medium text-slate-700">Occupation</span>
                                    <input type="text" id="occupation" class="h-11 w-full rounded-xl border border-slate-200 px-4 shadow-sm" />
                                </label>
                            </div>
                            <label class="block space-y-2">
                                <span class="text-sm font-medium text-slate-700">Source of Funds</span>
                                <select id="source_of_funds" class="h-11 w-full rounded-xl border border-slate-200 px-4 shadow-sm bg-white">
                                    <option value="Salary">Salary</option>
                                    <option value="Business">Business</option>
                                    <option value="Savings">Savings</option>
                                    <option value="Inheritance">Inheritance</option>
                                    <option value="Other">Other</option>
                                </select>
                            </label>
                            <div class="flex justify-between pt-4 border-t border-slate-100">
                                <button type="button" id="btn-prev-3" class="text-sm font-semibold text-slate-500 hover:text-slate-800">Back</button>
                                <button type="button" id="btn-next-3" class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--brand)] px-6 py-3 text-sm font-semibold text-white shadow-lg">Save & Continue</button>
                            </div>
                        </form>

                        <form id="form-step-4" class="space-y-8 hidden">
                            <div class="rounded-2xl border border-slate-200 bg-slate-50 p-6 text-center">
                                <div class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-white shadow-sm text-2xl">ðŸ†”</div>
                                <h3 class="font-semibold text-slate-900">Verify your identity</h3>
                                <p class="text-sm text-slate-500 mt-1 max-w-sm mx-auto">We use Sumsub for secure verification. Click below to start.</p>
                                
                                <button type="button" id="btn-start-sumsub" class="mt-6 btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--brand)] px-6 py-2.5 text-sm font-semibold text-white shadow-lg">Start Verification</button>
                                
                                <div id="sumsub-sdk-container" class="mt-6 w-full hidden h-[600px] bg-white rounded-xl border border-slate-200 overflow-hidden"></div>
                            </div>

                            <div class="flex justify-between pt-4 border-t border-slate-100">
                                <button type="button" id="btn-prev-4" class="text-sm font-semibold text-slate-500 hover:text-slate-800">Back</button>
                                <button type="button" id="btn-complete" disabled class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--brand)] px-6 py-3 text-sm font-semibold text-white shadow-lg opacity-50 cursor-not-allowed">Complete Setup</button>
                            </div>
                        </form>

                    </section>
                </div>
            </div>
        </aside>
    </div>

    <script type="module" nonce="ALGOHIVE">
        import { supabase } from "/js/supabase.js";
        
        // --- VARIABLES ---
        let userSession = null;
        let profileRow = {};
        const totalSteps = 4;
        let currentStep = 1; // Fixed: Use LET not CONST

        const COUNTRIES = [
            {code:"ZAF",name:"South Africa"},{code:"USA",name:"United States"},{code:"GBR",name:"United Kingdom"},
            {code:"NGA",name:"Nigeria"},{code:"KEN",name:"Kenya"},{code:"AUS",name:"Australia"},{code:"CAN",name:"Canada"},
            {code:"DEU",name:"Germany"},{code:"FRA",name:"France"},{code:"IND",name:"India"},{code:"CHN",name:"China"},
            {code:"JPN",name:"Japan"},{code:"OTHER",name:"Other"}
        ].sort((a,b) => a.name.localeCompare(b.name));

        // --- PRELOADER ---
        window.addEventListener("load", () => {
            const p = document.getElementById("preloader");
            if(p) { p.classList.add("preloader--hide"); setTimeout(()=>p.remove(), 450); }
            populateCountries();
        });

        // --- ATTACH LISTENERS (Fixes CSP Inline Block) ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btn-next-1')?.addEventListener('click', () => nextStep(1));
            
            document.getElementById('btn-prev-2')?.addEventListener('click', () => showStep(1));
            document.getElementById('btn-next-2')?.addEventListener('click', () => nextStep(2));
            
            document.getElementById('btn-prev-3')?.addEventListener('click', () => showStep(2));
            document.getElementById('btn-next-3')?.addEventListener('click', () => nextStep(3));
            
            document.getElementById('btn-prev-4')?.addEventListener('click', () => showStep(3));
            document.getElementById('btn-start-sumsub')?.addEventListener('click', startSumsubVerification);
            document.getElementById('btn-complete')?.addEventListener('click', completeOnboarding);
            
            document.getElementById('signOutButton')?.addEventListener('click', async () => {
                await supabase.auth.signOut();
                window.location.href = '/auth.html';
            });
        });

        // --- INIT ---
        (async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '/auth.html?mode=money';
                return;
            }
            userSession = session;
            
            const { data } = await supabase.from('profiles').select('*').eq('id', session.user.id).maybeSingle();
            if(data) {
                profileRow = data;
                fillFields(data);
                if(data.algomoney_profile_complete) {
                    // Optional: redirect if already done
                    // window.location.href = '/money/home.html';
                }
            }
        })();

        function populateCountries() {
            const sel = document.getElementById('nationality');
            if(sel && sel.options.length <= 1) {
                COUNTRIES.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.code; opt.text = c.name;
                    sel.appendChild(opt);
                });
                if(profileRow.nationality) sel.value = profileRow.nationality;
            }
        }

        // --- ACTIONS ---
        async function nextStep(step) {
            const btn = document.getElementById(`btn-next-${step}`);
            if(btn) { btn.textContent = "Saving..."; btn.disabled = true; }

            try {
                const payload = collectData(step);
                // Simple validation
                const isEmpty = Object.values(payload).some(v => !v || v.trim() === '');
                if(isEmpty) throw new Error("Please fill in all fields.");

                const { error } = await supabase.from('profiles').upsert({
                    id: userSession.user.id,
                    updated_at: new Date().toISOString(),
                    ...payload
                });
                if(error) throw error;

                showStep(step + 1);
            } catch(e) {
                alert(e.message);
            } finally {
                if(btn) { btn.textContent = "Save & Continue"; btn.disabled = false; }
            }
        };

        function showStep(step) {
            currentStep = step;
            document.querySelectorAll('form[id^="form-step-"]').forEach(el => el.classList.add('hidden'));
            
            const active = document.getElementById(`form-step-${step}`);
            if(active) {
                active.classList.remove('hidden');
                active.classList.add('auth-left'); 
            }

            // Update Labels
            const titles = ["", "Personal Details", "Identity", "Employment", "Verification"];
            const labels = ["", "Step 1 of 4", "Step 2 of 4", "Step 3 of 4", "Step 4 of 4"];
            document.getElementById('currentStepTitle').textContent = titles[step];
            document.getElementById('currentStepLabel').textContent = labels[step];

            // Sidebar
            document.querySelectorAll('[data-step-item]').forEach(li => {
                const idx = parseInt(li.dataset.stepItem);
                li.classList.remove('step-item--active', 'step-item--complete');
                const circle = li.querySelector('.step-circle');
                
                if(idx === step) {
                    li.classList.add('step-item--active');
                    circle.textContent = idx;
                } else if(idx < step) {
                    li.classList.add('step-item--complete');
                    circle.textContent = "âœ“";
                } else {
                    circle.textContent = idx;
                }
            });
        }

        async function startSumsubVerification() {
            const btn = document.getElementById('btn-start-sumsub');
            btn.textContent = "Loading..."; btn.disabled = true;

            try {
                // Call Backend
                const response = await fetch('/api/samsub/kyc/init-websdk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ externalUserId: userSession.user.id, levelName: 'basic-kyc-level', ttlInSecs: 3600 })
                });

                if(!response.ok) throw new Error("Backend connection failed.");

                const resData = await response.json();
                launchWebSdk(resData.data.token);

            } catch(e) {
                console.warn(e);
                // Fallback for demo
                alert("KYC Backend unavailable. Simulating success.");
                document.getElementById('btn-start-sumsub').classList.add('hidden');
                const container = document.getElementById('sumsub-sdk-container');
                container.classList.remove('hidden');
                container.innerHTML = `<div class="flex h-full items-center justify-center p-6 text-slate-500"><p>Verification Simulated.</p></div>`;
                const cBtn = document.getElementById('btn-complete');
                cBtn.disabled = false;
                cBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function launchWebSdk(accessToken) {
            const container = document.getElementById('sumsub-sdk-container');
            container.classList.remove('hidden');
            document.getElementById('btn-start-sumsub').classList.add('hidden');

            if(window.idns) {
                window.idns.init({
                    accessToken: accessToken,
                    applicantEmail: userSession.user.email,
                    container: '#sumsub-sdk-container',
                    onMessage: (type, payload) => {
                        console.log('Sumsub:', type, payload);
                        if(type === 'idCheck.onApplicantStatusChanged' && payload.reviewStatus === 'completed') {
                            const cBtn = document.getElementById('btn-complete');
                            cBtn.disabled = false;
                            cBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                });
            }
        }

        async function completeOnboarding() {
            const btn = document.getElementById('btn-complete');
            btn.textContent = "Finalizing..."; btn.disabled = true;

            try {
                await supabase.from('profiles').update({
                    kyc_status: 'submitted',
                    onboarding_complete: true,
                    updated_at: new Date().toISOString()
                }).eq('id', userSession.user.id);
                
                window.location.href = '/money/home.html';
            } catch(e) {
                window.location.href = '/money/home.html';
            }
        }

        function collectData(step) {
            const data = {};
            const map = {
                1: ['first_name', 'last_name', 'phone', 'id_number', 'address_line1', 'address_city', 'address_postal_code'],
                2: ['dob', 'nationality'],
                3: ['employment_status', 'employment_type', 'occupation', 'employer', 'source_of_funds']
            };
            if(map[step]) {
                map[step].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) data[id] = el.value;
                });
            }
            return data;
        }

        function fillFields(data) {
            for(const [k, v] of Object.entries(data)) {
                const el = document.getElementById(k);
                if(el && v) el.value = v;
            }
        }
    </script>
</body>
</html>
