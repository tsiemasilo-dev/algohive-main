<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AlgoHive — Onboarding</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --olive: #7e8d52;
            --olive-700: #576138;
            --ink: #0B1215;
        }

        body {
            background: #f6f7f6;
        }

        .preloader {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: #f6f7f6;
            color: var(--ink);
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            transition: opacity .45s ease;
        }

        .preloader__logo {
            height: 3rem;
            width: auto;
            animation: heroSlideUp .6s ease-out, preloaderPulse 2.4s ease-in-out .45s infinite;
        }

        .preloader__brand {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            animation: heroSlideUp .6s ease-out .08s both;
        }

        .preloader__tagline {
            font-size: .95rem;
            color: rgba(11, 18, 21, 0.68);
            animation: heroSlideUp .6s ease-out .14s both;
        }

        .preloader--hide {
            opacity: 0;
            pointer-events: none;
        }

        .btn-shine {
            position: relative;
            overflow: hidden;
            transition: transform .25s ease, box-shadow .25s ease;
        }

        .btn-shine::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, .7) 50%, transparent 100%);
            transform: translateX(-120%);
            transition: transform .8s ease;
        }

        .btn-shine:hover::before {
            transform: translateX(120%);
        }

        .btn-shine:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px -16px rgba(11, 18, 21, 0.4);
        }

        .btn-shine:disabled {
            box-shadow: none;
            transform: none;
        }

        .btn-shine:disabled::before {
            display: none;
        }

        .auth-left {
            animation: heroSlideUp .7s ease-out .25s both;
        }

        .auth-right {
            animation: heroScaleIn .9s cubic-bezier(.2, .8, .2, 1) .35s both;
        }

        @keyframes heroScaleIn {
            0% {
                transform: scale(1.06);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes heroSlideUp {
            0% {
                transform: translateY(16px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes preloaderPulse {

            0%,
            100% {
                opacity: .45;
            }

            50% {
                opacity: 1;
            }
        }

        .swap-anim {
            animation: heroSlideUp .5s ease both;
        }

        .orb-gradient {
            background-image: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0) 60%),
                radial-gradient(circle at 80% 20%, rgba(126, 141, 82, 0.18), rgba(255, 255, 255, 0) 55%),
                radial-gradient(circle at 50% 80%, rgba(126, 141, 82, 0.12), rgba(255, 255, 255, 0) 55%);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .input-error {
            border-color: rgba(248, 113, 113, 0.55) !important;
            box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.28);
        }

        .field-error {
            outline: 2px solid rgba(248, 113, 113, 0.35);
            outline-offset: 4px;
            border-radius: 1.25rem;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 999px;
            background: var(--olive);
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.25);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            height: 18px;
            width: 18px;
            border-radius: 999px;
            background: var(--olive);
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.25);
            cursor: pointer;
            border: none;
        }

        .step-flow {
            position: relative;
            margin-left: 0.75rem;
        }

        .step-flow li {
            position: relative;
            list-style: none;
            padding-left: 3rem;
        }

        .step-flow li::before {
            content: "";
            position: absolute;
            left: 1.125rem;
            top: 2.5rem;
            bottom: -2.5rem;
            width: 1px;
            background: linear-gradient(to bottom, rgba(148, 163, 184, 0.28), rgba(148, 163, 184, 0.08));
        }

        .step-flow li:last-child::before {
            bottom: 0.75rem;
            background: linear-gradient(to bottom, rgba(148, 163, 184, 0.28), rgba(148, 163, 184, 0));
        }

        .step-circle {
            transition: all .25s ease;
        }

        .step-item--active .step-circle {
            border-color: var(--olive);
            background: rgba(126, 141, 82, 0.12);
            color: var(--olive-700);
        }

        .step-item--complete .step-circle {
            background: var(--olive);
            color: #fff;
            border-color: var(--olive);
        }

        .step-item--error .step-circle {
            border-color: rgba(248, 113, 113, 0.7);
            background: rgba(248, 113, 113, 0.12);
            color: #b91c1c;
        }

        .toast-stack {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 400;
            pointer-events: none;
        }

        .toast-card {
            pointer-events: auto;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            min-width: 260px;
            max-width: 360px;
            padding: 0.9rem 1rem;
            border-radius: 1rem;
            background-image: linear-gradient(135deg, #0b1215, #1c2714);
            color: #f8fafc;
            box-shadow: 0 18px 42px -18px rgba(11, 18, 21, 0.7);
            border: 1px solid rgba(126, 141, 82, 0.45);
            transform: translateX(120%);
            opacity: 0;
            animation: toastIn 0.45s cubic-bezier(.22, 1, .36, 1) forwards;
        }

        .plan-group--error {
            outline: 2px solid rgba(248, 113, 113, 0.45);
            outline-offset: 6px;
            border-radius: 1.75rem;
        }

        .toast-card[data-tone="err"],
        .toast-card[data-tone="warn"] {
            border-color: rgba(248, 113, 113, 0.55);
        }

        .toast-icon {
            flex-shrink: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.15rem;
            height: 2.15rem;
            border-radius: 9999px;
            background: rgba(126, 141, 82, 0.18);
            border: 1px solid rgba(126, 141, 82, 0.45);
            color: rgba(226, 232, 240, 0.95);
        }

        .toast-card[data-tone="err"] .toast-icon,
        .toast-card[data-tone="warn"] .toast-icon {
            background: rgba(248, 113, 113, 0.12);
            border-color: rgba(248, 113, 113, 0.45);
            color: rgba(254, 226, 226, 0.95);
        }

        .toast-card[data-tone="ok"] .toast-icon {
            color: rgba(190, 242, 100, 0.95);
        }

        .toast-message {
            margin: 0;
            font-size: 0.95rem;
            line-height: 1.45;
            font-weight: 500;
            color: inherit;
        }

        .toast-content {
            flex: 1;
            display: flex;
            align-items: center;
            padding-top: 0.1rem;
        }

        .toast-dismiss {
            margin-left: auto;
            margin-top: 0.1rem;
            background: transparent;
            border: 0;
            color: rgba(248, 250, 252, 0.75);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            transition: background 0.2s ease, color 0.2s ease;
            cursor: pointer;
        }

        .toast-dismiss:hover {
            background: rgba(15, 23, 42, 0.22);
            color: rgba(248, 250, 252, 0.95);
        }

        .product-card {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 1.5rem;
            border-radius: 1.75rem;
            padding: 1.75rem;
            color: #f8fafc;
            background: #0b1215;
            overflow: hidden;
            text-decoration: none;
            border: 1px solid rgba(248, 250, 252, 0.08);
            box-shadow: 0 32px 68px -42px rgba(0, 0, 0, 0.85);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .product-card::after {
            content: "";
            position: absolute;
            inset: 0;
            z-index: 0;
            opacity: 0.88;
            transition: opacity 0.3s ease;
        }

        .product-card>* {
            position: relative;
            z-index: 1;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 42px 82px -44px rgba(0, 0, 0, 0.82);
        }

        .product-card:hover::after {
            opacity: 1;
        }

        .product-card--invest::after {
            background: linear-gradient(140deg, #010302 0%, #0d2518 42%, #2f8f4e 100%);
        }

        .product-card__eyebrow {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.32em;
            text-transform: uppercase;
            color: rgba(248, 250, 252, 0.7);
        }

        .product-card__title {
            font-size: 1.3rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            color: #f8fafc;
        }

        .product-card__copy {
            font-size: 0.95rem;
            line-height: 1.6;
            color: rgba(248, 250, 252, 0.78);
        }

        .product-card__cta {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 0.28em;
            text-transform: uppercase;
            color: rgba(248, 250, 252, 0.85);
        }

        .product-card__cta svg {
            width: 1rem;
            height: 1rem;
        }

        .product-card:hover .product-card__cta {
            color: #ffffff;
        }

        .toast-card--leaving {
            animation: toastOut 0.32s ease forwards;
        }

        @keyframes toastIn {
            0% {
                transform: translateX(120%);
                opacity: 0;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastOut {
            0% {
                transform: translateX(0);
                opacity: 1;
            }

            100% {
                transform: translateX(120%);
                opacity: 0;
            }
        }
    </style>
  <script nonce="ALGOHIVE">
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
</head>

<body class="min-h-screen antialiased text-slate-900">
    <div id="preloader" class="preloader">
        <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png"
            alt="AlgoHive logo" class="preloader__logo" />
        <span class="preloader__brand">AlgoHive</span>
        <span class="preloader__tagline">Where Smart Capital Gathers</span>
    </div>
    <div class="flex min-h-screen flex-col bg-transparent lg:flex-row lg:items-stretch">
        <!-- Left: Onboarding -->
        <main
            class="auth-left relative hidden w-full max-w-2xl bg-white px-6 py-12 shadow-sm sm:px-10 sm:py-14 no-scrollbar lg:flex lg:h-screen lg:max-w-lg lg:flex-col lg:overflow-y-auto lg:px-16 lg:py-20 lg:shadow lg:sticky lg:top-0">
            <!-- Brand -->
            <div class="flex items-center gap-2">
                <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png"
                    alt="AlgoHive" class="h-8 w-auto" />
                <span class="text-lg font-semibold tracking-tight text-[var(--ink)]">AlgoHive</span>
            </div>

            <!-- Onboarding content -->
            <div class="mt-10 flex flex-1 flex-col gap-12 pr-3 lg:mt-16 lg:pr-6">
                <header class="space-y-3 pr-1">
                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-[var(--olive)]">Start here</p>
                    <h1 class="text-3xl font-semibold text-slate-900 sm:text-[34px]">Connect your AlgoHive accounts</h1>
                    <p class="text-sm text-slate-500">Complete each onboarding step to tailor AlgoHive to your personal
                        investing experience.</p>
                </header>

                <section class="text-left text-slate-700">
                    <ol class="step-flow space-y-10">
                        <li data-step-item="1">
                            <span data-step-indicator="1"
                                class="step-circle absolute left-0 top-0 flex h-9 w-9 items-center justify-center rounded-full border border-[var(--olive)]/40 bg-white text-sm font-semibold text-[var(--olive-700)] shadow-sm">1</span>
                            <div class="space-y-1">
                                <h2 class="text-base font-semibold text-slate-900">Basic info</h2>
                                <p class="text-sm text-slate-500">Share your personal details to set up your profile.
                                </p>
                            </div>
                        </li>
                        <li data-step-item="2">
                            <span data-step-indicator="2"
                                class="step-circle absolute left-0 top-0 flex h-9 w-9 items-center justify-center rounded-full border border-[var(--olive)]/40 bg-white text-sm font-semibold text-[var(--olive-700)] shadow-sm">2</span>
                            <div class="space-y-1">
                                <h2 class="text-base font-semibold text-slate-900">Identity &amp; tax</h2>
                                <p class="text-sm text-slate-500">Confirm your identity numbers and residency data.</p>
                            </div>
                        </li>
                        <li data-step-item="3">
                            <span data-step-indicator="3"
                                class="step-circle absolute left-0 top-0 flex h-9 w-9 items-center justify-center rounded-full border border-[var(--olive)]/40 bg-white text-sm font-semibold text-[var(--olive-700)] shadow-sm">3</span>
                            <div class="space-y-1">
                                <h2 class="text-base font-semibold text-slate-900">Employment &amp; income</h2>
                                <p class="text-sm text-slate-500">Confirm your employment status and income sources.</p>
                            </div>
                        </li>
                        <li data-step-item="4">
                            <span data-step-indicator="4"
                                class="step-circle absolute left-0 top-0 flex h-9 w-9 items-center justify-center rounded-full border border-[var(--olive)]/40 bg-white text-sm font-semibold text-[var(--olive-700)] shadow-sm">4</span>
                            <div class="space-y-1">
                                <h2 class="text-base font-semibold text-slate-900">Compliance</h2>
                                <p class="text-sm text-slate-500">Provide your declarations and regulatory
                                    acknowledgements.</p>
                            </div>
                        </li>
                        <li data-step-item="5">
                            <span data-step-indicator="5"
                                class="step-circle absolute left-0 top-0 flex h-9 w-9 items-center justify-center rounded-full border border-[var(--olive)]/40 bg-white text-sm font-semibold text-[var(--olive-700)] shadow-sm">5</span>
                            <div class="space-y-1">
                                <h2 class="text-base font-semibold text-slate-900">KYC</h2>
                                <p class="text-sm text-slate-500">Upload your identity documents for quick verification.
                                </p>
                            </div>
                        </li>
                        <li data-step-item="6">
                            <span data-step-indicator="6"
                                class="step-circle absolute left-0 top-0 flex h-9 w-9 items-center justify-center rounded-full border border-[var(--olive)]/40 bg-white text-sm font-semibold text-[var(--olive-700)] shadow-sm">6</span>
                            <div class="space-y-1">
                                <h2 class="text-base font-semibold text-slate-900">Brokerage requirements</h2>
                                <p class="text-sm text-slate-500">Confirm the disclosures required to open your
                                    brokerage account.</p>
                            </div>
                        </li>
                        <li data-step-item="7">
                            <span data-step-indicator="7"
                                class="step-circle absolute left-0 top-0 flex h-9 w-9 items-center justify-center rounded-full border border-[var(--olive)]/40 bg-white text-sm font-semibold text-[var(--olive-700)] shadow-sm">7</span>
                            <div class="space-y-1">
                                <h2 class="text-base font-semibold text-slate-900">Subscription plans</h2>
                                <p class="text-sm text-slate-500">Choose the strategies and billing that suit you best.
                                </p>
                            </div>
                        </li>
                    </ol>
                </section>
            </div>

        </main>

        <!-- Right: Workspace -->
        <aside class="auth-right relative flex w-full flex-1 bg-[#f7f9ff] lg:items-stretch lg:rounded-none">
            <div class="absolute inset-0 orb-gradient opacity-90"></div>
            <div class="relative z-10 flex w-full items-start justify-center px-4 py-12 sm:px-8 lg:px-16 lg:py-20">
                <div class="w-full max-w-3xl space-y-8">
                    <header id="onboardingIntro"
                        class="flex flex-col gap-3 text-left text-slate-800 sm:flex-row sm:items-center sm:justify-between sm:gap-6">
                        <div class="space-y-2">
                            <p class="text-xs font-semibold uppercase tracking-[0.35em] text-[var(--olive)]">Onboarding</p>
                            <h1 class="text-3xl font-semibold sm:text-[34px]">Complete your AlgoHive profile</h1>
                            <p class="text-sm text-slate-600">Share the information we need to tailor AlgoHive to your
                                individual investing needs.</p>
                        </div>
                        <button id="signOutButton" type="button"
                            class="inline-flex items-center justify-center gap-2 self-start rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:border-[var(--olive)] hover:text-[var(--olive-700)]">
                            Sign out
                        </button>
                    </header>

                    <section
                        class="rounded-3xl border border-white/40 bg-white/90 p-6 shadow-[0_20px_50px_-28px_rgba(15,23,42,0.55)] backdrop-blur sm:p-8">
                        <div class="flex flex-col gap-6">
                            <div id="stepSummary"
                                class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
                                <div>
                                    <p id="currentStepLabel"
                                        class="text-xs font-semibold uppercase tracking-[0.4em] text-[var(--olive-700)]">
                                        Step 1 of 7 · Basic info</p>
                                    <h2 id="currentStepTitle" class="text-xl font-semibold text-slate-900">Tell us about
                                        yourself</h2>
                                </div>
                                <div class="flex flex-col items-start gap-2 text-left sm:items-end sm:text-right">
                                    <span
                                        class="text-[11px] font-semibold uppercase tracking-[0.35em] text-slate-400">Having
                                        trouble?</span>
                                    <a href="mailto:support@algohive.io"
                                        class="inline-flex items-center justify-center gap-2 rounded-full border border-[var(--olive)] px-4 py-2 text-xs font-semibold text-[var(--olive-700)] transition hover:bg-[var(--olive)] hover:text-white">Contact
                                        us</a>
                                </div>
                            </div>

                            <div id="onboardingFlow" class="space-y-10">
                                <form data-panel="1" class="tab-panel space-y-10" novalidate>
                                    <div class="grid gap-6 md:grid-cols-2">
                                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                            First name
                                            <input type="text" id="first_name" name="first_name"
                                                placeholder="e.g. Buyusiphe"
                                                class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                        </label>
                                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                            Last name
                                            <input type="text" id="last_name" name="last_name"
                                                placeholder="e.g. Maimbra"
                                                class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                        </label>
                                    </div>

                                    <div class="grid gap-6 md:grid-cols-[minmax(0,360px)_1fr]">
                                        <div class="flex flex-col gap-2">
                                            <span class="text-sm font-medium text-slate-700">Avatar</span>
                                            <div
                                                class="flex items-center gap-4 rounded-2xl border border-dashed border-slate-200 bg-slate-50/60 p-4">
                                                <div
                                                    class="flex h-16 w-16 items-center justify-center overflow-hidden rounded-full bg-slate-200">
                                                    <img id="avatar-preview"
                                                        src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'&gt;&lt;rect width='100%' height='100%' fill='%23e2e8f0'/&gt;&lt;/svg&gt;"
                                                        alt="Profile avatar preview" class="h-16 w-16 object-cover" />
                                                </div>
                                                <div class="flex flex-1 flex-col gap-2 text-sm text-slate-500">
                                                    <input type="file" id="avatar-file" name="avatar"
                                                        accept="image/png,image/jpeg" class="hidden" />
                                                    <label for="avatar-file"
                                                        class="inline-flex cursor-pointer items-center justify-center gap-2 rounded-full border border-[var(--olive)] px-4 py-1.5 text-xs font-semibold text-[var(--olive-700)] transition hover:bg-[var(--olive)] hover:text-white">
                                                        Choose file
                                                    </label>
                                                    <span id="avatar-filename" class="text-xs text-slate-400">No file
                                                        chosen</span>
                                                    <p class="text-xs text-slate-400">JPG/PNG, 2 MB. Best results:
                                                        512×512px.</p>
                                                    <button type="button" id="remove-avatar"
                                                        class="self-start text-xs font-medium text-rose-500 hover:underline hidden">Remove
                                                        avatar</button>
                                                </div>
                                            </div>
                                        </div>
                                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                            Contact Phone (Including Country Code)
                                            <input type="tel" id="phone" name="phone" placeholder="+27 81 750 8624"
                                                class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                        </label>
                                    </div>

                                    <div class="space-y-4 rounded-2xl border border-slate-100 bg-white/70 p-5">
                                        <div class="space-y-1">
                                            <p class="text-sm font-semibold text-slate-900">Residential address</p>
                                            <p class="text-sm text-slate-500">Use the address that appears on your proof of
                                                residence document.</p>
                                        </div>
                                        <div class="grid gap-4 md:grid-cols-2">
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Street address line 1
                                                <input type="text" id="address_line1" name="address_line1"
                                                    placeholder="Building, street and number"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Street address line 2 (optional)
                                                <input type="text" id="address_line2" name="address_line2"
                                                    placeholder="Apartment, suite, etc."
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                City / Town
                                                <input type="text" id="address_city" name="address_city"
                                                    placeholder="e.g. Cape Town"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                State / Province
                                                <input type="text" id="address_state" name="address_state"
                                                    placeholder="e.g. Western Cape"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700 md:col-span-2 lg:col-span-1">
                                                Postal / ZIP code
                                                <input type="text" id="address_postal_code" name="address_postal_code"
                                                    placeholder="e.g. 7441"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                            </label>
                                        </div>
                                    </div>

                                    <div
                                        class="flex flex-col gap-4 border-t border-slate-100 pt-6 sm:flex-row sm:items-center sm:justify-between">
                                        <div class="flex items-center gap-2">
                                            <button type="button" data-step-delta="1" data-save-profile
                                                class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Save
                                                &amp; continue</button>
                                        </div>
                                    </div>
                                </form>

                                <form data-panel="2" class="tab-panel hidden space-y-10" novalidate>
                                    <div class="space-y-6">
                                        <div class="grid gap-6 md:grid-cols-2">
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Date of birth
                                                <input type="date" id="dob" name="dob"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Government ID / Passport number
                                                <input type="text" id="id_number" name="id_number"
                                                    placeholder="0405236097086"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                            </label>
                                        </div>

                                        <div class="grid gap-6 md:grid-cols-2">
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Tax identification number
                                                <input type="text" id="tax_id_number" name="tax_id_number"
                                                    placeholder="Social Security Number, PAN, etc."
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                                <p id="taxIdHelper" class="text-xs text-slate-500">Enter the identifier exactly as it appears on your documentation.</p>
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Tax ID type
                                                <select id="tax_id_type" name="tax_id_type"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                    <option value="tin">Tax Identification Number (TIN)</option>
                                                    <option value="ssn">Social Security Number (SSN)</option>
                                                    <option value="pan">Permanent Account Number (PAN)</option>
                                                    <option value="vat">VAT / GST number</option>
                                                    <option value="national_id">National identification number</option>
                                                    <option value="passport">Passport number</option>
                                                </select>
                                            </label>
                                        </div>

                                        <div class="grid gap-6 md:grid-cols-3">
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Country of birth
                                                <select id="country_birth" name="country_birth"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                </select>
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Country of citizenship
                                                <select id="nationality" name="nationality"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                </select>
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Country of tax residence
                                                <select id="country_residence" name="country_residence"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                </select>
                                            </label>
                                        </div>
                                    </div>

                                    <div
                                        class="flex flex-col gap-4 border-t border-slate-100 pt-6 sm:flex-row sm:items-center sm:justify-between">
                                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                            <button type="button" data-step-delta="-1"
                                                class="inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2.5 text-sm font-semibold text-slate-600 transition hover:bg-slate-100">Back</button>
                                            <button type="button" data-step-delta="1" data-save-profile
                                                class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Save
                                                &amp; continue</button>
                                        </div>
                                    </div>
                                </form>

                                <form data-panel="3" class="tab-panel hidden space-y-10" novalidate>
                                    <div class="space-y-6">
                                        <div class="grid gap-6 md:grid-cols-2">
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Employment status
                                                <select id="employment_status" name="employment_status"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                    <option value="employed">Employed</option>
                                                    <option value="self-employed">Self-employed</option>
                                                    <option value="student">Student</option>
                                                    <option value="unemployed">Unemployed</option>
                                                    <option value="retired">Retired</option>
                                                </select>
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Occupation
                                                <input type="text" id="occupation" name="occupation"
                                                    placeholder="e.g. Quantitative analyst"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                            </label>
                                        </div>

                                        <div class="grid gap-6 md:grid-cols-2">
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Employer
                                                <input type="text" id="employer" name="employer"
                                                    placeholder="Company or trading entity"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Funding source
                                                <select id="source_of_funds" name="source_of_funds"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                    <option value="salary">Salary</option>
                                                    <option value="business">Business income</option>
                                                    <option value="investments">Investments</option>
                                                    <option value="inheritance">Inheritance</option>
                                                    <option value="gift">Gift</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </label>
                                        </div>

                                        <div class="space-y-5 rounded-2xl border border-slate-100 bg-white/70 p-5">
                                            <div class="space-y-1">
                                                <p class="text-sm font-semibold text-slate-900">Financial ranges</p>
                                                <p class="text-sm text-slate-500">Use the sliders to share the ranges that best
                                                    describe your income and net worth.</p>
                                            </div>
                                            <div class="space-y-5">
                                                <div class="space-y-3 rounded-xl border border-slate-100 bg-white/70 p-4">
                                                    <div class="flex items-center justify-between">
                                                        <p class="text-sm font-medium text-slate-700">Annual income</p>
                                                        <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">From &middot; To</p>
                                                    </div>
                                                    <div class="grid gap-4 md:grid-cols-2">
                                                        <div class="space-y-2">
                                                            <div class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide text-slate-500">
                                                                <span>Minimum</span>
                                                                <span id="annual_income_min_display" class="text-sm text-slate-900">R0</span>
                                                            </div>
                                                            <input type="range" id="annual_income_min" name="annual_income_min" min="0"
                                                                max="5000000" step="10000" value="0"
                                                                class="h-2 w-full cursor-pointer appearance-none rounded-full bg-slate-200"
                                                                data-range-output="annual_income_min_display" data-range-role="min"
                                                                data-range-pair="annual_income_max" />
                                                        </div>
                                                        <div class="space-y-2">
                                                            <div class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide text-slate-500">
                                                                <span>Maximum</span>
                                                                <span id="annual_income_max_display" class="text-sm text-slate-900">R0</span>
                                                            </div>
                                                            <input type="range" id="annual_income_max" name="annual_income_max" min="0"
                                                                max="5000000" step="10000" value="0"
                                                                class="h-2 w-full cursor-pointer appearance-none rounded-full bg-slate-200"
                                                                data-range-output="annual_income_max_display" data-range-role="max"
                                                                data-range-pair="annual_income_min" />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="space-y-3 rounded-xl border border-slate-100 bg-white/70 p-4">
                                                    <div class="flex items-center justify-between">
                                                        <div class="flex items-center gap-2">
                                                            <p class="text-sm font-medium text-slate-700">Liquid net worth</p>
                                                            <div class="relative group">
                                                                <span
                                                                    class="inline-flex h-5 w-5 cursor-help items-center justify-center rounded-full border border-slate-300 text-[10px] font-semibold text-slate-600">I</span>
                                                                <div
                                                                    class="pointer-events-none absolute left-full top-1/2 z-20 ml-2 hidden w-56 -translate-y-1/2 rounded-lg border border-slate-200 bg-white p-3 text-xs font-medium text-slate-600 shadow-lg group-hover:block">
                                                                    Cash and investments you can quickly access, such as savings or brokerage balances.
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">From &middot; To</p>
                                                    </div>
                                                    <div class="grid gap-4 md:grid-cols-2">
                                                        <div class="space-y-2">
                                                            <div class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide text-slate-500">
                                                                <span>Minimum</span>
                                                                <span id="liquid_net_worth_min_display" class="text-sm text-slate-900">R0</span>
                                                            </div>
                                                            <input type="range" id="liquid_net_worth_min" name="liquid_net_worth_min" min="0"
                                                                max="10000000" step="10000" value="0"
                                                                class="h-2 w-full cursor-pointer appearance-none rounded-full bg-slate-200"
                                                                data-range-output="liquid_net_worth_min_display" data-range-role="min"
                                                                data-range-pair="liquid_net_worth_max" />
                                                        </div>
                                                        <div class="space-y-2">
                                                            <div class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide text-slate-500">
                                                                <span>Maximum</span>
                                                                <span id="liquid_net_worth_max_display" class="text-sm text-slate-900">R0</span>
                                                            </div>
                                                            <input type="range" id="liquid_net_worth_max" name="liquid_net_worth_max" min="0"
                                                                max="10000000" step="10000" value="0"
                                                                class="h-2 w-full cursor-pointer appearance-none rounded-full bg-slate-200"
                                                                data-range-output="liquid_net_worth_max_display" data-range-role="max"
                                                                data-range-pair="liquid_net_worth_min" />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="space-y-3 rounded-xl border border-slate-100 bg-white/70 p-4">
                                                    <div class="flex items-center justify-between">
                                                        <div class="flex items-center gap-2">
                                                            <p class="text-sm font-medium text-slate-700">Total net worth</p>
                                                            <div class="relative group">
                                                                <span
                                                                    class="inline-flex h-5 w-5 cursor-help items-center justify-center rounded-full border border-slate-300 text-[10px] font-semibold text-slate-600">I</span>
                                                                <div
                                                                    class="pointer-events-none absolute left-full top-1/2 z-20 ml-2 hidden w-56 -translate-y-1/2 rounded-lg border border-slate-200 bg-white p-3 text-xs font-medium text-slate-600 shadow-lg group-hover:block">
                                                                    Your overall assets minus liabilities, including property and investments.
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">From &middot; To</p>
                                                    </div>
                                                    <div class="grid gap-4 md:grid-cols-2">
                                                        <div class="space-y-2">
                                                            <div class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide text-slate-500">
                                                                <span>Minimum</span>
                                                                <span id="total_net_worth_min_display" class="text-sm text-slate-900">R0</span>
                                                            </div>
                                                            <input type="range" id="total_net_worth_min" name="total_net_worth_min" min="0"
                                                                max="20000000" step="20000" value="0"
                                                                class="h-2 w-full cursor-pointer appearance-none rounded-full bg-slate-200"
                                                                data-range-output="total_net_worth_min_display" data-range-role="min"
                                                                data-range-pair="total_net_worth_max" />
                                                        </div>
                                                        <div class="space-y-2">
                                                            <div class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide text-slate-500">
                                                                <span>Maximum</span>
                                                                <span id="total_net_worth_max_display" class="text-sm text-slate-900">R0</span>
                                                            </div>
                                                            <input type="range" id="total_net_worth_max" name="total_net_worth_max" min="0"
                                                                max="20000000" step="20000" value="0"
                                                                class="h-2 w-full cursor-pointer appearance-none rounded-full bg-slate-200"
                                                                data-range-output="total_net_worth_max_display" data-range-role="max"
                                                                data-range-pair="total_net_worth_min" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="grid gap-6 md:grid-cols-2">
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Experience Level with US Stocks
                                                <select id="experience_level" name="experience_level"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                    <option value="none">None</option>
                                                    <option value="beginner">Beginner</option>
                                                    <option value="intermediate">Intermediate</option>
                                                    <option value="advanced">Advanced</option>
                                                </select>
                                            </label>
                                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                Risk tolerance
                                                <select id="risk_tolerance" name="risk_tolerance"
                                                    class="h-11 rounded-xl border border-slate-200 px-4 text-base font-normal text-slate-900 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20">
                                                    <option value="">Select…</option>
                                                    <option value="low">Low</option>
                                                    <option value="moderate">Moderate</option>
                                                    <option value="high">High</option>
                                                </select>
                                            </label>
                                        </div>

                                        <div class="space-y-3">
                                            <span class="text-sm font-medium text-slate-700">Investment
                                                objectives</span>
                                            <div id="objectives-group" class="grid gap-3 rounded-2xl sm:grid-cols-2">
                                                <label
                                                    class="flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <input type="checkbox" name="objectives" value="Growth"
                                                        class="h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    Growth
                                                </label>
                                                <label
                                                    class="flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <input type="checkbox" name="objectives" value="Income"
                                                        class="h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    Income
                                                </label>
                                                <label
                                                    class="flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <input type="checkbox" name="objectives" value="Preservation"
                                                        class="h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    Capital preservation
                                                </label>
                                                <label
                                                    class="flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <input type="checkbox" name="objectives" value="Speculation"
                                                        class="h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    Speculation
                                                </label>
                                                <label
                                                    class="flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <input type="checkbox" name="objectives" value="Hedging"
                                                        class="h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    Hedging
                                                </label>
                                                <label
                                                    class="flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <input type="checkbox" name="objectives" value="Other"
                                                        class="h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    Other
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div
                                        class="flex flex-col gap-4 border-t border-slate-100 pt-6 sm:flex-row sm:items-center sm:justify-between">
                                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                            <button type="button" data-step-delta="-1"
                                                class="inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2.5 text-sm font-semibold text-slate-600 transition hover:bg-slate-100">Back</button>
                                            <button type="button" data-step-delta="1" data-save-profile
                                                class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Save
                                                &amp; continue</button>
                                        </div>
                                    </div>
                                </form>

                                <form data-panel="4" class="tab-panel hidden space-y-10" novalidate>
                                    <div class="space-y-6">
                                        <div class="space-y-3">
                                            <p class="text-sm font-medium text-slate-700">Regulatory declarations</p>
                                            <label
                                                class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-left text-sm text-slate-600 shadow-sm">
                                                <input type="checkbox" name="aml"
                                                    class="mt-1 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                <span>I acknowledge AlgoHive’s anti-money laundering policies and agree
                                                    to provide any supporting documentation if requested.</span>
                                            </label>
                                        </div>

                                        <div class="space-y-3">
                                            <p class="text-sm font-medium text-slate-700">Brokerage disclosures</p>
                                            <p class="text-sm text-slate-500">Confirm the statements below before you submit your brokerage application.</p>
                                            <div class="space-y-3">
                                                <label
                                                    class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-left text-sm text-slate-600 shadow-sm">
                                                    <input type="checkbox" id="alpacaControlPerson"
                                                        class="mt-1 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    <span>I am a control person or officer of a publicly traded
                                                        company.</span>
                                                </label>
                                                <label
                                                    class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-left text-sm text-slate-600 shadow-sm">
                                                    <input type="checkbox" id="alpacaAffiliated"
                                                        class="mt-1 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    <span>I am affiliated with a broker-dealer, exchange, or FINRA member
                                                        firm.</span>
                                                </label>
                                                <label
                                                    class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-left text-sm text-slate-600 shadow-sm">
                                                    <input type="checkbox" id="alpacaPoliticallyExposed"
                                                        class="mt-1 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    <span>I am a politically exposed person (PEP).</span>
                                                </label>
                                                <label
                                                    class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-left text-sm text-slate-600 shadow-sm">
                                                    <input type="checkbox" id="alpacaFamilyExposed"
                                                        class="mt-1 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                    <span>A member of my immediate family is a PEP.</span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="space-y-3">
                                            <p class="text-sm font-medium text-slate-700">Suitability acknowledgements
                                            </p>
                                            <label
                                                class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-left text-sm text-slate-600 shadow-sm">
                                                <input type="checkbox" name="objectives_ack"
                                                    class="mt-1 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                <span>I understand AlgoHive’s strategies involve market risk and have
                                                    considered my investment objectives and tolerance.</span>
                                            </label>
                                            <label
                                                class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-left text-sm text-slate-600 shadow-sm">
                                                <input type="checkbox" name="disclosures"
                                                    class="mt-1 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]/20" />
                                                <span>I confirm all the information supplied is accurate and I will
                                                    update AlgoHive if anything changes.</span>
                                            </label>
                                        </div>

                                    </div>

                                    <div
                                        class="flex flex-col gap-4 border-t border-slate-100 pt-6 sm:flex-row sm:items-center sm:justify-between">
                                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                            <button type="button" data-step-delta="-1"
                                                class="inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2.5 text-sm font-semibold text-slate-600 transition hover:bg-slate-100">Back</button>
                                            <button type="button" data-step-delta="1" data-save-profile
                                                class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Save
                                                &amp; continue</button>
                                        </div>
                                    </div>
                                </form>

                                <form data-panel="6" class="tab-panel hidden space-y-10" novalidate>
                                    <div class="space-y-6">
                                        <div class="space-y-3 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                                            <p class="text-sm font-medium text-slate-700">Why we need this step</p>
                                            <p class="text-sm text-slate-500">AlgoHive opens a regulated brokerage account
                                                for you through our partner so you can trade seamlessly inside the
                                                platform.</p>
                                            <ul class="list-disc space-y-2 pl-5 text-sm text-slate-500">
                                                <li>Ensure your AlgoHive profile matches your official identification
                                                    documents.</li>
                                                <li>Keep your residency, nationality, and tax information up to date so
                                                    the brokerage team can approve your application.</li>
                                                <li>Have supporting documentation ready in case the brokerage team
                                                    requests follow-up details.</li>
                                        </ul>
                                    </div>

                                        <div
                                            class="space-y-4 rounded-3xl border border-[var(--olive)]/40 bg-white p-6 shadow-sm">
                                            <div
                                                class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                                <div>
                                                    <p class="text-sm font-semibold text-slate-800">Create your brokerage
                                                        account</p>
                                                    <p id="alpacaStatusText" class="text-sm text-slate-500">Submit your
                                                        disclosures to generate a brokerage profile.</p>
                                                </div>
                                                <span id="alpacaStatusBadge"
                                                    class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-slate-600">Not
                                                    started</span>
                                            </div>
                                            <div class="flex flex-wrap items-center gap-3">
                                                <button type="button" id="alpacaCreateButton"
                                                    class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40"
                                                    data-saving-text="Submitting…">
                                                    Create brokerage account
                                                </button>
                                                <span class="text-xs uppercase tracking-[0.35em] text-slate-400">Sandbox
                                                    submission</span>
                                            </div>
                                            <div class="space-y-3 rounded-2xl border border-slate-200 bg-slate-50 p-4">
                                                <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
                                                    <p class="text-sm font-semibold text-slate-800">Agreements</p>
                                                    <p class="text-xs uppercase tracking-[0.35em] text-slate-400">Review and
                                                        check to continue</p>
                                                </div>
                                                <div class="space-y-2 text-sm text-slate-700">
                                                    <template id="alpacaAgreementTemplate">
                                                        <label class="flex items-start gap-3">
                                                            <input type="checkbox" class="mt-[6px] h-4 w-4 rounded border-slate-300 text-[var(--olive)] shadow-sm focus:ring-[var(--olive)] focus:ring-offset-0"
                                                                data-alpaca-agreement />
                                                            <span class="leading-relaxed">
                                                                I agree to the
                                                                <a class="font-semibold text-[var(--olive)] underline decoration-[var(--olive)]/60 decoration-2 underline-offset-4"
                                                                    href="#" target="_blank" rel="noreferrer noopener"
                                                                    data-agreement-link></a>
                                                            </span>
                                                        </label>
                                                    </template>
                                                    <div id="alpacaAgreementsList" class="space-y-2"></div>
                                                </div>
                                            </div>
                                            <p id="alpacaAccountExisting" class="hidden text-sm text-slate-600">
                                                Existing brokerage account number:
                                                <span id="alpacaAccountIdValue" class="font-semibold text-slate-800"></span>
                                            </p>
                                            <div id="alpacaAccountSummary" class="hidden rounded-2xl border border-slate-200 bg-slate-50 p-4">
                                                <div class="flex items-center justify-between gap-2">
                                                    <p class="text-sm font-semibold text-slate-800">Brokerage account summary</p>
                                                    <button type="button" id="alpacaSummaryRefresh"
                                                        class="text-xs font-semibold uppercase tracking-[0.18em] text-[var(--olive)] underline decoration-[var(--olive)]/60 decoration-2 underline-offset-4">
                                                        Refresh
                                                    </button>
                                                </div>
                                                <dl id="alpacaAccountSummaryBody" class="mt-3 grid gap-2 text-sm text-slate-700 sm:grid-cols-2"></dl>
                                            </div>
                                        </div>
                                    </div>

                                    <div
                                        class="flex flex-col gap-4 border-t border-slate-100 pt-6 sm:flex-row sm:items-center sm:justify-between">
                                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                            <button type="button" data-step-delta="-1"
                                                class="inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2.5 text-sm font-semibold text-slate-600 transition hover:bg-slate-100">Back</button>
                                            <button type="button" data-step-delta="1" data-save-profile
                                                class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Save
                                                &amp; continue</button>
                                        </div>
                                    </div>
                                </form>

                                <form data-panel="5" class="tab-panel hidden space-y-10" novalidate>
                                    <div class="space-y-6">
                                        <div class="space-y-6 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                                            <div
                                                class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                                <div class="space-y-1">
                                                    <p class="text-sm font-semibold text-slate-800">Identity documents</p>
                                                    <p class="text-sm text-slate-500">Upload the documents below so we can
                                                        verify your identity.</p>
                                                </div>
                                                <span
                                                    class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-slate-600">Required</span>
                                            </div>
                                            <div class="grid gap-4 sm:grid-cols-2">
                                                <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                    Selfie
                                                    <p class="text-xs font-normal text-slate-500">Take a clear photo of yourself with good lighting.</p>
                                                    <input id="kycSelfie" type="file" accept="image/*"
                                                        class="h-11 rounded-xl border border-slate-200 px-4 text-sm font-normal text-slate-900 shadow-sm file:mr-3 file:rounded-lg file:border-0 file:bg-[var(--olive)] file:px-4 file:py-2 file:text-sm file:font-semibold file:text-white focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                                </label>
                                                <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                                    Government ID or passport
                                                    <p class="text-xs font-normal text-slate-500">Upload a photo of your ID card or passport.</p>
                                                    <input id="kycIdDocument" type="file" accept="image/*,.pdf"
                                                        class="h-11 rounded-xl border border-slate-200 px-4 text-sm font-normal text-slate-900 shadow-sm file:mr-3 file:rounded-lg file:border-0 file:bg-[var(--olive)] file:px-4 file:py-2 file:text-sm file:font-semibold file:text-white focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                                </label>
                                                <label class="flex flex-col gap-2 text-sm font-medium text-slate-700 sm:col-span-2">
                                                    Proof of address (dated within 3 months)
                                                    <p class="text-xs font-normal text-slate-500">Upload a utility bill or bank statement showing your current address.</p>
                                                    <input id="kycProofAddress" type="file" accept="image/*,.pdf"
                                                        class="h-11 rounded-xl border border-slate-200 px-4 text-sm font-normal text-slate-900 shadow-sm file:mr-3 file:rounded-lg file:border-0 file:bg-[var(--olive)] file:px-4 file:py-2 file:text-sm file:font-semibold file:text-white focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/20" />
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div
                                        class="flex flex-col gap-4 border-t border-slate-100 pt-6 sm:flex-row sm:items-center sm:justify-between">
                                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                            <button type="button" data-step-delta="-1"
                                                class="inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2.5 text-sm font-semibold text-slate-600 transition hover:bg-slate-100">Back</button>
                                            <button type="button" data-step-delta="1" data-save-profile
                                                class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Save
                                                &amp; continue</button>
                                        </div>
                                    </div>
                                </form>

                                <form data-panel="7" class="tab-panel hidden space-y-10" novalidate>
                                    <div class="space-y-6">
                                        <div data-plan-group class="flex flex-col gap-6">
                                            <label
                                                class="relative flex cursor-pointer flex-col gap-6 overflow-hidden rounded-3xl border border-slate-200 bg-gradient-to-br from-slate-900/5 via-white to-[var(--olive)]/5 p-6 text-left shadow-md transition hover:-translate-y-1.5 hover:border-[var(--olive)] hover:shadow-2xl">
                                                <input type="radio" name="plan" value="core"
                                                    class="peer absolute inset-0 h-full w-full cursor-pointer opacity-0" />
                                                <div class="absolute right-4 top-4 flex h-9 w-9 items-center justify-center rounded-full bg-[var(--olive)]/10 text-[var(--olive)] ring-1 ring-[var(--olive)]/20 transition peer-checked:bg-[var(--olive)] peer-checked:text-white peer-checked:ring-[var(--olive)]/60">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                        stroke="currentColor" stroke-width="2.2" stroke-linecap="round"
                                                        stroke-linejoin="round" class="h-4 w-4">
                                                        <path d="M5 13l4 4L19 7" />
                                                    </svg>
                                                </div>
                                                <div class="space-y-2">
                                                    <div class="inline-flex items-center gap-2 rounded-full bg-[var(--olive)]/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.28em] text-[var(--olive)] ring-1 ring-[var(--olive)]/15">
                                                        Core
                                                        <span class="rounded-full bg-white px-2 py-0.5 text-[11px] font-semibold text-[var(--olive-700)] shadow-sm">First month free</span>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <p class="text-3xl font-semibold text-slate-900">
                                                            <span class="mr-2 text-2xl font-semibold text-slate-400 line-through">R450/mo</span>
                                                            <span class="text-4xl font-bold text-[var(--olive)]">R0</span>
                                                        </p>
                                                        <p class="text-xs font-semibold uppercase tracking-[0.22em] text-slate-500">Free for your first month, then R450/mo.</p>
                                                    </div>
                                                    <p class="text-sm text-slate-600">Kick off with our core investing tools and up to six strategies.</p>
                                                </div>
                                                <ul class="space-y-3 text-sm text-slate-700">
                                                    <li class="flex items-start gap-3">
                                                        <span
                                                            class="mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-[var(--olive)]/10 text-[var(--olive)]">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                                stroke-linejoin="round" class="h-3.5 w-3.5">
                                                                <path d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </span>
                                                        <div>
                                                            <p class="font-semibold text-slate-900">Funds (CIS)</p>
                                                            <p class="text-xs text-slate-500">Access diversified collective investment schemes.</p>
                                                        </div>
                                                    </li>
                                                    <li class="flex items-start gap-3">
                                                        <span
                                                            class="mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-[var(--olive)]/10 text-[var(--olive)]">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                                stroke-linejoin="round" class="h-3.5 w-3.5">
                                                                <path d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </span>
                                                        <div>
                                                            <p class="font-semibold text-slate-900">Unsecured lending</p>
                                                            <p class="text-xs text-slate-500">Tap flexible lending alongside your investments.</p>
                                                        </div>
                                                    </li>
                                                    <li class="flex items-start gap-3">
                                                        <span
                                                            class="mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-[var(--olive)]/10 text-[var(--olive)]">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                                stroke-linejoin="round" class="h-3.5 w-3.5">
                                                                <path d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </span>
                                                        <div>
                                                            <p class="font-semibold text-slate-900">AlgoPay</p>
                                                            <p class="text-xs text-slate-500">Credit facilitation, rewards, and seamless payments.</p>
                                                        </div>
                                                    </li>
                                                    <li class="flex items-start gap-3">
                                                        <span
                                                            class="mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-[var(--olive)]/10 text-[var(--olive)]">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                                stroke-linejoin="round" class="h-3.5 w-3.5">
                                                                <path d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </span>
                                                        <div>
                                                            <p class="font-semibold text-slate-900">Up to 6 strategies</p>
                                                            <p class="text-xs text-slate-500">Build and automate multiple portfolios from day one.</p>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </label>

                                            <label
                                                class="relative flex cursor-pointer flex-col gap-6 overflow-hidden rounded-3xl border border-slate-200 bg-gradient-to-br from-slate-900/5 via-white to-[var(--olive)]/5 p-6 text-left shadow-md transition hover:-translate-y-1.5 hover:border-[var(--olive)] hover:shadow-2xl">
                                                <input type="radio" name="plan" value="professional"
                                                    class="peer absolute inset-0 h-full w-full cursor-pointer opacity-0" />
                                                <div class="absolute right-4 top-4 flex h-9 w-9 items-center justify-center rounded-full bg-[var(--olive)]/10 text-[var(--olive)] ring-1 ring-[var(--olive)]/20 transition peer-checked:bg-[var(--olive)] peer-checked:text-white peer-checked:ring-[var(--olive)]/60">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                        stroke="currentColor" stroke-width="2.2" stroke-linecap="round"
                                                        stroke-linejoin="round" class="h-4 w-4">
                                                        <path d="M5 13l4 4L19 7" />
                                                    </svg>
                                                </div>
                                                <div class="space-y-2">
                                                    <div class="inline-flex items-center gap-2 rounded-full bg-[var(--olive)]/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.28em] text-[var(--olive)] ring-1 ring-[var(--olive)]/15">
                                                        Professional
                                                        <span class="rounded-full bg-white px-2 py-0.5 text-[11px] font-semibold text-[var(--olive-700)] shadow-sm">Best for scale</span>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <p class="text-3xl font-semibold text-slate-900">
                                                            <span class="mr-2 text-2xl font-semibold text-slate-400 line-through">R899/mo</span>
                                                            <span class="text-4xl font-bold text-[var(--olive)]">R0</span>
                                                        </p>
                                                        <p class="text-xs font-semibold uppercase tracking-[0.22em] text-slate-500">Free for your first month, then R899/mo.</p>
                                                    </div>
                                                    <p class="text-sm text-slate-600">Unlock higher strategy limits and managed V.A.S.T support.</p>
                                                </div>
                                                <ul class="space-y-3 text-sm text-slate-700">
                                                    <li class="flex items-start gap-3">
                                                        <span
                                                            class="mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-[var(--olive)]/10 text-[var(--olive)]">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                                stroke-linejoin="round" class="h-3.5 w-3.5">
                                                                <path d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </span>
                                                        <div>
                                                            <p class="font-semibold text-slate-900">Open strategies up to 10</p>
                                                            <p class="text-xs text-slate-500">Scale your automated investing with more concurrent plays.</p>
                                                        </div>
                                                    </li>
                                                    <li class="flex items-start gap-3">
                                                        <span
                                                            class="mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-[var(--olive)]/10 text-[var(--olive)]">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                                stroke-linejoin="round" class="h-3.5 w-3.5">
                                                                <path d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </span>
                                                        <div>
                                                            <p class="font-semibold text-slate-900">Managed V.A.S.T *</p>
                                                            <p class="text-xs text-slate-500">Hands-on guidance with professionally managed strategies.</p>
                                                        </div>
                                                    </li>
                                                    <li class="flex items-start gap-3">
                                                        <span
                                                            class="mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-[var(--olive)]/10 text-[var(--olive)]">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                                stroke-linejoin="round" class="h-3.5 w-3.5">
                                                                <path d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </span>
                                                        <div>
                                                            <p class="font-semibold text-slate-900">Self-managed V.A.S.T</p>
                                                            <p class="text-xs text-slate-500">Run your own algorithmic strategies with dedicated tools.</p>
                                                        </div>
                                                    </li>
                                                    <li class="flex items-start gap-3">
                                                        <span
                                                            class="mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-[var(--olive)]/10 text-[var(--olive)]">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                                stroke-linejoin="round" class="h-3.5 w-3.5">
                                                                <path d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </span>
                                                        <div>
                                                            <p class="font-semibold text-slate-900">Funds (CIS)</p>
                                                            <p class="text-xs text-slate-500">Broader access to collective investment schemes.</p>
                                                        </div>
                                                    </li>
                                                    <li class="flex items-start gap-3">
                                                        <span
                                                            class="mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-[var(--olive)]/10 text-[var(--olive)]">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                                stroke-linejoin="round" class="h-3.5 w-3.5">
                                                                <path d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </span>
                                                        <div>
                                                            <p class="font-semibold text-slate-900">Investment-backed &amp; unsecured lending</p>
                                                            <p class="text-xs text-slate-500">Pair borrowing options with your growing portfolio.</p>
                                                        </div>
                                                    </li>
                                                    <li class="flex items-start gap-3">
                                                        <span
                                                            class="mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-[var(--olive)]/10 text-[var(--olive)]">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                                stroke-linejoin="round" class="h-3.5 w-3.5">
                                                                <path d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </span>
                                                        <div>
                                                            <p class="font-semibold text-slate-900">AlgoPay perks</p>
                                                            <p class="text-xs text-slate-500">Credit facilitation, rewards, and payments at the pro tier.</p>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </label>
                                        </div>

                                        <div class="text-center">
                                            <button type="button" data-plan-skip
                                                class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400 transition hover:text-slate-600">Skip
                                                for now</button>
                                        </div>
                                    </div>

                                    <div
                                        class="flex flex-col gap-4 border-t border-slate-100 pt-6 sm:flex-row sm:items-center sm:justify-between">
                                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                            <button type="button" data-step-delta="-1"
                                                class="inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2.5 text-sm font-semibold text-slate-600 transition hover:bg-slate-100">Back</button>
                                            <button type="button" data-complete data-save-profile
                                                class="btn-shine inline-flex items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Complete
                                                onboarding</button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div id="onboardingComplete"
                                class="hidden space-y-6 rounded-3xl border border-white/40 bg-white/90 p-6 text-left shadow-[0_20px_50px_-28px_rgba(15,23,42,0.55)] backdrop-blur sm:p-8">
                                <div id="checkoutLoader"
                                    class="flex items-center gap-4 rounded-3xl border border-slate-200 bg-white px-6 py-5 shadow-sm">
                                    <span
                                        class="h-10 w-10 animate-spin rounded-full border-2 border-[var(--olive)] border-t-transparent"></span>
                                    <p class="text-sm font-semibold text-slate-800">Finalising your setup…</p>
                                </div>

                                <div id="explorePanel" class="hidden space-y-4">
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-[var(--olive)]">
                                        Explore AlgoHive</p>
                                    <h3 id="completionTitle" class="text-xl font-semibold text-slate-900">Welcome to AlgoHive</h3>
                                    <p id="completionSubtitle" class="text-sm text-slate-500">You're officially part of the hive! Explore
                                        tailored investing opportunities and smart lending tools crafted to help you
                                        reach your goals.</p>
                                    <p class="text-sm text-slate-500">Pick your next step below to dive into AlgoHive.</p>
                                    <div class="grid gap-4">
                                        <a href="/home.html" class="product-card product-card--invest">
                                            <p class="product-card__eyebrow">Welcome</p>
                                            <p class="product-card__title">Start investing</p>
                                            <span class="product-card__cta">Explore strategies
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                                                    <path stroke="currentColor" stroke-linecap="round"
                                                        stroke-linejoin="round" stroke-width="1.6" d="M8 5l4 5-4 5" />
                                                </svg>
                                            </span>
                                        </a>
                                    </div>
                                </div>

                                <div id="checkoutPanel"
                                    class="hidden rounded-3xl border border-slate-200 bg-white p-6 shadow-lg sm:p-8">
                                    <div class="mb-6 flex items-center justify-between">
                                        <div>
                                            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
                                                Subscribe</p>
                                            <h3 id="checkoutTitle" class="mt-1 text-xl font-semibold text-slate-900">
                                                Review your plan</h3>
                                        </div>
                                        <span id="checkoutBadge"
                                            class="rounded-full bg-[var(--olive)]/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-[var(--olive-700)]">Plan</span>
                                    </div>
                                    <div id="checkoutReview"
                                        class="grid gap-6 lg:grid-cols-[minmax(0,1.2fr)_minmax(0,1fr)]">
                                        <form class="space-y-5">
                                            <div>
                                                <label class="text-sm font-semibold text-slate-800">Saved payment
                                                    method</label>
                                                <div
                                                    class="mt-2 flex items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-medium text-slate-600 shadow-sm">
                                                    <span
                                                        class="inline-flex h-7 w-10 items-center justify-center rounded-lg bg-white shadow-inner">VISA</span>
                                                    <span>•••• 3589</span>
                                                    <button type="button"
                                                        class="ml-auto text-xs font-semibold text-[var(--olive)] underline-offset-2 hover:underline">Change</button>
                                                </div>
                                            </div>
                                            <div>
                                                <div
                                                    class="flex items-center justify-between text-sm font-semibold text-slate-800">
                                                    <span>Credit or debit card</span>
                                                    <div class="flex items-center gap-1 text-slate-400">
                                                        <span class="h-5 w-8 rounded bg-white shadow-inner"></span>
                                                        <span class="h-5 w-8 rounded bg-white shadow-inner"></span>
                                                    </div>
                                                </div>
                                                <div class="mt-3 grid gap-3 sm:grid-cols-2">
                                                    <label
                                                        class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
                                                        Card holder
                                                        <input type="text" name="card_name" placeholder="Full name"
                                                            class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/30" />
                                                    </label>
                                                    <label
                                                        class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
                                                        Card number
                                                        <input type="text" name="card_number"
                                                            placeholder="1234 5678 9012 3456"
                                                            class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/30" />
                                                    </label>
                                                    <label
                                                        class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
                                                        Expires
                                                        <input type="text" name="card_expiry" placeholder="MM / YY"
                                                            class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/30" />
                                                    </label>
                                                    <label
                                                        class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
                                                        CVV
                                                        <input type="text" name="card_cvv" placeholder="123"
                                                            class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/30" />
                                                    </label>
                                                    <label
                                                        class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
                                                        ZIP code
                                                        <input type="text" name="card_zip" placeholder="00000"
                                                            class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 shadow-sm focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[var(--olive)]/30" />
                                                    </label>
                                                </div>
                                            </div>
                                            <button type="button"
                                                class="btn-shine inline-flex w-full items-center justify-center gap-2 rounded-full bg-[var(--olive)] px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-[var(--olive)]/30 transition hover:shadow-xl hover:shadow-[var(--olive)]/40">Subscribe
                                                now</button>
                                        </form>
                                        <aside
                                            class="space-y-5 rounded-3xl border border-slate-200 bg-slate-50 p-5 shadow-inner">
                                            <div class="space-y-1">
                                                <p class="text-sm font-semibold text-slate-800">Subscription summary</p>
                                                <p id="checkoutSubtitle" class="text-xs text-slate-500">Billed monthly
                                                </p>
                                            </div>
                                            <div
                                                class="flex items-baseline gap-2 text-3xl font-semibold text-slate-900">
                                                <span id="checkoutPrice">R0.00</span>
                                                <span class="text-sm font-medium text-slate-500">ZAR</span>
                                            </div>
                                            <ul id="checkoutPerks" class="space-y-3 text-sm text-slate-600"></ul>
                                            <div
                                                class="space-y-2 rounded-2xl border border-dashed border-slate-300 bg-white p-4 text-sm text-slate-600">
                                                <div class="flex items-center justify-between">
                                                    <span>Today</span>
                                                    <span id="checkoutDueToday"
                                                        class="font-semibold text-slate-900">R0.00</span>
                                                </div>
                                                <div class="flex items-center justify-between text-xs text-slate-500">
                                                    <span>Renews</span>
                                                    <span id="checkoutRenewal">1 × every month</span>
                                                </div>
                                                <div class="flex items-center justify-between text-xs text-slate-500">
                                                    <span>Next charge</span>
                                                    <span id="checkoutNextCharge">March 1, 2024</span>
                                                </div>
                                            </div>
                                            <p class="text-xs text-slate-400">Change or cancel your plan anytime.</p>
                                        </aside>
                                    </div>
                                    <div id="corePaymentContainer"
                                        class="mt-6 rounded-3xl border border-slate-200 bg-white p-6 text-sm text-slate-700 shadow-lg">
                                        <p class="font-semibold text-slate-900">No payment needed right now.</p>
                                        <p class="mt-2">Your first month on AlgoHive is R0 for both Core and Professional. We'll
                                            email you before any future billing begins.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </aside>
    </div>

    <script type="module" nonce="ALGOHIVE">
        import { supabase } from "/js/supabase.js";
        import { signOut } from "/js/auth.js";

        const preloader = document.getElementById("preloader");
        window.addEventListener("load", () => {
            if (!preloader) return;
            preloader.classList.add("preloader--hide");
            setTimeout(() => preloader.remove(), 450);
        });

        function banner(msg, tone = "warn") {
            const stackId = "toast-stack";
            let stack = document.getElementById(stackId);
            if (!stack) {
                stack = document.createElement("div");
                stack.id = stackId;
                stack.className = "toast-stack";
                document.body.appendChild(stack);
            }

            const toast = document.createElement("div");
            toast.className = "toast-card";
            toast.dataset.tone = tone;

            const icon = document.createElement("span");
            icon.className = "toast-icon";
            icon.setAttribute("aria-hidden", "true");
            icon.innerHTML = tone === "ok"
                ? '<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 6L8.5 14L4 9.5" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"/></svg>'
                : '<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.5 6.5L6.5 13.5" stroke="currentColor" stroke-width="1.75" stroke-linecap="round"/><path d="M6.5 6.5L13.5 13.5" stroke="currentColor" stroke-width="1.75" stroke-linecap="round"/></svg>';

            const content = document.createElement("div");
            content.className = "toast-content";
            const message = document.createElement("p");
            message.className = "toast-message";
            message.textContent = msg;
            content.appendChild(message);

            const close = document.createElement("button");
            close.type = "button";
            close.className = "toast-dismiss";
            close.setAttribute("aria-label", "Dismiss notification");
            close.innerHTML = '<svg width="14" height="14" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.75 7.25L7.25 12.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M7.25 7.25L12.75 12.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>';

            toast.append(icon, content, close);
            stack.prepend(toast);

            let isLeaving = false;
            const removeToast = () => {
                if (isLeaving) return;
                isLeaving = true;
                toast.classList.add("toast-card--leaving");
                toast.addEventListener(
                    "animationend",
                    () => {
                        toast.remove();
                        if (!stack.hasChildNodes()) {
                            stack.remove();
                        }
                    },
                    { once: true },
                );
            };

            const timeout = setTimeout(removeToast, 5000);
            close.addEventListener("click", () => {
                clearTimeout(timeout);
                removeToast();
            });
        }

        const signOutButton = document.getElementById("signOutButton");
        if (signOutButton) {
            signOutButton.addEventListener("click", async () => {
                const originalLabel = signOutButton.textContent;
                signOutButton.disabled = true;
                signOutButton.textContent = "Signing out...";
                try {
                    await signOut();
                } catch (error) {
                    console.error("Sign out failed", error);
                    banner("We couldn’t sign you out. Please try again.", "err");
                    signOutButton.disabled = false;
                    signOutButton.textContent = originalLabel;
                }
            });
        }

        const REQUIRED_FIELDS = [
            "first_name",
            "last_name",
            "phone",
            "address_line1",
            "address_city",
            "address_state",
            "address_postal_code",
            "dob",
            "id_number",
            "tax_id_type",
            "tax_id_number",
            "country_birth",
            "nationality",
            "country_residence",
            "employment_status",
            "occupation",
            "employer",
            "source_of_funds",
            "experience_level",
            "risk_tolerance",
            "annual_income_min",
            "annual_income_max",
            "liquid_net_worth_min",
            "liquid_net_worth_max",
            "total_net_worth_min",
            "total_net_worth_max",
            "objectives",
        ];
        const OBJECTIVES_FIELD_KEY = "objectives";
        const FORM_REQUIRED_FIELDS = REQUIRED_FIELDS.filter((key) => key !== OBJECTIVES_FIELD_KEY);
        const STEP_FIELD_GROUPS = {
            1: [
                "first_name",
                "last_name",
                "phone",
                "address_line1",
                "address_city",
                "address_state",
                "address_postal_code",
            ],
            2: ["dob", "id_number", "tax_id_type", "tax_id_number", "country_birth", "nationality", "country_residence"],
            3: [
                "employment_status",
                "occupation",
                "employer",
                "source_of_funds",
                "experience_level",
                "risk_tolerance",
                "annual_income_min",
                "annual_income_max",
                "liquid_net_worth_min",
                "liquid_net_worth_max",
                "total_net_worth_min",
                "total_net_worth_max",
                OBJECTIVES_FIELD_KEY,
            ],
        };

        const ISO_COUNTRY_FIELDS = ["country_birth", "nationality", "country_residence"];
        const sanitizeIsoValue = (value) => (value || "").replace(/[^a-zA-Z]/g, "").toUpperCase().slice(0, 3);
        const COUNTRY_OPTIONS = [
            { code: "AUS", name: "Australia" },
            { code: "AUT", name: "Austria" },
            { code: "BEL", name: "Belgium" },
            { code: "BGR", name: "Bulgaria" },
            { code: "BRA", name: "Brazil" },
            { code: "CAN", name: "Canada" },
            { code: "CHE", name: "Switzerland" },
            { code: "CHL", name: "Chile" },
            { code: "CHN", name: "China" },
            { code: "COL", name: "Colombia" },
            { code: "CZE", name: "Czech Republic" },
            { code: "DEU", name: "Germany" },
            { code: "DNK", name: "Denmark" },
            { code: "ESP", name: "Spain" },
            { code: "FIN", name: "Finland" },
            { code: "FRA", name: "France" },
            { code: "GBR", name: "United Kingdom" },
            { code: "GRC", name: "Greece" },
            { code: "HKG", name: "Hong Kong" },
            { code: "HUN", name: "Hungary" },
            { code: "IDN", name: "Indonesia" },
            { code: "IND", name: "India" },
            { code: "IRL", name: "Ireland" },
            { code: "ISL", name: "Iceland" },
            { code: "ISR", name: "Israel" },
            { code: "ITA", name: "Italy" },
            { code: "JPN", name: "Japan" },
            { code: "KEN", name: "Kenya" },
            { code: "KOR", name: "South Korea" },
            { code: "LUX", name: "Luxembourg" },
            { code: "MEX", name: "Mexico" },
            { code: "NGA", name: "Nigeria" },
            { code: "NLD", name: "Netherlands" },
            { code: "NOR", name: "Norway" },
            { code: "NZL", name: "New Zealand" },
            { code: "PHL", name: "Philippines" },
            { code: "POL", name: "Poland" },
            { code: "PRT", name: "Portugal" },
            { code: "QAT", name: "Qatar" },
            { code: "ROU", name: "Romania" },
            { code: "RUS", name: "Russia" },
            { code: "SAU", name: "Saudi Arabia" },
            { code: "SGP", name: "Singapore" },
            { code: "SVK", name: "Slovakia" },
            { code: "SWE", name: "Sweden" },
            { code: "THA", name: "Thailand" },
            { code: "TUR", name: "Turkey" },
            { code: "TWN", name: "Taiwan" },
            { code: "UKR", name: "Ukraine" },
            { code: "USA", name: "United States" },
            { code: "VNM", name: "Vietnam" },
            { code: "ZAF", name: "South Africa" },
        ].sort((a, b) => a.name.localeCompare(b.name));
        const currencyFormatter = new Intl.NumberFormat("en-ZA", {
            style: "currency",
            currency: "ZAR",
            maximumFractionDigits: 0,
        });
        function populateCountrySelect(select) {
            if (!select) return;
            COUNTRY_OPTIONS.forEach(({ code, name }) => {
                const option = document.createElement("option");
                option.value = code;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        ISO_COUNTRY_FIELDS.forEach((id) => {
            populateCountrySelect(document.getElementById(id));
        });
        const formatCurrencyValue = (value) => {
            const amount = Number(value);
            if (!Number.isFinite(amount)) return currencyFormatter.format(0);
            return currencyFormatter.format(Math.max(0, amount));
        };
        function syncRangeDisplayForInput(input) {
            if (!input) return;
            const outputId = input.dataset.rangeOutput;
            if (!outputId) return;
            const output = document.getElementById(outputId);
            if (!output) return;
            output.textContent = formatCurrencyValue(input.value);
        }
        function enforceRangePairBounds(input) {
            if (!input) return;
            const pairId = input.dataset.rangePair;
            if (!pairId) return;
            const pairInput = document.getElementById(pairId);
            if (!pairInput) return;
            const role = input.dataset.rangeRole || "min";
            const current = Number(input.value);
            const pairValue = Number(pairInput.value);
            if (Number.isNaN(current) || Number.isNaN(pairValue)) return;
            if (role === "min" && current > pairValue) {
                pairInput.value = current;
                syncRangeDisplayForInput(pairInput);
            } else if (role === "max" && current < pairValue) {
                pairInput.value = current;
                syncRangeDisplayForInput(pairInput);
            }
        }

        const hasValue = (value) => String(value ?? "").trim().length > 0;
        const isRowFieldSatisfied = (row, key) => {
            if (key === OBJECTIVES_FIELD_KEY) return hasValue(row?.objectives);
            return hasValue(row?.[key]);
        };

        function computeProfileComplete(row) {
            return REQUIRED_FIELDS.every((key) => isRowFieldSatisfied(row, key));
        }

        const objectivesGroup = document.getElementById("objectives-group");
        const taxIdNumberInput = document.getElementById("tax_id_number");
        const taxIdTypeSelect = document.getElementById("tax_id_type");
        const taxIdHelper = document.getElementById("taxIdHelper");
        const planGroup = document.querySelector('[data-plan-group]');
        const planRadios = Array.from(document.querySelectorAll('input[name="plan"]'));
        const planSkipButton = document.querySelector('[data-plan-skip]');
        const completeButton = document.querySelector('[data-complete][data-save-profile]');
        const corePaymentContainer = document.getElementById("corePaymentContainer");
        const corePaymentFrame = document.getElementById("corePaymentFrame");
        const corePaymentStatus = document.getElementById("corePaymentStatus");
        const corePaymentStatusDefaultClass = corePaymentStatus?.className || "";
        const corePaymentStatusDefaultText = corePaymentStatus?.textContent?.trim() || "";
        const professionalPaymentContainer = document.getElementById("professionalPaymentContainer");
        const professionalPaymentFrame = document.getElementById("professionalPaymentFrame");
        const professionalPaymentStatus = document.getElementById("professionalPaymentStatus");
        const professionalPaymentStatusDefaultClass = professionalPaymentStatus?.className || "";
        const professionalPaymentStatusDefaultText = professionalPaymentStatus?.textContent?.trim() || "";
        const kycSelfieInput = document.getElementById("kycSelfie");
        const kycIdDocumentInput = document.getElementById("kycIdDocument");
        const kycProofAddressInput = document.getElementById("kycProofAddress");
        const samsubStatusBadge = document.getElementById("samsubStatusBadge");
        const samsubStatusText = document.getElementById("samsubStatusText");
        const samsubStartButton = document.getElementById("samsubStartButton");
        const samsubCheckButton = document.getElementById("samsubCheckButton");
        const samsubLastCheckedLabel = document.getElementById("samsubLastChecked");
        const samsubLinkCard = document.getElementById("samsubLinkCard");
        const samsubCompleteButton = document.getElementById("samsubCompleteButton");
        const samsubCopyLinkButton = document.getElementById("samsubCopyLink");
        const samsubLinkMessage = document.getElementById("samsubLinkMessage");
        const samsubNextStepsList = document.getElementById("samsubNextSteps");
        const alpacaStatusBadge = document.getElementById("alpacaStatusBadge");
        const alpacaStatusText = document.getElementById("alpacaStatusText");
        const alpacaCreateButton = document.getElementById("alpacaCreateButton");
        const alpacaAccountExisting = document.getElementById("alpacaAccountExisting");
        const alpacaAccountIdValue = document.getElementById("alpacaAccountIdValue");
        const alpacaAccountSummary = document.getElementById("alpacaAccountSummary");
        const alpacaAccountSummaryBody = document.getElementById("alpacaAccountSummaryBody");
        const alpacaSummaryRefresh = document.getElementById("alpacaSummaryRefresh");
        const alpacaAgreementsList = document.getElementById("alpacaAgreementsList");
        const alpacaAgreementTemplate = document.getElementById("alpacaAgreementTemplate");
        const sumsubIframe = document.getElementById("sumsub-iframe");
        const kycContinueButton = document.querySelector('[data-panel="5"] [data-step-delta="1"][data-save-profile]');
        const samsubLinkMessageDefault = samsubLinkMessage?.textContent || "Verification links expire quickly, so complete the process in one sitting.";
        const financialRangeInputs = Array.from(document.querySelectorAll('input[type="range"][data-range-output]'));
        financialRangeInputs.forEach((input) => {
            syncRangeDisplayForInput(input);
            input.addEventListener("input", () => {
                enforceRangePairBounds(input);
                syncRangeDisplayForInput(input);
            });
        });
        const SAMSUB_WEBSDK_DEFAULT_TTL = 1400000000; // seconds
        const SAMSUB_WEBSDK_REFRESH_BUFFER_SECS = 120; // regenerate 2 minutes before expiry
        const SAMSUB_LEVEL_NAME = "test-level";
        const SAMSUB_DEFAULT_MESSAGE = "Start your SamSub identity verification to unlock AlgoHive.";
        const SAMSUB_DEFAULT_NEXT_STEPS = [
            "Complete the SamSub verification in the secure window below for the smoothest experience.",
            "Use “Complete” below to run a status check and confirm your approval.",
            "Once approved, you can continue to subscription plans.",
        ];
        let samsubApplicantId = null;
        let samsubVerificationUrl = null;
        let samsubStatusState = "idle";
        let samsubExternalUserId = null;
        let samsubLastCheckedAt = null;
        let samsubLastGeneratedAt = null;
        let samsubLinkTtlSecs = SAMSUB_WEBSDK_DEFAULT_TTL;
        let kycDone = false;
        const ALPACA_ACCOUNT_URL = "https://broker-api.sandbox.alpaca.markets/v1/accounts";
        const ALPACA_DEFAULT_AUTH_HEADER =
            "Basic Q0tITEVEMkhHTUE2TU4zNUQ2WjZRNUFPQzU6RzZyMW9WVXpOQWlkbXVyOERvZmNjRVhlaXloQWdyY2dVTmtWWDZqZEVGc1g=";
        const ALPACA_AGREEMENTS = [
            {
                key: "account_agreement",
                label: "Alpaca Account Application",
                href: "https://aazofjsssobejhkyyiqv.supabase.co/storage/v1/object/public/documents/AcctAppMarginAndCustAgmt.pdf",
                required: true,
            },
            {
                key: "customer_agreement",
                label: "Alpaca Customer Agreement",
                href: "https://aazofjsssobejhkyyiqv.supabase.co/storage/v1/object/public/documents/AcctAppMarginAndCustAgmt.pdf",
                required: true,
            },
            {
                key: "crypto_agreement",
                label: "Alpaca Crypto Customer Agreement",
                href: "https://aazofjsssobejhkyyiqv.supabase.co/storage/v1/object/public/documents/Crypto%20Customer%20Agreement.pdf",
            },
            {
                key: "options_agreement",
                label: "Alpaca Options Agreement",
                href: "https://aazofjsssobejhkyyiqv.supabase.co/storage/v1/object/public/documents/ALPACA+SECURITIES+LLC++OPTIONS+AGREEMENT.pdf",
            },
        ];
        const ALPACA_AGREEMENT_COLUMNS = {
            account_agreement: {
                flag: "alpaca_account_agreement_signed",
                signedAt: "alpaca_account_agreement_signed_at",
                ip: "alpaca_account_agreement_ip",
            },
            customer_agreement: {
                flag: "alpaca_customer_agreement_signed",
                signedAt: "alpaca_customer_agreement_signed_at",
                ip: "alpaca_customer_agreement_ip",
            },
            crypto_agreement: {
                flag: "alpaca_crypto_agreement_signed",
                signedAt: "alpaca_crypto_agreement_signed_at",
                ip: "alpaca_crypto_agreement_ip",
            },
            options_agreement: {
                flag: "alpaca_options_agreement_signed",
                signedAt: "alpaca_options_agreement_signed_at",
                ip: "alpaca_options_agreement_ip",
            },
        };
        const ALPACA_REQUIRED_AGREEMENTS = ALPACA_AGREEMENTS.filter(({ required }) => required).map(({ key }) => key);
        const ALPACA_UNPATCHABLE_IDENTITY_FIELDS = new Set([
            "country_of_tax_residence",
            "country_of_birth",
            "tax_id",
            "tax_id_type",
        ]);
        renderAlpacaAgreements();
        const CLIENT_IP_FALLBACK = "0.0.0.0";
        const ALPACA_STATUS_META = {
            idle: {
                badgeClass:
                    "inline-flex items-center justify-center rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-slate-600",
                badgeText: "Not started",
                text: "Submit your disclosures to generate a brokerage profile.",
            },
            checking: {
                badgeClass:
                    "inline-flex items-center justify-center rounded-full border border-blue-200 bg-blue-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-blue-700",
                badgeText: "Checking",
                text: "Looking for an existing brokerage account…",
            },
            submitting: {
                badgeClass:
                    "inline-flex items-center justify-center rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-amber-700",
                badgeText: "Submitting",
                text: "Submitting your brokerage application…",
            },
            success: {
                badgeClass:
                    "inline-flex items-center justify-center rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-emerald-700",
                badgeText: "Submitted",
                text: "Your brokerage application was received. Watch your inbox for the final approval.",
            },
            error: {
                badgeClass:
                    "inline-flex items-center justify-center rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-rose-700",
                badgeText: "Action needed",
                text: "We couldn’t create your brokerage account. Try again or contact AlgoHive support.",
            },
        };

        function renderAlpacaAgreements() {
            if (!alpacaAgreementsList || !alpacaAgreementTemplate) return;
            alpacaAgreementsList.innerHTML = "";

            ALPACA_AGREEMENTS.forEach(({ key, label, href, required }) => {
                const clone = alpacaAgreementTemplate.content.cloneNode(true);
                const checkbox = clone.querySelector("[data-alpaca-agreement]");
                const link = clone.querySelector("[data-agreement-link]");
                if (checkbox) {
                    checkbox.dataset.alpacaAgreement = key;
                    if (required) {
                        checkbox.required = true;
                    }
                }
                if (link) {
                    link.textContent = label;
                    link.href = href || "#";
                }
                alpacaAgreementsList.appendChild(clone);
            });
        }
        let alpacaAccountId = null;
        let alpacaAccountStatus = null;
        let alpacaAccountState = "idle";
        let alpacaAccountProfile = null;
        let alpacaAccountNumber = null;
        let alpacaAccountPatchPromise = null;
        const alpacaAuthHeader = ALPACA_DEFAULT_AUTH_HEADER;

        const normalizeEmail = (value) => (value || "").trim().toLowerCase();

        function getAlpacaAuthHeader() {
            return alpacaAuthHeader;
        }

        function getPreferredBrokerageEmail() {
            const candidates = [
                alpacaAccountProfile?.contact?.email_address,
                supabaseUser?.email,
                profileRow?.email,
                profileRow?.email_address,
            ];
            for (const candidate of candidates) {
                if (typeof candidate === "string" && candidate.trim()) return candidate.trim();
            }
            return "";
        }

        function deriveBrokerageAccountId(payload) {
            const candidates = [payload?.id, payload?.account_id, payload?.accountId];
            for (const candidate of candidates) {
                if (typeof candidate === "string" && candidate.trim()) return candidate.trim();
            }
            return null;
        }

        function deriveBrokerageAccountStatus(payload) {
            const candidates = [payload?.status, payload?.account_status, payload?.application_status];
            for (const candidate of candidates) {
                if (typeof candidate === "string" && candidate.trim()) return candidate.trim();
            }
            return null;
        }

        function extractBrokerageEmail(payload) {
            const candidates = [payload?.email, payload?.email_address, payload?.identity?.email_address, payload?.contact?.email_address];
            for (const candidate of candidates) {
                if (typeof candidate === "string" && candidate.trim()) return candidate.trim();
            }
            return null;
        }

        function selectAccountByEmail(payload, emailAddress) {
            if (!emailAddress) return null;
            const normalized = normalizeEmail(emailAddress);
            const candidates = [];
            if (Array.isArray(payload)) candidates.push(...payload);
            if (payload && typeof payload === "object") {
                if (Array.isArray(payload.accounts)) candidates.push(...payload.accounts);
                if (payload.account && typeof payload.account === "object") candidates.push(payload.account);
                candidates.push(payload);
            }
            for (const candidate of candidates) {
                const candidateEmail = normalizeEmail(extractBrokerageEmail(candidate));
                if (candidateEmail && candidateEmail === normalized) return candidate;
            }
            return null;
        }

        async function fetchExistingBrokerageAccountFromApi(emailAddress) {
            if (!emailAddress) return null;
            const searchParams = new URLSearchParams({ query: emailAddress, entities: "contact,identity" });
            const searchUrl = `${ALPACA_ACCOUNT_URL}?${searchParams.toString()}`;
            try {
                const response = await fetch(searchUrl, {
                    method: "GET",
                    headers: {
                        accept: "application/json",
                        authorization: getAlpacaAuthHeader(),
                    },
                });
                const data = await response.json().catch(() => null);
                if (!response.ok) {
                    console.warn("Brokerage lookup failed", data || response.status);
                    return null;
                }
                return selectAccountByEmail(data, emailAddress);
            } catch (error) {
                console.warn("Could not reach brokerage lookup endpoint.", error);
                return null;
            }
        }

        async function fetchBrokerageAccountProfile(accountId) {
            if (!accountId) return null;
            const url = `${ALPACA_ACCOUNT_URL}/${encodeURIComponent(accountId)}`;
            try {
                const response = await fetch(url, {
                    method: "GET",
                    headers: {
                        accept: "application/json",
                        authorization: getAlpacaAuthHeader(),
                    },
                });
                const data = await response.json().catch(() => null);
                if (!response.ok) {
                    console.warn("Brokerage summary lookup failed", data || response.status);
                    return null;
                }
                return data;
            } catch (error) {
                console.warn("Could not reach brokerage summary endpoint.", error);
                return null;
            }
        }

        async function updateAlpacaAccountIfMissing(existingProfile) {
            if (!alpacaAccountId) return null;
            if (alpacaAccountPatchPromise) return alpacaAccountPatchPromise;

            alpacaAccountPatchPromise = (async () => {
                const clientIp = await resolveClientIpAddress().catch(() => null);
                const patchPayload = await buildAlpacaAccountUpdatePayload(existingProfile, { clientIp });
                if (!patchPayload) {
                    alpacaAccountPatchPromise = null;
                    return null;
                }

                const url = `${ALPACA_ACCOUNT_URL}/${encodeURIComponent(alpacaAccountId)}`;
                try {
                    const response = await fetch(url, {
                        method: "PATCH",
                        headers: {
                            accept: "application/json",
                            "content-type": "application/json",
                            authorization: getAlpacaAuthHeader(),
                        },
                        body: JSON.stringify(patchPayload),
                    });
                    const data = await response.json().catch(() => null);
                    if (!response.ok) {
                        console.warn("Could not update existing brokerage account.", data || response.status);
                        return null;
                    }
                    alpacaAccountProfile = data || alpacaAccountProfile;
                    renderAlpacaAccountSummary();
                    return data;
                } catch (error) {
                    console.warn("Could not update brokerage account.", error);
                    return null;
                } finally {
                    alpacaAccountPatchPromise = null;
                }
            })();

            return alpacaAccountPatchPromise;
        }

        async function refreshBrokerageSummary({ silent = true } = {}) {
            if (!alpacaAccountId) return null;
            const profile = await fetchBrokerageAccountProfile(alpacaAccountId);
            if (profile) {
                alpacaAccountProfile = profile;
                alpacaAccountNumber = deriveAccountNumber(profile) || alpacaAccountNumber || null;
                renderBrokerageAccountSummary();
                await updateAlpacaAccountIfMissing(profile);
                if (!silent) banner("Refreshed account summary.", "ok");
                return profile;
            }
            if (!silent) banner("Could not refresh account summary.", "err");
            return null;
        }

        let clientIpAddress = null;
        let clientIpLookupPromise = null;

        const SAMSUB_STATUS_META = {
            idle: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-amber-700",
                label: "Not started",
                message: SAMSUB_DEFAULT_MESSAGE,
            },
            link_ready: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-[var(--olive)]/50 bg-[var(--olive)]/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-[var(--olive-700)]",
                label: "Link ready",
                message: "We've generated the secure SamSub window below. Complete your verification to continue.",
            },
            pending: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-sky-200 bg-sky-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-sky-700",
                label: "In review",
                message: "SamSub is reviewing your documents. This usually takes a few minutes.",
            },
            verified: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-emerald-700",
                label: "Verified",
                message: "Your identity is verified. You're all set!",
            },
            complete: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-emerald-700",
                label: "Verified",
                message: "Your identity is verified. You're all set!",
            },
            completed: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-emerald-700",
                label: "Verified",
                message: "Your identity is verified. You're all set!",
            },
            failed: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-rose-700",
                label: "Action required",
                message: "SamSub couldn't verify your identity. Please retry or contact support.",
            },
            error: {
                badge:
                    "inline-flex items-center justify-center rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-amber-700",
                label: "Try again",
                message: "We couldn't update your SamSub status. Try again shortly.",
            },
        };

        function syncKycContinueButton() {
            if (!kycContinueButton) return;
            const allow = !!kycDone;
            kycContinueButton.disabled = !allow;
            kycContinueButton.classList.toggle("opacity-60", !allow);
            kycContinueButton.classList.toggle("cursor-not-allowed", !allow);
            if (!allow) {
                kycContinueButton.setAttribute("aria-disabled", "true");
            } else {
                kycContinueButton.removeAttribute("aria-disabled");
            }
        }

        function getStoredKycUrl(key) {
            return profileRow?.[key] || null;
        }

        function areKycDocumentsSelected() {
            const requirements = [
                { key: "kyc_selfie_url", input: kycSelfieInput },
                { key: "kyc_id_document_url", input: kycIdDocumentInput },
                { key: "kyc_proof_of_address_url", input: kycProofAddressInput },
            ];

            return requirements.every(({ key, input }) => {
                const hasFileSelection = (input?.files?.length || 0) > 0;
                const hasStored = !!getStoredKycUrl(key);
                return hasFileSelection || hasStored;
            });
        }

        function updateKycDocumentState() {
            kycDone = areKycDocumentsSelected();
            syncKycContinueButton();
        }

        function syncSamsubStartButton() {
            if (!samsubStartButton) return;

            const status = (samsubStatusState || "").toLowerCase();
            const hasLink = !!samsubVerificationUrl;
            const baseText = "Start your verification";

            if (kycDone) {
                samsubStartButton.classList.add("hidden");
                return;
            }

            samsubStartButton.classList.remove("hidden");

            let text = baseText;
            let disabled = false;

            if (!hasLink) {
                text = baseText;
                disabled = false;
            } else if (status === "failed") {
                text = "Retry your verification";
                disabled = false;
            } else if (status === "error") {
                text = "Try again";
                disabled = false;
            } else if (status === "completed" || status === "complete" || status === "verified") {
                text = baseText;
                disabled = true;
            } else if (hasReusableSamsubLink()) {
                text = "Resume your verification";
                disabled = true;
            } else {
                text = "Verification in progress";
                disabled = true;
            }

            samsubStartButton.disabled = disabled;
            samsubStartButton.classList.toggle("opacity-60", disabled);
            samsubStartButton.classList.toggle("cursor-not-allowed", disabled);
            if (disabled) {
                samsubStartButton.setAttribute("aria-disabled", "true");
            } else {
                samsubStartButton.removeAttribute("aria-disabled");
                samsubStartButton.classList.remove("opacity-60");
                samsubStartButton.classList.remove("cursor-not-allowed");
            }

            samsubStartButton.textContent = text;
            samsubStartButton.dataset.originalText = text;
        }

        function formatDateTime(date) {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) return "";
            return new Intl.DateTimeFormat("en-US", { dateStyle: "medium", timeStyle: "short" }).format(date);
        }

        function updateSamsubLastChecked(value) {
            samsubLastCheckedAt = value instanceof Date ? value : value ? new Date(value) : null;
            if (!samsubLastCheckedLabel) return;
            if (!samsubLastCheckedAt || Number.isNaN(samsubLastCheckedAt.getTime())) {
                samsubLastCheckedLabel.classList.add("hidden");
                samsubLastCheckedLabel.textContent = "";
                return;
            }
            samsubLastCheckedLabel.textContent = `Last checked ${formatDateTime(samsubLastCheckedAt)}`;
            samsubLastCheckedLabel.classList.remove("hidden");
        }

        function renderSamsubSteps(items) {
            if (!samsubNextStepsList) return;
            const entries = Array.isArray(items) && items.length ? items : SAMSUB_DEFAULT_NEXT_STEPS;
            samsubNextStepsList.innerHTML = "";
            entries.forEach((text) => {
                const li = document.createElement("li");
                li.textContent = text;
                samsubNextStepsList.appendChild(li);
            });
        }

        async function parseJsonResponse(response, context = "request") {
            const raw = await response.text();
            if (!raw) return {};
            try {
                return JSON.parse(raw);
            } catch (error) {
                const statusText = `${response.status || ""} ${response.statusText || ""}`.trim() || "unknown status";
                console.error(`Failed to parse ${context} response.`, { error, raw, status: response.status });
                throw new Error(`The server returned an unreadable response (${statusText}). Please try again later.`);
            }
        }

        function hasReusableSamsubLink() {
            if (!samsubVerificationUrl || !samsubApplicantId) return false;
            if (!(samsubLastGeneratedAt instanceof Date) || Number.isNaN(samsubLastGeneratedAt.getTime())) return false;
            const ttlSecs =
                typeof samsubLinkTtlSecs === "number" && !Number.isNaN(samsubLinkTtlSecs) && samsubLinkTtlSecs > 0
                    ? samsubLinkTtlSecs
                    : SAMSUB_WEBSDK_DEFAULT_TTL;
            const expiresAt = samsubLastGeneratedAt.getTime() + ttlSecs * 1000;
            const refreshThreshold = expiresAt - SAMSUB_WEBSDK_REFRESH_BUFFER_SECS * 1000;
            return Date.now() < refreshThreshold;
        }

        function setSamsubStatus(status, options = {}) {
            samsubStatusState = status;
            const meta = SAMSUB_STATUS_META[status] || SAMSUB_STATUS_META.idle;
            if (samsubStatusBadge) {
                samsubStatusBadge.textContent = meta.label;
                samsubStatusBadge.className = meta.badge;
            }
            if (samsubStatusText) {
                samsubStatusText.textContent = options.message || meta.message || SAMSUB_DEFAULT_MESSAGE;
            }
            if (samsubCheckButton) {
                const show = !!options.showCheck;
                samsubCheckButton.classList.toggle("hidden", !show);
                samsubCheckButton.disabled = false;
                samsubCheckButton.removeAttribute("aria-disabled");
            }
            if (options.lastChecked) {
                updateSamsubLastChecked(options.lastChecked instanceof Date ? options.lastChecked : new Date(options.lastChecked));
            } else if (!options.preserveLastChecked && (status === "idle" || status === "link_ready")) {
                updateSamsubLastChecked(null);
            }
            syncSamsubStartButton();
            syncKycContinueButton();
        }

        function applySamsubLink(url, options = {}) {
            samsubVerificationUrl = url || null;
            if (!samsubLinkCard) return;
            if (url) {
                samsubLinkCard.classList.remove("hidden");
                if (samsubCompleteButton) {
                    samsubCompleteButton.disabled = false;
                    samsubCompleteButton.removeAttribute("aria-disabled");
                }
                if (sumsubIframe) {
                    sumsubIframe.classList.remove("hidden");
                    sumsubIframe.src = url;
                }
                if (samsubLinkMessage) {
                    samsubLinkMessage.textContent = options.message || samsubLinkMessageDefault;
                }
            } else {
                samsubLinkCard.classList.add("hidden");
                if (samsubCompleteButton) {
                    samsubCompleteButton.disabled = true;
                    samsubCompleteButton.setAttribute("aria-disabled", "true");
                }
                if (sumsubIframe) {
                    sumsubIframe.classList.add("hidden");
                    sumsubIframe.removeAttribute("src");
                }
                if (samsubLinkMessage) samsubLinkMessage.textContent = samsubLinkMessageDefault;
            }
            syncSamsubStartButton();
        }

        syncKycContinueButton();
        syncSamsubStartButton();

        function shouldRequireTaxIdNumber() {
            return true;
        }

        function syncTaxIdInputState() {
            if (!taxIdNumberInput) return;
            taxIdNumberInput.disabled = false;
            taxIdNumberInput.classList.remove("input-error");
            if (taxIdHelper) {
                taxIdHelper.textContent = "Enter the identifier exactly as it appears on your documentation.";
            }
        }

        if (taxIdTypeSelect) {
            taxIdTypeSelect.addEventListener("change", () => {
                syncTaxIdInputState();
            });
        }

        syncTaxIdInputState();

        function setPlanGroupError(active) {
            if (!planGroup) return;
            planGroup.classList.toggle("plan-group--error", !!active);
        }

        function clearFieldErrors() {
            FORM_REQUIRED_FIELDS.forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.classList.remove("input-error");
            });
            objectivesGroup?.classList.remove("field-error");
            setPlanGroupError(false);
        }

        function syncObjectivesHighlight() {
            const checked = document.querySelectorAll('input[name="objectives"]:checked').length > 0;
            if (objectivesGroup) objectivesGroup.classList.toggle("field-error", !checked);
            return checked;
        }

        FORM_REQUIRED_FIELDS.forEach((id) => {
            const el = document.getElementById(id);
            if (!el) return;
            const handle = () => {
                if (hasValue(el.value)) el.classList.remove("input-error");
            };
            el.addEventListener("input", handle);
            el.addEventListener("change", handle);
        });

        document.querySelectorAll('input[name="objectives"]').forEach((cb) => {
            cb.addEventListener("change", () => {
                syncObjectivesHighlight();
            });
        });

        planRadios.forEach((radio) => {
            radio.addEventListener("change", () => {
                selectedPlanKey = radio.value;
                planSkipped = false;
                const selectingPaystack = paystackPlanKeys.includes(radio.value);
                activePaystackPlan = selectingPaystack ? radio.value : null;

                paystackPlanKeys.forEach((planKey) => {
                    const context = paymentContexts[planKey];
                    if (!context) return;
                    const isTarget = radio.value === planKey;
                    const { container, statusEl } = context;

                    if (container) {
                        container.classList.toggle("hidden", !isTarget);
                        if (isTarget) {
                            container.classList.add("swap-anim");
                        } else {
                            container.classList.remove("swap-anim");
                        }
                    }

                    if (statusEl) {
                        if (isTarget) {
                            const alreadyOnPlan = paymentCompletion[planKey] || profileRow?.plan === planKey;
                            if (alreadyOnPlan) {
                                paymentCompletion[planKey] = true;
                                statusEl.className = "mt-3 text-xs font-semibold text-[var(--olive)]";
                                statusEl.textContent = `Payment confirmed — your profile is already on the ${planLabels[planKey]} plan.`;
                            } else {
                                resetPaymentStatus(planKey);
                            }
                        } else {
                            resetPaymentStatus(planKey);
                        }
                    }
                });

                if (checkoutPanel) {
                    checkoutPanel.classList.toggle("hidden", selectingPaystack);
                    checkoutPanel.classList.toggle("swap-anim", !selectingPaystack);
                    if (selectingPaystack) checkoutPanel.classList.remove("swap-anim");
                }
                if (checkoutReview) {
                    checkoutReview.classList.toggle("hidden", selectingPaystack);
                }
                setPlanGroupError(false);
                if (explorePanel && !explorePanel.classList.contains("hidden")) {
                    explorePanel.classList.add("hidden");
                }
            });
        });

        planSkipButton?.addEventListener("click", () => {
            planSkipped = true;
            selectedPlanKey = null;
            activePaystackPlan = null;
            planRadios.forEach((radio) => {
                radio.checked = false;
            });
            paystackPlanKeys.forEach((planKey) => {
                const context = paymentContexts[planKey];
                if (!context) return;
                context.container?.classList.add("hidden");
                context.container?.classList.remove("swap-anim");
                resetPaymentStatus(planKey);
            });
            activePaystackPlan = null;
            if (checkoutReview) checkoutReview.classList.remove("hidden");
            setPlanGroupError(false);
            if (checkoutPanel) {
                checkoutPanel.classList.add("hidden");
            }
            if (explorePanel) {
                explorePanel.classList.add("hidden");
            }
            window.requestAnimationFrame(() => {
                completeButton?.click();
            });
        });

        const stepMeta = {
            1: { label: "Step 1 of 7 · Basic info", title: "Tell us about yourself" },
            2: { label: "Step 2 of 7 · Identity & tax", title: "Confirm your identity details" },
            3: { label: "Step 3 of 7 · Employment & income", title: "Share your work and income profile" },
            4: { label: "Step 4 of 7 · Compliance", title: "Confirm your declarations" },
            5: { label: "Step 5 of 7 · KYC", title: "Verify your identity" },
            6: { label: "Step 6 of 7 · Brokerage", title: "Review brokerage requirements" },
            7: { label: "Step 7 of 7 · Subscription plans", title: "Choose your AlgoHive access" },
        };

        const panels = Array.from(document.querySelectorAll("[data-panel]"));
        const panelForms = panels.filter((panel) => panel instanceof HTMLFormElement);
        const onboardingFlow = document.getElementById("onboardingFlow");
        const onboardingComplete = document.getElementById("onboardingComplete");
        const checkoutLoader = document.getElementById("checkoutLoader");
        const checkoutPanel = document.getElementById("checkoutPanel");
        const checkoutReview = document.getElementById("checkoutReview");
        const explorePanel = document.getElementById("explorePanel");
        const checkoutBadge = document.getElementById("checkoutBadge");
        const checkoutTitle = document.getElementById("checkoutTitle");
        const checkoutSubtitle = document.getElementById("checkoutSubtitle");
        const checkoutPrice = document.getElementById("checkoutPrice");
        const checkoutPerksList = document.getElementById("checkoutPerks");
        const checkoutDueToday = document.getElementById("checkoutDueToday");
        const checkoutRenewal = document.getElementById("checkoutRenewal");
        const checkoutNextCharge = document.getElementById("checkoutNextCharge");
        const stepLabel = document.getElementById("currentStepLabel");
        const stepTitle = document.getElementById("currentStepTitle");
        const onboardingIntro = document.getElementById("onboardingIntro");
        const stepSummary = document.getElementById("stepSummary");
        const stepItems = Array.from(document.querySelectorAll("[data-step-item]"));
        const completedSteps = new Set();
        const errorSteps = new Set();
        let currentStep = 1;
        const totalSteps = panels.length;
        let brokeragePrimePromise = null;
        let supabaseUser = null;
        let supabaseSession = null;
        let profileRow = null;
        let profileComplete = false;
        let selectedPlanKey = planRadios.find((radio) => radio.checked)?.value || null;
        let planSkipped = false;
        const PLAN_TRIAL_MONTHS = 1;
        let checkoutRevealStarted = false;
        let checkoutRevealTimer = null;
        const paystackPlanKeys = [];
        let hasCelebrated = false;
        const planLabels = { core: "Core", professional: "Professional", free: "Free" };

        async function fetchExistingPlan(userId) {
            try {
                const { data, error } = await supabase
                    .from("plans")
                    .select("plan")
                    .eq("user_id", userId)
                    .order("created_at", { ascending: false })
                    .limit(1);

                if (error) throw error;
                return Array.isArray(data) && data[0]?.plan ? data[0].plan : null;
            } catch (error) {
                console.error("Error checking existing plan", error);
                return null;
            }
        }

        const resolvePlanSelection = () => {
            if (planSkipped) return "free";
            return selectedPlanKey || null;
        };

        const buildPlanDates = (isSkipped) => {
            const start = new Date();
            const trialEnd = isSkipped ? null : new Date(start);
            if (trialEnd) {
                trialEnd.setMonth(trialEnd.getMonth() + PLAN_TRIAL_MONTHS);
            }
            return { startDate: start.toISOString(), trialEndDate: trialEnd ? trialEnd.toISOString() : null };
        };
        const paymentCompletion = { core: false, professional: false };
        let activePaystackPlan = null;
        const paymentContexts = {
            core: {
                container: corePaymentContainer,
                frame: corePaymentFrame,
                statusEl: corePaymentStatus,
                defaultClass: corePaymentStatusDefaultClass,
                defaultText: corePaymentStatusDefaultText,
            },
            professional: {
                container: professionalPaymentContainer,
                frame: professionalPaymentFrame,
                statusEl: professionalPaymentStatus,
                defaultClass: professionalPaymentStatusDefaultClass,
                defaultText: professionalPaymentStatusDefaultText,
            },
        };

        async function savePlanSelection(planKey) {
            if (!supabaseUser) throw new Error("Please sign in again.");
            const { startDate, trialEndDate } = buildPlanDates(planKey === "free" || planSkipped);

            const { error: planError } = await supabase
                .from("plans")
                .upsert(
                    { user_id: supabaseUser.id, plan: planKey, start_date: startDate, trial_end_date: trialEndDate },
                    { onConflict: "user_id" },
                );
            if (planError) throw planError;

            const { error: profileErr } = await supabase
                .from("profiles")
                .upsert({ id: supabaseUser.id, plan: planKey, updated_at: new Date().toISOString() }, { onConflict: "id" });

            if (profileErr) throw profileErr;

            profileRow = { ...profileRow, plan: planKey };
        }

        async function persistPlanSelectionIfNeeded() {
            const planKey = resolvePlanSelection() || "free";
            try {
                await savePlanSelection(planKey);
                return true;
            } catch (error) {
                console.error(error);
                banner(error.message || "Could not save your plan.", "err");
                return false;
            }
        }

        async function triggerConfetti() {
            try {
                const module = await import("https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js");
                const confetti = module?.default || module;
                if (typeof confetti === "function") {
                    confetti({
                        particleCount: 200,
                        spread: 80,
                        startVelocity: 45,
                        origin: { y: 0.6 },
                        zIndex: 2147483647,
                    });
                    window.setTimeout(() => {
                        confetti({
                            particleCount: 160,
                            spread: 70,
                            origin: { y: 0.3 },
                            zIndex: 2147483647,
                        });
                    }, 180);
                }
            } catch (error) {
                console.warn("Confetti failed", error);
            }
        }

        async function celebrateCompletion() {
            const firstName = (document.getElementById("first_name")?.value || "there").trim() || "there";
            const title = document.getElementById("completionTitle");
            const subtitle = document.getElementById("completionSubtitle");
            if (title) title.textContent = `Welcome to AlgoHive, ${firstName}!`;
            if (subtitle) subtitle.textContent = "You're all set. Explore strategies and start investing.";
            if (!hasCelebrated) {
                await triggerConfetti();
                banner(`Welcome to AlgoHive, ${firstName}! Start investing.`, "ok");
            }
            if (onboardingComplete) {
                onboardingComplete.classList.remove("hidden");
                onboardingComplete.scrollIntoView({ behavior: "smooth", block: "start" });
            }
            hasCelebrated = true;
        }

        const revealExplorePanel = (options = {}) => {
            const { scroll = false } = options;
            if (checkoutRevealTimer) {
                window.clearTimeout(checkoutRevealTimer);
                checkoutRevealTimer = null;
            }
            if (checkoutLoader) checkoutLoader.classList.add("hidden");
            if (checkoutPanel) {
                checkoutPanel.classList.add("hidden");
                checkoutPanel.classList.remove("swap-anim");
            }
            if (checkoutReview) checkoutReview.classList.remove("hidden");
            paystackPlanKeys.forEach((planKey) => {
                const context = paymentContexts[planKey];
                if (!context) return;
                context.container?.classList.add("hidden");
                context.container?.classList.remove("swap-anim");
                resetPaymentStatus(planKey);
            });
            activePaystackPlan = null;
            if (explorePanel) {
                explorePanel.classList.remove("hidden");
                explorePanel.classList.add("swap-anim");
                if (scroll) {
                    explorePanel.scrollIntoView({ behavior: "smooth", block: "start" });
                }
            }
        };

        const resolvePlanFromSource = (source) => {
            if (!source) return null;
            return paystackPlanKeys.find((planKey) => paymentContexts[planKey]?.frame?.contentWindow === source) || null;
        };

        const resetPaymentStatus = (planKey) => {
            const context = paymentContexts[planKey];
            if (!context?.statusEl) return;
            context.statusEl.className = context.defaultClass;
            context.statusEl.textContent = context.defaultText;
        };

        const setPaymentStatus = (planKey, className, text) => {
            const context = paymentContexts[planKey];
            if (!context?.statusEl) return;
            context.statusEl.className = className;
            context.statusEl.textContent = text;
        };

        const markPaymentFailure = (planKey) => {
            paymentCompletion[planKey] = false;
            setPaymentStatus(planKey, "mt-3 text-xs text-red-500", "Payment wasn't completed. Please try again above.");
            banner("Payment wasn't completed. Please try again.", "err");
        };

        const markPaymentUpdating = (planKey) => {
            setPaymentStatus(planKey, "mt-3 text-xs font-semibold text-[var(--olive)]", "Payment confirmed. Updating your profile…");
        };

        const markPaymentAdvance = (planKey, message) => {
            setPaymentStatus(planKey, "mt-3 text-xs font-semibold text-[var(--olive)]", message);
        };

        const planSuccessMessage = (planKey, { includeNext = false } = {}) => {
            const label = planLabels[planKey] || planKey;
            return includeNext
                ? `Payment confirmed — your profile is now on the ${label} plan. Taking you to what's next…`
                : `Payment confirmed — your profile is now on the ${label} plan.`;
        };

        const planErrorMessage = () => "We received a success signal but could not update your plan. Please try again or contact support.";

        const successBannerMessage = (planKey) => {
            const label = planLabels[planKey] || planKey;
            return `${label} plan activated successfully.`;
        };

        const handleSuccessfulPayment = async (planKey) => {
            paymentCompletion[planKey] = true;
            paystackPlanKeys.forEach((key) => {
                if (key !== planKey) paymentCompletion[key] = false;
            });
            markPaymentUpdating(planKey);

            try {
                await updateProfilePlan(planKey);
                paystackPlanKeys.forEach((key) => {
                    paymentCompletion[key] = profileRow?.plan === key;
                });
                markPaymentAdvance(planKey, planSuccessMessage(planKey, { includeNext: true }));
                banner(successBannerMessage(planKey), "ok");
                await celebrateCompletion();
                window.setTimeout(() => {
                    revealExplorePanel({ scroll: true });
                }, 1200);
            } catch (error) {
                console.error(error);
                paymentCompletion[planKey] = false;
                setPaymentStatus(planKey, "mt-3 text-xs text-red-500", error.message || planErrorMessage());
                banner(error.message || "Could not update plan after payment.", "err");
            }
        };

        const formatNextCharge = (monthOffset = 1) => {
            const base = new Date();
            base.setDate(1);
            base.setHours(0, 0, 0, 0);
            base.setMonth(base.getMonth() + Math.max(1, Number(monthOffset) || 1));
            return new Intl.DateTimeFormat("en-US", { month: "long", day: "numeric", year: "numeric" }).format(base);
        };

        const PAYSTACK_ORIGINS = [/^https:\/\/([a-z0-9-]+\.)*paystack\.shop$/i, /^https:\/\/([a-z0-9-]+\.)*paystack\.com$/i];
        const isPaystackOrigin = (origin) => typeof origin === "string" && PAYSTACK_ORIGINS.some((regex) => regex.test(origin));

        const coerceMessagePayload = (payload) => {
            if (typeof payload === "string") {
                const trimmed = payload.trim();
                if (!trimmed) return trimmed;
                try {
                    return JSON.parse(trimmed);
                } catch (error) {
                    return trimmed;
                }
            }
            return payload;
        };

        const containsAnyToken = (value, tokens) => {
            if (value == null) return false;
            const lower = String(value).toLowerCase();
            return tokens.some((token) => lower.includes(token));
        };

        const isSuccessfulPaymentPayload = (payload) => {
            if (!payload) return false;
            const successTokens = ["success", "completed", "paid", "approved"];
            if (typeof payload === "string") {
                return containsAnyToken(payload, successTokens);
            }
            if (typeof payload === "object") {
                return [
                    payload.event,
                    payload.type,
                    payload.action,
                    payload.status,
                    payload.state,
                    payload.message,
                    payload.reason,
                    payload.data?.status,
                    payload.data?.message,
                ].some((value) => containsAnyToken(value, successTokens));
            }
            return false;
        };

        const isFailedPaymentPayload = (payload) => {
            if (!payload) return false;
            const failureTokens = [
                "fail",
                "error",
                "declin",
                "cancel",
                "close",
                "abort",
                "reject",
                "timeout",
                "expired",
            ];
            if (typeof payload === "string") {
                return containsAnyToken(payload, failureTokens);
            }
            if (typeof payload === "object") {
                return [
                    payload.event,
                    payload.type,
                    payload.action,
                    payload.status,
                    payload.state,
                    payload.message,
                    payload.reason,
                    payload.data?.status,
                    payload.data?.message,
                ].some((value) => containsAnyToken(value, failureTokens));
            }
            return false;
        };

        const planDetails = {
            core: {
                badge: "Core plan",
                title: "AlgoHive Core subscription",
                subtitle: "R450 billed monthly",
                price: "R450.00",
                dueToday: "R450.00",
                renewal: "1 × every month",
                nextChargeOffset: 1,
                perks: [
                    "Funds * (CIS)",
                    "Unsecured Lending",
                    "AlgoPay — credit facilitation, rewards & payments",
                    "Up to 6 strategies",
                ],
            },
            professional: {
                badge: "Professional plan",
                title: "AlgoHive Professional subscription",
                subtitle: "R899 billed monthly",
                price: "R899.00",
                dueToday: "R899.00",
                renewal: "1 × every month",
                nextChargeOffset: 1,
                perks: [
                    "Open Strategies * up to 10",
                    "Managed V.A.S.T *",
                    "Self-Managed V.A.S.T",
                    "Funds * (CIS)",
                    "Investment Backed Lending & unsecured",
                    "AlgoPay — credit facilitation, rewards & payments",
                ],
            },
        };

        const updateCheckout = (planKey, options = {}) => {
            const { scroll = true } = options;
            const detail = planDetails[planKey];
            if (!detail) return;

            const showPaystackFrame = paystackPlanKeys.includes(planKey);
            const showCoreFrame = planKey === "core";
            const showProfessionalFrame = planKey === "professional";
            activePaystackPlan = showPaystackFrame ? planKey : null;

            if (checkoutBadge) checkoutBadge.textContent = detail.badge;
            if (checkoutTitle) checkoutTitle.textContent = detail.title;
            if (checkoutSubtitle) checkoutSubtitle.textContent = detail.subtitle;
            if (checkoutPrice) checkoutPrice.textContent = detail.price;
            if (checkoutPerksList) {
                checkoutPerksList.innerHTML = "";
                if (Array.isArray(detail.perks)) {
                    detail.perks.forEach((perk) => {
                        const li = document.createElement("li");
                        li.className = "flex items-start gap-2";
                        li.innerHTML =
                            '<svg class="mt-0.5 h-4 w-4 flex-shrink-0 text-[var(--olive)]" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 6L8.5 14L4 9.5" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"/></svg>' +
                            `<span>${perk}</span>`;
                        checkoutPerksList.appendChild(li);
                    });
                }
            }
            if (checkoutDueToday) checkoutDueToday.textContent = detail.dueToday;
            if (checkoutRenewal) checkoutRenewal.textContent = detail.renewal;
            if (checkoutNextCharge) checkoutNextCharge.textContent = formatNextCharge(detail.nextChargeOffset);

            paystackPlanKeys.forEach((key) => {
                const context = paymentContexts[key];
                if (!context) return;
                const { container, statusEl, defaultClass, defaultText } = context;
                const isTarget = planKey === key;

                if (container) {
                    container.classList.toggle("hidden", !isTarget);
                    if (isTarget) {
                        container.classList.add("swap-anim");
                    } else {
                        container.classList.remove("swap-anim");
                    }
                }

                if (statusEl) {
                    if (isTarget) {
                        const alreadyOnPlan = paymentCompletion[key] || profileRow?.plan === key;
                        if (alreadyOnPlan) {
                            paymentCompletion[key] = true;
                            statusEl.className = "mt-3 text-xs font-semibold text-[var(--olive)]";
                            statusEl.textContent = planSuccessMessage(key);
                        } else {
                            resetPaymentStatus(key);
                        }
                    } else {
                        resetPaymentStatus(key);
                    }
                }
            });

            if (checkoutPanel) {
                checkoutPanel.classList.toggle("hidden", showPaystackFrame);
                checkoutPanel.classList.toggle("swap-anim", !showPaystackFrame);
                if (showPaystackFrame) checkoutPanel.classList.remove("swap-anim");
            }

            if (checkoutReview) {
                checkoutReview.classList.toggle("hidden", showPaystackFrame);
            }

            if (explorePanel && !explorePanel.classList.contains("hidden")) {
                explorePanel.classList.add("hidden");
                explorePanel.classList.remove("swap-anim");
            }

            const scrollTarget = showCoreFrame
                ? corePaymentContainer
                : showProfessionalFrame
                    ? professionalPaymentContainer
                    : checkoutPanel;
            if (scroll) {
                scrollTarget?.scrollIntoView({ behavior: "smooth", block: "start" });
            }
        };

        const beginCheckoutReveal = () => {
            if (checkoutRevealStarted) return;
            checkoutRevealStarted = true;

            if (checkoutLoader) checkoutLoader.classList.remove("hidden");
            checkoutPanel?.classList.add("hidden");
            checkoutPanel?.classList.remove("swap-anim");
            paystackPlanKeys.forEach((planKey) => {
                const context = paymentContexts[planKey];
                if (!context) return;
                context.container?.classList.add("hidden");
                context.container?.classList.remove("swap-anim");
                resetPaymentStatus(planKey);
            });
            if (explorePanel) explorePanel.classList.add("hidden");
            explorePanel?.classList.remove("swap-anim");

            checkoutRevealTimer = window.setTimeout(() => {
                if (checkoutLoader) checkoutLoader.classList.add("hidden");

                if (planSkipped || !selectedPlanKey) {
                    revealExplorePanel({ scroll: false });
                    return;
                }

                updateCheckout(selectedPlanKey, { scroll: false });
            }, 5000);
        };

        if (onboardingComplete && !onboardingComplete.classList.contains("hidden")) {
            if (onboardingIntro) onboardingIntro.classList.add("hidden");
            if (stepSummary) stepSummary.classList.add("hidden");
            beginCheckoutReveal();
        }

        function syncStepIndicators() {
            stepItems.forEach((item) => {
                const index = Number(item.dataset.stepItem);
                if (!index) return;
                const circle = item.querySelector(`[data-step-indicator="${index}"]`);
                const isActive = currentStep === index;
                const isComplete = completedSteps.has(index);
                const hasError = errorSteps.has(index);
                item.classList.toggle("step-item--active", isActive && !isComplete);
                item.classList.toggle("step-item--complete", isComplete);
                item.classList.toggle("step-item--error", hasError && !isComplete);
                if (circle) {
                    circle.textContent = isComplete ? "✓" : String(index);
                }
            });
        }

        function setErrorStepsFromMissing(missingKeys = []) {
            errorSteps.clear();
            missingKeys.forEach((key) => {
                const step = getStepForField(key);
                if (typeof step === "number") {
                    errorSteps.add(step);
                }
            });
            syncStepIndicators();
        }

        function autoCompleteStepsFromProfile(row) {
            const ensureStepFields = (step) => {
                const keys = STEP_FIELD_GROUPS[step];
                if (!keys || !keys.length) return false;
                return keys.every((key) => isRowFieldSatisfied(row, key));
            };

            Object.keys(STEP_FIELD_GROUPS).forEach((step) => {
                const stepNum = Number(step);
                if (ensureStepFields(stepNum)) completedSteps.add(stepNum);
            });
            if (row && row.pep) completedSteps.add(4);
            if (kycDone) completedSteps.add(5);
        }

        const activateStep = (step) => {
            const nextValue = Math.min(Math.max(step, 1), totalSteps);
            currentStep = nextValue;

            panels.forEach((panel) => {
                const panelStep = Number(panel.dataset.panel);
                const isActive = panelStep === nextValue;
                panel.classList.toggle("hidden", !isActive);
                panel.setAttribute("aria-hidden", String(!isActive));
            });

            const meta = stepMeta[nextValue];
            if (meta) {
                if (stepLabel) stepLabel.textContent = meta.label;
                if (stepTitle) stepTitle.textContent = meta.title;
            }

            if (nextValue === 6) {
                primeBrokerageStep({ silent: false });
            }

            syncStepIndicators();
        };

        document.querySelectorAll("[data-step-delta]").forEach((button) => {
            if (button.hasAttribute("data-save-profile")) return;
            button.addEventListener("click", () => {
                const delta = Number(button.dataset.stepDelta ?? 0);
                if (Number.isNaN(delta)) return;
                activateStep(currentStep + delta);
            });
        });

        document.querySelectorAll("[data-step-target]").forEach((button) => {
            button.addEventListener("click", () => {
                const target = Number(button.dataset.stepTarget ?? currentStep);
                if (Number.isNaN(target)) return;
                activateStep(target);
            });
        });

        if (samsubStartButton) {
            samsubStartButton.addEventListener("click", startSamsubVerification);
        }

        if (samsubCheckButton) {
            samsubCheckButton.addEventListener("click", () => {
                checkSamsubStatus({ silent: false, trigger: samsubCheckButton });
            });
        }

        if (samsubCompleteButton) {
            samsubCompleteButton.addEventListener("click", () => {
                checkSamsubStatus({ silent: false, trigger: samsubCompleteButton });
            });
        }

        if (samsubCopyLinkButton) {
            samsubCopyLinkButton.addEventListener("click", async () => {
                if (!samsubVerificationUrl) {
                    banner("Generate a verification link first.", "warn");
                    return;
                }
                try {
                    await navigator.clipboard.writeText(samsubVerificationUrl);
                    banner("Verification link copied to your clipboard.", "ok");
                } catch (error) {
                    console.error(error);
                    banner("Copy failed. You can copy it manually from the button above.", "warn");
                }
            });
        }

        [kycSelfieInput, kycIdDocumentInput, kycProofAddressInput].forEach((input) => {
            if (input) {
                input.addEventListener("change", updateKycDocumentState);
            }
        });

        updateKycDocumentState();

        if (alpacaCreateButton) {
            alpacaCreateButton.addEventListener("click", async () => {
                await createAlpacaAccount(alpacaCreateButton);
            });
        }

        if (alpacaSummaryRefresh) {
            alpacaSummaryRefresh.addEventListener("click", () => refreshBrokerageSummary({ silent: false }));
        }

        panelForms.forEach((form) => {
            form.addEventListener("submit", (event) => {
                event.preventDefault();
            });
        });

        const BLANK_AVATAR = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='%23e2e8f0'/></svg>";
        const avatarPreview = document.getElementById("avatar-preview");
        const avatarFile = document.getElementById("avatar-file");
        const avatarRemove = document.getElementById("remove-avatar");
        const avatarFilename = document.getElementById("avatar-filename");

        function setAvatarSrc(url) {
            const finalUrl = url ? `${url}${url.includes("?") ? "&" : "?"}v=${Date.now()}` : BLANK_AVATAR;
            if (avatarPreview) avatarPreview.src = finalUrl;
        }

        function setAvatarFilename(text) {
            if (avatarFilename) avatarFilename.textContent = text;
        }

        function getStepForField(fieldKey) {
            for (const [step, keys] of Object.entries(STEP_FIELD_GROUPS)) {
                if (Array.isArray(keys) && keys.includes(fieldKey)) {
                    return Number(step);
                }
            }
            if (fieldKey === "plan") return totalSteps;
            return null;
        }

        function getRequiredFieldsUpTo(step) {
            const out = new Set();
            for (let s = 1; s <= step; s += 1) {
                const fields = STEP_FIELD_GROUPS[s];
                if (!fields) continue;
                fields.forEach((key) => out.add(key));
            }
            return Array.from(out);
        }

        function validateProfile(step) {
            clearFieldErrors();
            const requiredKeys = getRequiredFieldsUpTo(step);
            const missing = [];
                requiredKeys.forEach((key) => {
                    if (key === OBJECTIVES_FIELD_KEY) {
                        if (!syncObjectivesHighlight()) missing.push(key);
                        return;
                    }
                    const el = document.getElementById(key);
                    if (!el) return;
                    if (!hasValue(el.value)) {
                        el.classList.add("input-error");
                        missing.push(key);
                    }
                });
            if (step >= totalSteps) {
                const hasPlan = planRadios.some((radio) => radio.checked);
                const requirePlan = !planSkipped;
                setPlanGroupError(requirePlan && !hasPlan);
                if (requirePlan && !hasPlan) missing.push("plan");
            } else {
                setPlanGroupError(false);
            }
            setErrorStepsFromMissing(missing);
            return missing;
        }

        function focusFirstMissing(missingKeys) {
            if (!missingKeys.length) return;
            const firstKey = missingKeys[0];
            const focusTarget = () => {
                if (firstKey === OBJECTIVES_FIELD_KEY) {
                    objectivesGroup?.scrollIntoView({ behavior: "smooth", block: "center" });
                    const firstCb = objectivesGroup?.querySelector('input[name="objectives"]');
                    firstCb?.focus();
                } else if (firstKey === "alpaca_agreements") {
                    alpacaAgreementsList?.scrollIntoView({ behavior: "smooth", block: "center" });
                    const firstCheckbox = alpacaAgreementsList?.querySelector('input[type="checkbox"]');
                    firstCheckbox?.focus();
                } else if (firstKey === "kyc_documents") {
                    kycSelfieInput?.scrollIntoView({ behavior: "smooth", block: "center" });
                    kycSelfieInput?.focus();
                } else if (firstKey === "plan") {
                    planGroup?.scrollIntoView({ behavior: "smooth", block: "center" });
                    const firstPlan = planRadios[0];
                    firstPlan?.focus();
                } else {
                    const el = document.getElementById(firstKey);
                    if (el) {
                        el.scrollIntoView({ behavior: "smooth", block: "center" });
                        if (el instanceof HTMLElement) el.focus();
                    }
                }
            };
            const targetStep = getStepForField(firstKey);
            if (typeof targetStep === "number" && targetStep !== currentStep) {
                activateStep(targetStep);
                window.requestAnimationFrame(focusTarget);
            } else {
                focusTarget();
            }
        }

        function setBusy(button, on) {
            if (!button) return;
            if (!button.dataset.originalText) button.dataset.originalText = button.textContent.trim();
            const savingText = button.dataset.savingText || "Saving…";
            button.disabled = on;
            button.classList.toggle("opacity-70", on);
            button.textContent = on ? savingText : button.dataset.originalText;
        }

        async function ensureProfile(userId, email) {
            let { data, error } = await supabase.from("profiles").select("*").eq("id", userId).maybeSingle();
            if (error && error.code !== "PGRST116") throw error;
            if (data) return data;
            const up = await supabase
                .from("profiles")
                .upsert({ id: userId, email, updated_at: new Date().toISOString() }, { onConflict: "id" })
                .select("*")
                .single();
            if (up.error) throw up.error;
            return up.data;
        }

        function resolveKycBoolean(row) {
            const hasUploadedDocuments =
                !!row?.kyc_selfie_url && !!row?.kyc_id_document_url && !!row?.kyc_proof_of_address_url;
            const status = row?.samsub_status ?? row?.kyc_status;
            if (typeof status === "boolean") return status || hasUploadedDocuments;
            if (typeof status === "string") {
                const normalized = status.toLowerCase();
                if (["verified", "approved", "done", "passed", "kyc_done", "completed", "complete"].includes(normalized))
                    return true;
            }
            return hasUploadedDocuments;
        }

        function setFieldValue(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            if (el instanceof HTMLInputElement || el instanceof HTMLSelectElement || el instanceof HTMLTextAreaElement) {
                let nextValue = value ?? "";
                if (ISO_COUNTRY_FIELDS.includes(id) && typeof nextValue === "string") {
                    nextValue = sanitizeIsoValue(nextValue);
                }
                if (el instanceof HTMLInputElement && el.type === "range" && (nextValue === "" || nextValue == null)) {
                    nextValue = typeof el.min !== "undefined" && el.min !== "" ? el.min : "0";
                }
                if (el instanceof HTMLSelectElement && nextValue && !Array.from(el.options).some((opt) => opt.value === nextValue)) {
                    const fallbackOption = document.createElement("option");
                    fallbackOption.value = nextValue;
                    fallbackOption.textContent = nextValue;
                    el.appendChild(fallbackOption);
                }
                el.value = nextValue;
                if (id === "tax_id_type") {
                    syncTaxIdInputState();
                }
                if (el.matches('input[type="range"][data-range-output]')) {
                    syncRangeDisplayForInput(el);
                }
            }
        }

        function hydrateObjectives(csv) {
            const set = new Set(
                (csv || "")
                    .split(",")
                    .map((part) => part.trim().toLowerCase())
                    .filter(Boolean),
            );
            document.querySelectorAll('input[name="objectives"]').forEach((cb) => {
                cb.checked = set.has(cb.value.trim().toLowerCase());
            });
        }

        const getTrimmedValue = (id) => (document.getElementById(id)?.value || "").trim();
        const getNumericValue = (id) => {
            const el = document.getElementById(id);
            if (!el) return null;
            const raw = el.value;
            if (raw == null || raw === "") return null;
            const value = Number(raw);
            return Number.isFinite(value) ? value : null;
        };

        function cleanObject(source = {}) {
            return Object.entries(source).reduce((acc, [key, value]) => {
                if (value == null) return acc;
                if (typeof value === "string" && value.trim() === "") return acc;
                acc[key] = value;
                return acc;
            }, {});
        }

        function collectProfilePayload({ agreementsClientIp } = {}) {
            if (!supabaseUser) throw new Error("Please sign in again.");
            const rawTaxIdType = document.getElementById("tax_id_type")?.value || "";
            const normalizedTaxIdType = rawTaxIdType ? rawTaxIdType : null;
            const taxIdNumberValue = document.getElementById("tax_id_number")?.value || "";
            const agreements = getSelectedAgreements({ clientIp: agreementsClientIp });
            const agreementProfileFields = buildAgreementProfileFields(agreements);
            const payload = {
                id: supabaseUser.id,
                first_name: (document.getElementById("first_name")?.value || "").trim(),
                last_name: (document.getElementById("last_name")?.value || "").trim(),
                phone: (document.getElementById("phone")?.value || "").trim(),
                address_line1: getTrimmedValue("address_line1") || null,
                address_line2: getTrimmedValue("address_line2") || null,
                address_city: getTrimmedValue("address_city") || null,
                address_state: getTrimmedValue("address_state") || null,
                address_postal_code: getTrimmedValue("address_postal_code") || null,
                dob: document.getElementById("dob")?.value || null,
                id_number: (document.getElementById("id_number")?.value || "").trim() || null,
                tax_id_type: normalizedTaxIdType,
                tax_id_number: taxIdNumberValue.trim() || null,
                country_birth: sanitizeIsoValue(document.getElementById("country_birth")?.value) || null,
                nationality: sanitizeIsoValue(document.getElementById("nationality")?.value) || null,
                country_residence: sanitizeIsoValue(document.getElementById("country_residence")?.value) || null,
                employment_status: document.getElementById("employment_status")?.value || null,
                occupation: (document.getElementById("occupation")?.value || "").trim() || null,
                employer: (document.getElementById("employer")?.value || "").trim() || null,
                source_of_funds: document.getElementById("source_of_funds")?.value || null,
                annual_income_min: getNumericValue("annual_income_min"),
                annual_income_max: getNumericValue("annual_income_max"),
                liquid_net_worth_min: getNumericValue("liquid_net_worth_min"),
                liquid_net_worth_max: getNumericValue("liquid_net_worth_max"),
                total_net_worth_min: getNumericValue("total_net_worth_min"),
                total_net_worth_max: getNumericValue("total_net_worth_max"),
                experience_level: document.getElementById("experience_level")?.value || null,
                risk_tolerance: document.getElementById("risk_tolerance")?.value || null,
                objectives: Array.from(document.querySelectorAll('input[name="objectives"]:checked'))
                    .map((cb) => cb.value)
                    .join(", "),
                pep: !!document.getElementById("alpacaPoliticallyExposed")?.checked,
                pep_family: !!document.getElementById("alpacaFamilyExposed")?.checked,
                control_person: !!document.getElementById("alpacaControlPerson")?.checked,
                broker_affiliation: !!document.getElementById("alpacaAffiliated")?.checked,
                aml_acknowledged: !!document.querySelector('input[name="aml"]')?.checked,
                suitability_risk_ack: !!document.querySelector('input[name="objectives_ack"]')?.checked,
                suitability_accuracy_ack: !!document.querySelector('input[name="disclosures"]')?.checked,
                plan: resolvePlanSelection() || profileRow?.plan || null,
                kyc_selfie_url: profileRow?.kyc_selfie_url || null,
                kyc_id_document_url: profileRow?.kyc_id_document_url || null,
                kyc_proof_of_address_url: profileRow?.kyc_proof_of_address_url || null,
                updated_at: new Date().toISOString(),
                ...agreementProfileFields,
            };
            return payload;
        }


        async function resolveClientIpAddress() {
            if (clientIpAddress) return clientIpAddress;
            if (!clientIpLookupPromise) {
                clientIpLookupPromise = (async () => {
                    try {
                        const response = await fetch("https://api.ipify.org?format=json");
                        if (!response.ok) throw new Error("Failed to determine client IP address.");
                        const data = await response.json().catch(() => ({}));
                        clientIpAddress = (data?.ip || "").trim() || null;
                        return clientIpAddress;
                    } catch (error) {
                        console.warn("Could not determine client IP address.", error);
                        return null;
                    } finally {
                        clientIpLookupPromise = null;
                    }
                })();
            }
            return clientIpLookupPromise;
        }

        const ALPACA_DISABLED_AGREEMENTS = new Set(["options_agreement"]);

        function getSelectedAgreements({ clientIp } = {}) {
            const templateCheckboxes = Array.from(document.querySelectorAll('[data-alpaca-agreement]'));
            const normalizedIpAddress = (clientIp || clientIpAddress || "").trim() || CLIENT_IP_FALLBACK;
            const signedAt = new Date().toISOString();

            return templateCheckboxes
                .filter(
                    (checkbox) =>
                        checkbox.checked &&
                        checkbox.dataset.alpacaAgreement &&
                        !ALPACA_DISABLED_AGREEMENTS.has(checkbox.dataset.alpacaAgreement),
                )
                .map((checkbox) => ({
                    agreement: checkbox.dataset.alpacaAgreement,
                    signed_at: signedAt,
                    ip_address: normalizedIpAddress,
                    revision: checkbox.dataset.agreementRevision || undefined,
                }));
        }

        function buildAgreementProfileFields(selectedAgreements = []) {
            const fields = {};

            ALPACA_AGREEMENTS.forEach(({ key }) => {
                const columnMap = ALPACA_AGREEMENT_COLUMNS[key];
                if (!columnMap) return;
                fields[columnMap.flag] = false;
                fields[columnMap.signedAt] = null;
                fields[columnMap.ip] = null;
            });

            selectedAgreements.forEach(({ agreement, signed_at: signedAt, ip_address: ipAddress }) => {
                const columnMap = ALPACA_AGREEMENT_COLUMNS[agreement];
                if (!columnMap) return;
                fields[columnMap.flag] = true;
                fields[columnMap.signedAt] = signedAt || new Date().toISOString();
                fields[columnMap.ip] = (ipAddress || "").trim() || CLIENT_IP_FALLBACK;
            });

            return fields;
        }

        function deriveStoredAgreementKeys(row) {
            const selected = new Set();

            ALPACA_AGREEMENTS.forEach(({ key }) => {
                const columnMap = ALPACA_AGREEMENT_COLUMNS[key];
                if (columnMap && row?.[columnMap.flag]) selected.add(key);
            });

            if (!selected.size) {
                const storedAgreements = Array.isArray(row?.alpaca_agreements) ? row.alpaca_agreements : [];
                storedAgreements.forEach((entry) => {
                    if (typeof entry?.agreement === "string") selected.add(entry.agreement);
                });
            }

            return selected;
        }

        const readFileAsDataUrl = (file) =>
            new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error("Unable to read file."));
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });

        const resolveDataUrl = async (source) => {
            if (!source) return null;
            if (source instanceof File) {
                return readFileAsDataUrl(source);
            }
            if (typeof source === "string") {
                if (source.startsWith("data:")) return source;
                const response = await fetch(source);
                if (!response.ok) return null;
                const blob = await response.blob();
                return readFileAsDataUrl(blob);
            }
            return null;
        };

        async function buildAlpacaDocuments() {
            const docs = [];
            const docSources = [
                {
                    input: kycSelfieInput?.files?.[0] || null,
                    url: profileRow?.kyc_selfie_url || null,
                    document_type: "identity_verification",
                    document_sub_type: "selfie",
                },
                {
                    input: kycIdDocumentInput?.files?.[0] || null,
                    url: profileRow?.kyc_id_document_url || null,
                    document_type: "identity_verification",
                    document_sub_type: "government_id",
                },
                {
                    input: kycProofAddressInput?.files?.[0] || null,
                    url: profileRow?.kyc_proof_of_address_url || null,
                    document_type: "address_verification",
                    document_sub_type: "proof_of_address",
                },
            ];

            for (const source of docSources) {
                const dataUrl = await resolveDataUrl(source.input || source.url);
                if (!dataUrl || typeof dataUrl !== "string") continue;
                const [header, base64Payload] = dataUrl.split(",", 2);
                if (!base64Payload) continue;
                const contentType =
                    header?.match(/^data:([^;]+);base64$/)?.[1]
                    || source.input?.type
                    || "application/octet-stream";
                docs.push({
                    document_type: source.document_type,
                    document_sub_type: source.document_sub_type,
                    content_data: base64Payload,
                    content_type: contentType,
                });
            }

            return docs;
        }

        async function buildAlpacaAccountPayload({ clientIp, includeDocuments = true } = {}) {
            const taxIdTypeValue = document.getElementById("tax_id_type")?.value || null;
            const taxIdValue = getTrimmedValue("tax_id_number") || null;
            const identity = cleanObject({
                given_name: getTrimmedValue("first_name"),
                family_name: getTrimmedValue("last_name"),
                date_of_birth: document.getElementById("dob")?.value || null,
                tax_id_type: taxIdTypeValue || null,
                tax_id: taxIdValue,
                country_of_birth: sanitizeIsoValue(document.getElementById("country_birth")?.value) || null,
                country_of_tax_residence: sanitizeIsoValue(document.getElementById("country_residence")?.value) || null,
                country_of_citizenship: sanitizeIsoValue(document.getElementById("nationality")?.value) || null,
            });

            const emailAddress = getPreferredBrokerageEmail();
            const streetLines = [getTrimmedValue("address_line1"), getTrimmedValue("address_line2")].filter(Boolean);
            const contact = cleanObject({
                email_address: emailAddress || null,
                phone_number: getTrimmedValue("phone") || null,
                city: getTrimmedValue("address_city") || null,
                state: getTrimmedValue("address_state") || null,
                postal_code: getTrimmedValue("address_postal_code") || null,
                country: sanitizeIsoValue(document.getElementById("country_residence")?.value) || null,
            });
            if (streetLines.length) {
                contact.street_address = streetLines;
            }

            const financialInformation = cleanObject({
                funding_source: document.getElementById("source_of_funds")?.value || null,
                annual_income_min: getNumericValue("annual_income_min"),
                annual_income_max: getNumericValue("annual_income_max"),
                liquid_net_worth_min: getNumericValue("liquid_net_worth_min"),
                liquid_net_worth_max: getNumericValue("liquid_net_worth_max"),
                total_net_worth_min: getNumericValue("total_net_worth_min"),
                total_net_worth_max: getNumericValue("total_net_worth_max"),
                investment_experience: document.getElementById("experience_level")?.value || null,
                risk_tolerance: document.getElementById("risk_tolerance")?.value || null,
                investment_objective: Array.from(document.querySelectorAll('input[name="objectives"]:checked'))
                    .map((cb) => cb.value)
                    .join(", "),
            });

            const disclosures = {
                is_control_person: !!document.getElementById("alpacaControlPerson")?.checked,
                is_affiliated_exchange_or_finra: !!document.getElementById("alpacaAffiliated")?.checked,
                is_politically_exposed: !!document.getElementById("alpacaPoliticallyExposed")?.checked,
                immediate_family_exposed: !!document.getElementById("alpacaFamilyExposed")?.checked,
            };

            const agreements = getSelectedAgreements({ clientIp });
            const documents = includeDocuments ? await buildAlpacaDocuments() : [];

            const payload = {
                identity,
                disclosures,
                account_type: "trading",
                agreements,
            };

            if (Object.keys(contact).length) {
                payload.contact = contact;
            }
            if (Object.keys(financialInformation).length) {
                payload.financial_information = financialInformation;
            }
            if (documents.length) {
                payload.documents = documents;
            }

            return payload;
        }

        function isMissingValue(value) {
            if (value === null || value === undefined) return true;
            if (typeof value === "string") return !value.trim();
            if (Array.isArray(value)) return value.length === 0;
            return false;
        }

        async function buildAlpacaAccountUpdatePayload(existingProfile, { clientIp } = {}) {
            const current = existingProfile || alpacaAccountProfile || {};
            const desired = await buildAlpacaAccountPayload({ clientIp });
            const patch = {};

            const ensureSection = (section, keys) => {
                const currentSection = current?.[section] || {};
                const desiredSection = desired?.[section] || {};
                const sectionPatch = {};

                keys.forEach((key) => {
                    const currentValue = currentSection?.[key];
                    const desiredValue = desiredSection?.[key];
                    if (isMissingValue(currentValue) && !isMissingValue(desiredValue)) {
                        sectionPatch[key] = desiredValue;
                    }
                });

                if (Object.keys(sectionPatch).length) {
                    patch[section] = { ...currentSection, ...sectionPatch };
                }
            };

            ensureSection(
                "identity",
                [
                    "given_name",
                    "family_name",
                    "date_of_birth",
                    "tax_id",
                    "tax_id_type",
                    "country_of_birth",
                    "country_of_tax_residence",
                    "country_of_citizenship",
                ].filter((key) => !ALPACA_UNPATCHABLE_IDENTITY_FIELDS.has(key)),
            );

            ensureSection("contact", [
                "email_address",
                "phone_number",
                "city",
                "state",
                "postal_code",
                "country",
                "street_address",
                "unit",
            ]);

            ensureSection("financial_information", [
                "funding_source",
                "annual_income_min",
                "annual_income_max",
                "liquid_net_worth_min",
                "liquid_net_worth_max",
                "total_net_worth_min",
                "total_net_worth_max",
                "investment_experience",
                "risk_tolerance",
                "investment_objective",
            ]);

            ensureSection("disclosures", [
                "is_control_person",
                "is_affiliated_exchange_or_finra",
                "is_politically_exposed",
                "immediate_family_exposed",
            ]);

            const desiredAgreements = Array.isArray(desired.agreements) ? desired.agreements : [];
            const existingAgreements = Array.isArray(current.agreements) ? current.agreements : [];
            const missingAgreements = desiredAgreements.filter(
                ({ agreement }) => !existingAgreements.some((entry) => entry?.agreement === agreement),
            );
            if (missingAgreements.length) {
                patch.agreements = missingAgreements;
            }

            const desiredDocuments = Array.isArray(desired.documents) ? desired.documents : [];
            const existingDocuments = Array.isArray(current.documents) ? current.documents : [];
            const missingDocuments = desiredDocuments.filter((doc) => {
                return !existingDocuments.some(
                    (existingDoc) =>
                        existingDoc?.document_type === doc.document_type &&
                        existingDoc?.document_sub_type === doc.document_sub_type,
                );
            });
            if (missingDocuments.length) {
                patch.documents = missingDocuments;
            }

            return Object.keys(patch).length ? patch : null;
        }

        function deriveAccountNumber(payload) {
            const candidates = [payload?.account_number, payload?.accountNumber, payload?.number];
            for (const candidate of candidates) {
                if (typeof candidate === "string" && candidate.trim()) return candidate.trim();
            }
            return null;
        }

        function syncAlpacaCreateButton() {
            if (!alpacaCreateButton) return;
            const hasAccount = !!alpacaAccountId;
            alpacaCreateButton.disabled = hasAccount;
            alpacaCreateButton.setAttribute("aria-disabled", hasAccount ? "true" : "false");
            alpacaCreateButton.classList.toggle("opacity-50", hasAccount);
            alpacaCreateButton.textContent = hasAccount ? "Brokerage account created" : "Create brokerage account";
        }

        function renderBrokerageAccountSummary() {
            if (!alpacaAccountExisting || !alpacaAccountIdValue) return;
            const displayNumber = alpacaAccountNumber || null;
            if (alpacaAccountId && displayNumber) {
                alpacaAccountExisting.classList.remove("hidden");
                alpacaAccountIdValue.textContent = displayNumber;
            } else {
                alpacaAccountExisting.classList.add("hidden");
                alpacaAccountIdValue.textContent = "";
            }
            syncAlpacaCreateButton();
            renderAlpacaAccountSummary();
            if (typeof renderAchRelationshipSummary === 'function') {
                renderAchRelationshipSummary();
            }
        }

        function renderAlpacaAccountSummary() {
            if (!alpacaAccountSummary || !alpacaAccountSummaryBody) return;
            if (!alpacaAccountProfile) {
                alpacaAccountSummary.classList.add("hidden");
                alpacaAccountSummaryBody.innerHTML = "";
                return;
            }

            const rows = [];
            const addRow = (label, value) => {
                if (value === null || value === undefined || value === "") return;
                rows.push(`<div class="flex flex-col gap-1 rounded-xl border border-slate-200 bg-white px-3 py-2">
                        <dt class="text-[11px] font-semibold uppercase tracking-[0.16em] text-slate-500">${label}</dt>
                        <dd class="text-sm font-semibold text-slate-800">${value}</dd>
                    </div>`);
            };

            addRow("Account number", alpacaAccountNumber);
            addRow("Status", alpacaAccountProfile.status || alpacaAccountProfile.account_status || "submitted");
            addRow("Type", alpacaAccountProfile.account_type || alpacaAccountProfile.type);
            addRow("Created", alpacaAccountProfile.created_at ? new Date(alpacaAccountProfile.created_at).toLocaleString() : null);
            addRow("Currency", alpacaAccountProfile.currency || alpacaAccountProfile.base_currency);
            addRow("Buying power", alpacaAccountProfile.buying_power || alpacaAccountProfile.trading_buying_power);
            addRow("Cash", alpacaAccountProfile.cash);
            addRow(
                "Equity",
                alpacaAccountProfile.equity ||
                    alpacaAccountProfile.portfolio_value ||
                    alpacaAccountProfile.long_market_value,
            );
            addRow("Pattern day trader", String(alpacaAccountProfile.pattern_day_trader ?? ""));

            alpacaAccountSummaryBody.innerHTML = rows.join("");
            alpacaAccountSummary.classList.toggle("hidden", !rows.length);
        }

        function updateAlpacaStatus(state, { message, response } = {}) {
            const meta = ALPACA_STATUS_META[state] || ALPACA_STATUS_META.idle;
            alpacaAccountState = state;
            if (alpacaStatusBadge && meta.badgeClass) {
                alpacaStatusBadge.className = meta.badgeClass;
                alpacaStatusBadge.textContent = meta.badgeText;
            }
            if (alpacaStatusText && meta.text) {
                alpacaStatusText.textContent = message || meta.text;
            }
            if (response && typeof response === "object") {
                const derivedId = response.id || response.account_id || response.accountId || null;
                const derivedStatus = response.status || response.account_status || response.application_status || null;
                if (derivedId) alpacaAccountId = derivedId;
                if (derivedStatus) alpacaAccountStatus = derivedStatus;
                alpacaAccountProfile = response;
                alpacaAccountNumber = deriveAccountNumber(response) || alpacaAccountNumber || null;
            }
            renderBrokerageAccountSummary();
        }

        function hydrateBrokerageFromRow(row) {
            if (!row || typeof row !== "object") return;
            alpacaAccountId = row.alpaca_account_id || alpacaAccountId || null;
            alpacaAccountStatus = row.alpaca_account_status || alpacaAccountStatus || null;
            renderBrokerageAccountSummary();
            if (alpacaAccountId && !alpacaAccountProfile) {
                refreshBrokerageSummary({ silent: true });
            }
        }

        async function hydrateBrokerageFromApi(emailAddress, { silent = true } = {}) {
            if (!emailAddress) return null;
            const existingAccount = await fetchExistingBrokerageAccountFromApi(emailAddress);
            if (!existingAccount) return null;
            const accountId = deriveBrokerageAccountId(existingAccount);
            const accountStatus = deriveBrokerageAccountStatus(existingAccount);

            if (accountId) {
                alpacaAccountId = accountId;
                alpacaAccountStatus = accountStatus || alpacaAccountStatus || null;
                alpacaAccountNumber = deriveAccountNumber(existingAccount) || alpacaAccountNumber || null;
                alpacaAccountProfile = existingAccount || alpacaAccountProfile;
                renderBrokerageAccountSummary();
                await persistBrokerageAccountRecord(accountId, accountStatus);
                await updateProfileBrokerage(
                    { alpaca_account_id: accountId, alpaca_account_status: accountStatus || "on file" },
                    { silent },
                );
                await refreshBrokerageSummary({ silent: true });
            }

            if (!silent) {
                updateAlpacaStatus("success", {
                    message: accountId
                        ? `Brokerage account already exists (ID: ${accountId}).`
                        : "Brokerage account already exists on file.",
                    response: existingAccount,
                });
                if (alpacaStatusText && accountStatus) {
                    alpacaStatusText.textContent = `Account status: ${accountStatus}`;
                }
                banner("Existing brokerage account found.", "ok");
            }

            return existingAccount;
        }

        async function fetchBrokerageAccountRow() {
            if (!supabaseUser) return null;
            try {
                const emailAddress = (supabaseUser?.email || profileRow?.email || "").trim();
                let query = supabase.from("alpaca_accounts").select("*");
                query = emailAddress ? query.eq("email", emailAddress) : query.eq("user_id", supabaseUser.id);
                const { data, error } = await query.maybeSingle();
                if (error && error.code !== "PGRST116") throw error;
                if (data?.alpaca_account_id) {
                    alpacaAccountId = data.alpaca_account_id;
                    alpacaAccountStatus = data.alpaca_account_status || alpacaAccountStatus || null;
                    renderBrokerageAccountSummary();
                    if (alpacaAccountId) {
                        await refreshBrokerageSummary({ silent: true });
                    }
                }
                return data;
            } catch (error) {
                console.warn("Could not load brokerage account record.", error);
                return null;
            }
        }

        function describeExistingBrokerageAccount() {
            const parts = [];
            if (alpacaAccountNumber) parts.push(`Account number: ${alpacaAccountNumber}`);
            if (alpacaAccountId && !alpacaAccountNumber) parts.push(`Account ID: ${alpacaAccountId}`);
            if (alpacaAccountStatus) parts.push(`Status: ${alpacaAccountStatus}`);
            if (!parts.length) return "Brokerage account already exists.";
            return `Brokerage account already exists (${parts.join(" • ")}).`;
        }

        async function refreshBrokerageFromDb() {
            if (!supabaseUser) return null;
            const emailAddress = getPreferredBrokerageEmail();
            let query = supabase.from("profiles").select("*");
            query = emailAddress
                ? query.or(`email.eq.${emailAddress},email_address.eq.${emailAddress}`)
                : query.eq("id", supabaseUser.id);
            const { data, error } = await query.maybeSingle();
            if (error && error.code !== "PGRST116") throw error;
            if (data) {
                profileRow = { ...profileRow, ...data };
                hydrateBrokerageFromRow(data);
            }

            const brokerageRow = await fetchBrokerageAccountRow();
            if (
                brokerageRow?.alpaca_account_id &&
                (!profileRow?.alpaca_account_id || profileRow?.alpaca_account_id !== brokerageRow.alpaca_account_id)
            ) {
                await updateProfileBrokerage(
                    {
                        alpaca_account_id: brokerageRow.alpaca_account_id,
                        alpaca_account_status: brokerageRow.alpaca_account_status || alpacaAccountStatus || null,
                    },
                    { silent: true },
                );
            }
            if (!alpacaAccountId && emailAddress) {
                await hydrateBrokerageFromApi(emailAddress, { silent: true });
            }
            return data;
        }

        async function primeBrokerageStep({ silent = true } = {}) {
            if (!supabaseUser) return null;
            if (brokeragePrimePromise) return brokeragePrimePromise;
            brokeragePrimePromise = (async () => {
                try {
                    const emailAddress = getPreferredBrokerageEmail();
                    updateAlpacaStatus("checking", {
                        message: emailAddress
                            ? `Checking for an existing brokerage account using ${emailAddress}…`
                            : "Checking for an existing brokerage account…",
                    });
                    await refreshBrokerageFromDb();
                    if (alpacaAccountId) {
                        updateAlpacaStatus("success", {
                            message: describeExistingBrokerageAccount(),
                            response: { id: alpacaAccountId, status: alpacaAccountStatus || "on file" },
                        });
                    } else if (!silent) {
                        updateAlpacaStatus("idle", {
                            message: emailAddress
                                ? `No brokerage account found for ${emailAddress}. Create one to continue.`
                                : "No brokerage account found yet. Create one to continue.",
                        });
                    }
                } finally {
                    brokeragePrimePromise = null;
                }
            })();
            return brokeragePrimePromise;
        }

        async function updateProfileBrokerage(partial, { silent = true } = {}) {
            if (!supabaseUser) return null;
            const payload = {
                id: supabaseUser.id,
                updated_at: new Date().toISOString(),
                ...partial,
            };
            try {
                const { data, error } = await supabase.from("profiles").upsert(payload, { onConflict: "id" }).select("*").single();
                if (error) throw error;
                profileRow = { ...profileRow, ...data };
                hydrateBrokerageFromRow(data);
                return data;
            } catch (error) {
                console.error(error);
                if (!silent) banner(error.message || "Could not update brokerage details.", "err");
                return null;
            }
        }

        async function persistBrokerageAccountRecord(accountId, accountStatus) {
            if (!supabaseUser || !accountId) return null;
            const payload = {
                user_id: supabaseUser.id,
                email: (supabaseUser?.email || "").trim() || null,
                alpaca_account_id: accountId,
                alpaca_account_status: accountStatus || alpacaAccountStatus || "submitted",
                updated_at: new Date().toISOString(),
            };
            try {
                const { data, error } = await supabase
                    .from("alpaca_accounts")
                    .upsert(payload, { onConflict: "user_id" })
                    .select("*")
                    .maybeSingle();
                if (error) throw error;
                if (data?.alpaca_account_id) {
                    alpacaAccountId = data.alpaca_account_id;
                    alpacaAccountStatus = data.alpaca_account_status || alpacaAccountStatus;
                    renderBrokerageAccountSummary();
                }
                return data;
            } catch (error) {
                console.warn("Could not persist brokerage account record.", error);
                return null;
            }
        }

        async function createAlpacaAccount(button) {
            if (!supabaseUser) {
                banner("Please sign in again.", "err");
                return;
            }

            await refreshBrokerageFromDb();
            if (alpacaAccountId) {
                updateAlpacaStatus("success", {
                    message: `Brokerage account already exists (ID: ${alpacaAccountId}).`,
                    response: { id: alpacaAccountId, status: alpacaAccountStatus || "on file" },
                });
                banner("Brokerage account already on file.", "ok");
                return;
            }

            const emailAddress = getPreferredBrokerageEmail();
            if (emailAddress) {
                const existingAccount = await hydrateBrokerageFromApi(emailAddress, { silent: false });
                if (existingAccount) return;
            }

            const previewPayload = await buildAlpacaAccountPayload({ includeDocuments: false });
            const missingFields = [];
            if (!previewPayload.identity?.given_name) missingFields.push("first_name");
            if (!previewPayload.identity?.family_name) missingFields.push("last_name");
            if (!previewPayload.identity?.date_of_birth) missingFields.push("dob");
            if (!previewPayload.identity?.country_of_tax_residence) missingFields.push("country_residence");
            const taxIdTypeValue = document.getElementById("tax_id_type")?.value || "";
            if (!taxIdTypeValue) missingFields.push("tax_id_type");
            if (shouldRequireTaxIdNumber() && !previewPayload.identity?.tax_id) {
                missingFields.push("tax_id_number");
            }
            if (!previewPayload.contact?.street_address?.length) missingFields.push("address_line1");
            if (!previewPayload.contact?.city) missingFields.push("address_city");
            if (!previewPayload.contact?.state) missingFields.push("address_state");
            if (!previewPayload.contact?.postal_code) missingFields.push("address_postal_code");
            if (!previewPayload.financial_information?.funding_source) missingFields.push("source_of_funds");

            const selectedAgreements = getSelectedAgreements();
            const missingAgreements = ALPACA_REQUIRED_AGREEMENTS.filter(
                (key) => !selectedAgreements.some((agreement) => agreement.agreement === key),
            );
            if (missingAgreements.length) missingFields.push("alpaca_agreements");

            if (missingFields.length) {
                focusFirstMissing(missingFields);
                banner("Complete your personal information before creating a brokerage account.", "err");
                return;
            }

            setBusy(button, true);
            updateAlpacaStatus("submitting", { message: "Submitting your brokerage application…" });
            try {
                await saveProfileForBrokerage();
                const clientIp = await resolveClientIpAddress();
                const payload = await buildAlpacaAccountPayload({ clientIp });
                if ((payload.documents || []).length < 3) {
                    focusFirstMissing(["kyc_documents"]);
                    banner("Upload your selfie, ID, and proof of address before submitting.", "err");
                    updateAlpacaStatus("error", { message: "Missing required verification documents." });
                    return;
                }
                const response = await fetch(ALPACA_ACCOUNT_URL, {
                    method: "POST",
                    headers: {
                        accept: "application/json",
                        "content-type": "application/json",
                        authorization: getAlpacaAuthHeader(),
                    },
                    body: JSON.stringify(payload),
                });
                const data = await response.json().catch(() => null);
                const fallbackText = data ? "" : await response.text().catch(() => "");

                if (!response.ok) {
                    const detail = data?.message
                        || data?.error
                        || (Array.isArray(data?.errors) ? data.errors.map((err) => err?.message || err).join("; ") : "")
                        || (data ? JSON.stringify(data) : "")
                        || (fallbackText ? fallbackText.trim() : "");
                    const errorMessage = detail
                        ? `Brokerage request failed (${response.status}): ${detail}`
                        : `Brokerage request failed (${response.status})`;
                    console.warn("Alpaca account create failed", { status: response.status, data, fallbackText });
                    updateAlpacaStatus("error", { message: errorMessage, response: data });
                    banner(errorMessage, "err");
                    return;
                }

                const accountId = data?.id || data?.account_id || null;
                const accountStatus = data?.status || data?.account_status || null;
                if (accountId) {
                    await persistBrokerageAccountRecord(accountId, accountStatus);
                    await updateProfileBrokerage(
                        { alpaca_account_id: accountId, alpaca_account_status: accountStatus || "submitted" },
                        { silent: false },
                    );
                }

                updateAlpacaStatus("success", {
                    message: "Your brokerage application was received. Watch your inbox for the final approval.",
                    response: data,
                });
                if (accountId) {
                    await refreshBrokerageSummary({ silent: true });
                }
                banner("Brokerage account request submitted.", "ok");
            } catch (error) {
                console.error(error);
                updateAlpacaStatus("error", { message: error.message || "Could not reach the brokerage service." });
                banner(error.message || "Could not reach the brokerage service.", "err");
            } finally {
                setBusy(button, false);
            }
        }


        function buildKycPayload(partial = {}) {
            const baseKeys = [
                "kyc_status",
                "kyc_reference",
                "kyc_applicant_id",
                "kyc_external_user_id",
                "kyc_started_at",
                "kyc_verified_at",
                "samsub_status",
                "samsub_external_user_id",
                "samsub_applicant_id",
                "samsub_websdk_url",
                "samsub_last_updated",
            ];
            const allowed = new Set(baseKeys);
            if (profileRow && typeof profileRow === "object") {
                Object.keys(profileRow).forEach((key) => {
                    if (key.startsWith("kyc_") || key.startsWith("samsub_")) {
                        allowed.add(key);
                    }
                });
            }
            return Object.entries(partial || {}).reduce((acc, [key, value]) => {
                if (allowed.has(key)) acc[key] = value;
                return acc;
            }, {});
        }

        async function updateProfileKyc(partial, { silent = true } = {}) {
            if (!supabaseUser) return null;
            const filtered = buildKycPayload(partial);
            if (!Object.keys(filtered).length) return null;
            const payload = {
                id: supabaseUser.id,
                updated_at: new Date().toISOString(),
                ...filtered,
            };
            try {
                const { data, error } = await supabase
                    .from("profiles")
                    .upsert(payload, { onConflict: "id" })
                    .select("*")
                    .single();
                if (error) throw error;
                profileRow = { ...profileRow, ...data };
                if (typeof data.samsub_last_updated !== "undefined") {
                    samsubLastGeneratedAt = data.samsub_last_updated
                        ? new Date(data.samsub_last_updated)
                        : null;
                }
                if (
                    typeof data.samsub_status !== "undefined" ||
                    typeof data.kyc_status !== "undefined"
                ) {
                    kycDone = resolveKycBoolean(profileRow);
                }
                return data;
            } catch (error) {
                console.error(error);
                if (!silent) banner(error.message || "Could not update KYC status.", "err");
                return null;
            }
        }

        async function markSamsubPending({
            applicantId,
            externalUserId,
            websdkUrl,
            ttlInSecs,
            message,
        } = {}) {
            const generatedAt = new Date();
            if (typeof ttlInSecs === "number" && !Number.isNaN(ttlInSecs)) {
                samsubLinkTtlSecs = ttlInSecs;
            }
            samsubApplicantId = applicantId || samsubApplicantId || null;
            samsubExternalUserId = externalUserId || samsubExternalUserId || supabaseUser?.id || null;
            samsubLastGeneratedAt = generatedAt;
            if (websdkUrl) {
                applySamsubLink(websdkUrl, {
                    message: message || "We opened the SamSub window below for you to continue verification.",
                });
            }
            kycDone = false;
            completedSteps.delete(5);
            syncStepIndicators();
            syncKycContinueButton();
            const partial = {
                samsub_status: "pending",
                samsub_external_user_id: samsubExternalUserId,
                samsub_applicant_id: samsubApplicantId,
                samsub_websdk_url: websdkUrl || samsubVerificationUrl,
                samsub_last_updated: generatedAt.toISOString(),
                kyc_status: "pending",
                kyc_reference: samsubApplicantId,
                kyc_applicant_id: samsubApplicantId,
                kyc_external_user_id: samsubExternalUserId,
                kyc_started_at: generatedAt.toISOString(),
            };
            await updateProfileKyc(partial, { silent: true });
            setSamsubStatus("pending", {
                showCheck: true,
                message: message || "Your SamSub session is ready. Complete the steps in the window below.",
            });
            syncSamsubStartButton();
        }

        function extractSamsubApplicant(payload) {
            if (!payload || typeof payload !== "object") return null;
            if (Array.isArray(payload)) {
                for (const item of payload) {
                    const extracted = extractSamsubApplicant(item);
                    if (extracted) return extracted;
                }
                return null;
            }

            if (payload.id || payload.applicantId || payload.applicant_id) return payload;

            if (payload.applicant && typeof payload.applicant === "object") {
                const nested = extractSamsubApplicant(payload.applicant);
                if (nested) return nested;
            }

            if (Array.isArray(payload.applicants)) {
                const fromApplicants = extractSamsubApplicant(payload.applicants);
                if (fromApplicants) return fromApplicants;
            }

            if (Array.isArray(payload.items)) {
                const fromItems = extractSamsubApplicant(payload.items);
                if (fromItems) return fromItems;
            }

            if (payload.data) {
                const fromData = extractSamsubApplicant(payload.data);
                if (fromData) return fromData;
            }

            return null;
        }

        function deriveSamsubApplicantId(payload) {
            const applicant = extractSamsubApplicant(payload);
            if (!applicant) return null;
            const candidates = [
                applicant.id,
                applicant.applicantId,
                applicant.applicant_id,
                applicant.inspectionId,
                applicant.inspection_id,
            ];
            for (const candidate of candidates) {
                if (typeof candidate === "string" && candidate.trim()) return candidate.trim();
            }
            return null;
        }

        function deriveSamsubExternalUserId(payload) {
            const applicant = extractSamsubApplicant(payload) || {};
            const candidates = [
                applicant.externalUserId,
                applicant.external_user_id,
                applicant.userId,
                applicant.user_id,
                applicant.clientId,
                applicant.client_id,
                applicant.customerId,
                applicant.customer_id,
                payload?.externalUserId,
                payload?.external_user_id,
                payload?.userId,
                payload?.user_id,
            ];
            for (const candidate of candidates) {
                if (typeof candidate === "string" && candidate.trim()) return candidate.trim();
            }
            return null;
        }

        function deriveSamsubLink(payload) {
            const strings = [];
            const push = (value) => {
                if (typeof value === "string") {
                    const trimmed = value.trim();
                    if (trimmed) strings.push(trimmed);
                }
            };

            const inspect = (obj) => {
                if (!obj || typeof obj !== "object") return;
                push(obj.websdkUrl);
                push(obj.websdk_url);
                push(obj.url);
                push(obj.href);
                push(obj.link);
            };

            inspect(payload);

            if (Array.isArray(payload?.links)) {
                payload.links.forEach((link) => {
                    if (typeof link === "string") {
                        push(link);
                    } else {
                        inspect(link);
                    }
                });
            }

            const applicant = extractSamsubApplicant(payload);
            inspect(applicant);

            if (Array.isArray(applicant?.links)) {
                applicant.links.forEach((link) => {
                    if (typeof link === "string") {
                        push(link);
                    } else {
                        inspect(link);
                    }
                });
            }

            return strings.length ? strings[0] : null;
        }

        function resolveSamsubState(payload) {
            const normalize = (value) => {
                if (typeof value === "string") {
                    const trimmed = value.trim();
                    if (trimmed) return trimmed.toLowerCase();
                }
                return null;
            };

            const primaryTokens = [
                normalize(payload?.reviewResult?.reviewAnswer),
                normalize(payload?.reviewResult?.reviewStatus),
                normalize(payload?.reviewStatus),
                normalize(payload?.status),
                normalize(payload?.action),
                normalize(payload?.reason),
            ].filter(Boolean);

            const successTokens = [
                "green",
                "approved",
                "completed",
                "complete",
                "finished",
                "accepted",
                "verified",
                "clear",
                "success",
                "pass",
                "passed",
            ];
            const failureTokens = ["red", "reject", "declin", "failed", "fraud", "expired", "denied", "refused"];
            const pendingTokens = [
                "pending",
                "review",
                "progress",
                "processing",
                "queued",
                "init",
                "waiting",
                "in_progress",
            ];

            const primaryMatch = primaryTokens.find((token) => successTokens.some((success) => token.includes(success)));
            if (primaryMatch) {
                return { state: "verified", message: "SamSub approved your documents." };
            }

            const failureMatch = primaryTokens.find((token) => failureTokens.some((fail) => token.includes(fail)));
            if (failureMatch) {
                const summary =
                    payload?.reviewResult?.moderationComment || payload?.reviewStatus || payload?.status || "Action required";
                return {
                    state: "failed",
                    message: `SamSub reported: ${summary}. Please review and try again.`,
                    banner: "SamSub needs more information to verify your identity.",
                };
            }

            const pendingMatch = primaryTokens.find((token) => pendingTokens.some((pending) => token.includes(pending)));
            if (pendingMatch) {
                const summary = payload?.reviewStatus || payload?.reviewResult?.reviewStatus || payload?.status || "Pending";
                return {
                    state: "pending",
                    message: `Current SamSub status: ${summary}. We'll notify you once it's complete.`,
                    banner: "SamSub is still reviewing your documents.",
                };
            }

            const values = [];
            const push = (value) => {
                if (value == null) return;
                if (Array.isArray(value)) {
                    value.forEach((item) => push(item));
                } else {
                    const str = String(value).trim();
                    if (str) values.push(str);
                }
            };

            push(payload?.reviewStatus);
            push(payload?.reviewResult?.reviewAnswer);
            push(payload?.reviewResult?.reviewStatus);
            push(payload?.reviewResult?.moderationComment);
            push(payload?.reviewResult?.clientComment);
            push(payload?.status);
            push(payload?.action);
            push(payload?.reason);
            push(payload?.clientComment);
            if (Array.isArray(payload?.reviewResult?.rejectLabels)) {
                push(payload.reviewResult.rejectLabels.join(" "));
            }

            const normalized = values.map((value) => value.toLowerCase());
            const includesAny = (tokens) => normalized.some((value) => tokens.some((token) => value.includes(token)));

            if (includesAny(successTokens)) {
                return { state: "verified", message: "SamSub approved your documents." };
            }

            if (includesAny(failureTokens)) {
                const summary =
                    payload?.reviewResult?.moderationComment || payload?.reviewStatus || payload?.status || "Action required";
                return {
                    state: "failed",
                    message: `SamSub reported: ${summary}. Please review and try again.`,
                    banner: "SamSub needs more information to verify your identity.",
                };
            }

            const summary = payload?.reviewStatus || payload?.reviewResult?.reviewStatus || payload?.status || "Pending";
            return {
                state: "pending",
                message: `Current SamSub status: ${summary}. We'll notify you once it's complete.`,
                banner: "SamSub is still reviewing your documents.",
            };
        }

        async function markSamsubVerified(statusPayload) {
            const verifiedAt =
                statusPayload?.reviewResult?.reviewDate ||
                statusPayload?.reviewResult?.moderationDate ||
                new Date().toISOString();
            const updatedAt = new Date().toISOString();

            const derivedApplicantId =
                samsubApplicantId ||
                deriveSamsubApplicantId(statusPayload) ||
                profileRow?.samsub_applicant_id ||
                profileRow?.kyc_reference ||
                profileRow?.kyc_applicant_id ||
                null;
            if (derivedApplicantId) samsubApplicantId = derivedApplicantId;

            const derivedExternalUserId =
                samsubExternalUserId ||
                deriveSamsubExternalUserId(statusPayload) ||
                profileRow?.samsub_external_user_id ||
                profileRow?.kyc_external_user_id ||
                supabaseUser?.id ||
                null;
            if (derivedExternalUserId) samsubExternalUserId = derivedExternalUserId;

            const storedLink =
                samsubVerificationUrl ||
                deriveSamsubLink(statusPayload) ||
                profileRow?.samsub_websdk_url ||
                null;

            const partial = {
                samsub_status: "complete",
                samsub_last_updated: updatedAt,
                kyc_status: "verified",
                kyc_verified_at: verifiedAt,
            };

            if (derivedApplicantId) {
                partial.samsub_applicant_id = derivedApplicantId;
                partial.kyc_reference = derivedApplicantId;
                partial.kyc_applicant_id = derivedApplicantId;
            }

            if (derivedExternalUserId) {
                partial.samsub_external_user_id = derivedExternalUserId;
                partial.kyc_external_user_id = derivedExternalUserId;
            }

            if (storedLink) {
                partial.samsub_websdk_url = storedLink;
            }

            await updateProfileKyc(partial, { silent: false });
            kycDone = true;
            completedSteps.add(5);
            syncStepIndicators();
            syncKycContinueButton();
            setSamsubStatus("complete", {
                showCheck: true,
                message: "Your identity is verified. You're all set!",
                lastChecked: new Date(),
            });
            renderSamsubSteps();
            samsubVerificationUrl = null;
            samsubLastGeneratedAt = null;
            applySamsubLink(null);
            syncSamsubStartButton();
            banner("SamSub verification complete. You're good to go!", "ok");
        }

        async function startSamsubVerification() {
            if (!supabaseUser) {
                banner("Please sign in again.", "err");
                return;
            }
            if (samsubStartButton) setBusy(samsubStartButton, true);
            try {
                if (hasReusableSamsubLink()) {
                    applySamsubLink(samsubVerificationUrl, {
                        message: "Continue your SamSub verification in the secure window below.",
                    });
                    setSamsubStatus("pending", {
                        showCheck: true,
                        message: "We reopened your SamSub verification in the window below.",
                    });
                    banner("Your SamSub verification is ready in the window below.", "ok");
                    return;
                }

                const levelName = SAMSUB_LEVEL_NAME || "id-and-liveness";
                const response = await fetch("/api/samsub/kyc/init-websdk", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        externalUserId: supabaseUser.id,
                        levelName,
                        ttlInSecs: SAMSUB_WEBSDK_DEFAULT_TTL,
                    }),
                });
                const payload = await parseJsonResponse(response, "SamSub WebSDK initialiser");
                if (!response.ok) {
                    const message =
                        payload?.error?.message ||
                        payload?.error ||
                        payload?.description ||
                        payload?.data?.description ||
                        "Could not start SamSub verification.";
                    throw new Error(message);
                }

                const data = payload?.data || {};
                const websdkUrl = data.websdkUrl || data.url || data.link;
                if (!websdkUrl) {
                    throw new Error("The SamSub WebSDK did not return a launch URL.");
                }

                const ttlInSecs = typeof data.ttlInSecs === "number" ? data.ttlInSecs : SAMSUB_WEBSDK_DEFAULT_TTL;
                await markSamsubPending({
                    applicantId: data.applicantId,
                    externalUserId: data.externalUserId,
                    websdkUrl,
                    ttlInSecs,
                    message: "Your SamSub session is ready. Complete the steps in the window below.",
                });
                banner("SamSub verification is ready in the window below.", "ok");
            } catch (error) {
                console.error(error);
                setSamsubStatus("error", {
                    showCheck: !!samsubApplicantId,
                    message: error.message || "Could not start SamSub verification.",
                });
                banner(error.message || "Could not start SamSub verification.", "err");
            } finally {
                if (samsubStartButton) setBusy(samsubStartButton, false);
                syncSamsubStartButton();
            }
        }





        async function checkSamsubStatus({ silent = false, trigger = null } = {}) {
            if (!supabaseUser) {
                banner("Please sign in again.", "err");
                return;
            }
            if (!samsubApplicantId) {
                banner("Start your SamSub verification first.", "warn");
                return;
            }

            const busyTarget = trigger || samsubCheckButton;
            if (busyTarget) setBusy(busyTarget, true);
            try {
                const response = await fetch(`/api/samsub/kyc/status/${encodeURIComponent(samsubApplicantId)}`);
                const payload = await parseJsonResponse(response, "SamSub status check");
                if (!response.ok) {
                    const message =
                        payload?.error?.message ||
                        payload?.error ||
                        payload?.description ||
                        payload?.data?.description ||
                        "Could not check SamSub status.";
                    throw new Error(message);
                }

                const statusPayload = payload && typeof payload === "object" ? payload : {};
                const interpretation = resolveSamsubState(statusPayload);
                const checkedAt = new Date();
                updateSamsubLastChecked(checkedAt);

                if (interpretation.state === "verified") {
                    await markSamsubVerified(statusPayload);
                    return;
                }

                if (interpretation.state === "failed") {
                    setSamsubStatus("failed", { showCheck: true, message: interpretation.message, lastChecked: checkedAt });
                    await updateProfileKyc(
                        {
                            samsub_status: "failed",
                            samsub_last_updated: checkedAt.toISOString(),
                            kyc_status: "failed",
                        },
                        { silent: true },
                    );
                    if (!silent) banner(interpretation.banner || interpretation.message, "warn");
                    return;
                }

                setSamsubStatus("pending", { showCheck: true, message: interpretation.message, lastChecked: checkedAt });
                await updateProfileKyc(
                    {
                        samsub_status: "pending",
                        samsub_last_updated: checkedAt.toISOString(),
                        kyc_status: "pending",
                    },
                    { silent: true },
                );
                if (!silent) banner(interpretation.banner || "SamSub is still reviewing your documents.", "warn");
            } catch (error) {
                console.error(error);
                setSamsubStatus("error", { showCheck: true, message: error.message || "Could not check SamSub status." });
                banner(error.message || "Could not check SamSub status.", "err");
            } finally {
                if (busyTarget) setBusy(busyTarget, false);
            }
        }

        function determineInitialStep(row) {
            for (let step = 1; step <= totalSteps; step += 1) {
                const fields = STEP_FIELD_GROUPS[step];
                if (!fields) continue;
                for (const key of fields) {
                    if (key === OBJECTIVES_FIELD_KEY) {
                        if (!hasValue(row?.objectives)) return step;
                    } else if (!hasValue(row?.[key])) {
                        return step;
                    }
                }
            }
            if (!resolveKycBoolean(row)) return 4;
            return totalSteps;
        }

        async function updateProfilePlan(planKey) {
            await savePlanSelection(planKey);
            return profileRow;
        }

        async function persistProfile(button) {
            if (!supabaseUser) {
                banner("Please sign in again.", "err");
                return false;
            }
            setBusy(button, true);
            try {
                let payload = collectProfilePayload();

                if (currentStep === 5) {
                    payload = await uploadKycDocumentsIfNeeded(payload);
                }
                const { data: saved, error } = await supabase
                    .from("profiles")
                    .upsert(payload, { onConflict: "id" })
                    .select("*")
                    .single();

                if (error) throw error;

                profileRow = { ...profileRow, ...saved };
                profileComplete = computeProfileComplete(saved);
                if (typeof saved.kyc_status !== "undefined") {
                    kycDone = resolveKycBoolean(saved);
                }

                autoCompleteStepsFromProfile(profileRow);

                banner("Profile saved successfully.", "ok");
                document.dispatchEvent(new Event("ah:profile-saved"));
                return true;
            } catch (error) {
                console.error(error);
                banner(error.message || "Save failed", "err");
                return false;
            } finally {
                setBusy(button, false);
            }
        }

        async function saveProfileForBrokerage() {
            if (!supabaseUser) throw new Error("Please sign in again.");
            const agreementsClientIp = await resolveClientIpAddress().catch(() => null);
            let payload = collectProfilePayload({ agreementsClientIp });
            payload = await uploadKycDocumentsIfNeeded(payload);

            const { data: saved, error } = await supabase
                .from("profiles")
                .upsert(payload, { onConflict: "id" })
                .select("*")
                .single();

            if (error) throw error;

            profileRow = { ...profileRow, ...saved };
            profileComplete = computeProfileComplete(saved);
            if (typeof saved.kyc_status !== "undefined") {
                kycDone = resolveKycBoolean(saved);
            }
            autoCompleteStepsFromProfile(profileRow);
            return saved;
        }

        const AVATAR_BUCKET = "avatars";
        const KYC_BUCKET = "kyc";

        async function uploadAvatar(file) {
            if (!supabaseUser) throw new Error("Please sign in again.");
            if (!file) throw new Error("Pick an image");
            if (!file.type.startsWith("image/")) throw new Error("Pick a valid image");
            if (file.size > 2 * 1024 * 1024) throw new Error("Image too large (max 2MB)");

            setAvatarSrc(URL.createObjectURL(file));

            const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
            const path = `${supabaseUser.id}/avatar_${Date.now()}.${ext}`;

            const { error: upErr } = await supabase.storage.from(AVATAR_BUCKET).upload(path, file, {
                upsert: true,
                cacheControl: "3600",
                contentType: file.type,
            });
            if (upErr) throw upErr;

            const { data: pub } = supabase.storage.from(AVATAR_BUCKET).getPublicUrl(path);
            const avatar_url = pub?.publicUrl;
            if (!avatar_url) throw new Error("Could not get public URL");

            const { error: dbErr } = await supabase
                .from("profiles")
                .upsert({ id: supabaseUser.id, avatar_url, updated_at: new Date().toISOString() }, { onConflict: "id" });
            if (dbErr) throw dbErr;

            profileRow = { ...profileRow, avatar_url };
            setAvatarSrc(avatar_url);
            avatarRemove?.classList.remove("hidden");
            setAvatarFilename(file.name);
            banner("Avatar updated successfully.", "ok");
        }

        async function uploadKycDocument(file, label) {
            if (!supabaseUser) throw new Error("Please sign in again.");
            if (!file) throw new Error("Pick a file to upload");

            const ext = (file.name.split(".").pop() || "bin").toLowerCase();
            const path = `${supabaseUser.id}/kyc_${label}_${Date.now()}.${ext}`;

            const { error: uploadError } = await supabase.storage.from(KYC_BUCKET).upload(path, file, {
                upsert: true,
                cacheControl: "3600",
                contentType: file.type || "application/octet-stream",
            });

            if (uploadError) {
                throw new Error(uploadError.message || "KYC upload failed. Please try again.");
            }

            const { data: pub } = supabase.storage.from(KYC_BUCKET).getPublicUrl(path);
            if (!pub?.publicUrl) throw new Error("Could not get public URL");

            return pub.publicUrl;
        }

        async function uploadKycDocumentsIfNeeded(payload) {
            if (!kycSelfieInput && !kycIdDocumentInput && !kycProofAddressInput) return payload;
            const uploads = [
                { input: kycSelfieInput, key: "kyc_selfie_url", label: "selfie" },
                { input: kycIdDocumentInput, key: "kyc_id_document_url", label: "id" },
                { input: kycProofAddressInput, key: "kyc_proof_of_address_url", label: "proof" },
            ].filter(({ input }) => (input?.files?.length || 0) > 0);

            if (!uploads.length) return payload;

            for (const { input, key, label } of uploads) {
                const file = input?.files?.[0];
                if (!file) continue;
                const url = await uploadKycDocument(file, label);
                payload[key] = url;
            }

            if (!payload.kyc_status) {
                payload.kyc_status = "submitted";
            }

            return payload;
        }

        avatarFile?.addEventListener("change", async () => {
            const file = avatarFile.files?.[0];
            if (!file) return;
            try {
                await uploadAvatar(file);
            } catch (error) {
                console.error(error);
                banner(error.message || "Avatar upload failed", "err");
                setAvatarSrc(profileRow?.avatar_url || null);
                setAvatarFilename(profileRow?.avatar_url ? "Avatar on file" : "No file chosen");
            } finally {
                avatarFile.value = "";
            }
        });

        avatarRemove?.addEventListener("click", async () => {
            if (!supabaseUser) {
                banner("Please sign in again.", "err");
                return;
            }
            try {
                const { error } = await supabase
                    .from("profiles")
                    .upsert({ id: supabaseUser.id, avatar_url: null, updated_at: new Date().toISOString() }, { onConflict: "id" });
                if (error) throw error;
                profileRow = { ...profileRow, avatar_url: null };
                setAvatarSrc(null);
                setAvatarFilename("No file chosen");
                avatarRemove.classList.add("hidden");
                banner("Avatar removed", "ok");
            } catch (error) {
                console.error(error);
                banner(error.message || "Could not remove avatar", "err");
            }
        });

        window.addEventListener("message", async (event) => {
            if (!isPaystackOrigin(event.origin)) return;

            const planKey = resolvePlanFromSource(event.source) || activePaystackPlan;
            if (!planKey || !paystackPlanKeys.includes(planKey)) return;

            const payload = coerceMessagePayload(event.data);
            if (!payload || paymentCompletion[planKey]) return;

            if (isFailedPaymentPayload(payload)) {
                markPaymentFailure(planKey);
                return;
            }

            if (!isSuccessfulPaymentPayload(payload)) return;

            await handleSuccessfulPayment(planKey);
        });

        window.addEventListener("message", async (event) => {
            if (event.origin !== window.location.origin) return;

            const payload = coerceMessagePayload(event.data);
            if (!payload || typeof payload !== "object") return;
            if (payload.source !== "algohive-paystack-success" || payload.status !== "success") return;

            const planKey = resolvePlanFromSource(event.source) || activePaystackPlan;
            if (!planKey || paymentCompletion[planKey]) return;

            await handleSuccessfulPayment(planKey);
        });

        document.querySelectorAll("[data-save-profile]").forEach((button) => {
            button.addEventListener("click", async () => {
                const validationStep = button.hasAttribute("data-complete") ? totalSteps : currentStep;
                const missing = validateProfile(validationStep);
                if (missing.length) {
                    focusFirstMissing(missing);
                    banner("Please fill in the highlighted fields.", "err");
                    return;
                }

                if (currentStep === 5 && !areKycDocumentsSelected()) {
                    banner("Please upload your selfie, ID/passport, and proof of address before continuing.", "warn");
                    syncKycContinueButton();
                    return;
                }

                const saved = await persistProfile(button);
                if (!saved) return;

                completedSteps.add(currentStep);

                    if (button.hasAttribute("data-complete")) {
                        const planSaved = await persistPlanSelectionIfNeeded();
                        if (!planSaved) return;
                        for (let step = 1; step <= totalSteps; step += 1) {
                            completedSteps.add(step);
                        }
                        syncStepIndicators();
                        button.disabled = true;
                        button.textContent = "All steps saved";
                        button.classList.add("opacity-80");
                        if (onboardingFlow) onboardingFlow.classList.add("hidden");
                        if (onboardingIntro) onboardingIntro.classList.add("hidden");
                        if (stepSummary) stepSummary.classList.add("hidden");
                        if (stepLabel) stepLabel.textContent = "All steps completed";
                        if (stepTitle) stepTitle.textContent = "Enjoy AlgoHive";
                        if (checkoutLoader) checkoutLoader.classList.add("hidden");
                        if (checkoutPanel) checkoutPanel.classList.add("hidden");
                        if (checkoutReview) checkoutReview.classList.remove("hidden");
                        if (explorePanel) explorePanel.classList.remove("hidden");
                        if (onboardingComplete) onboardingComplete.classList.remove("hidden");
                        await celebrateCompletion();
                        return;
                    }

                const delta = Number(button.dataset.stepDelta ?? 0);
                if (!Number.isNaN(delta) && delta !== 0) {
                    activateStep(currentStep + delta);
                    return;
                }

                syncStepIndicators();
            });
        });

        activateStep(1);

        (async () => {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    const next = encodeURIComponent(location.pathname + location.search + location.hash);
                    location.replace(`/auth.html?tab=in&redirect=${next}`);
                    return;
                }

                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    const next = encodeURIComponent(location.pathname + location.search + location.hash);
                    location.replace(`/auth.html?tab=in&redirect=${next}`);
                    return;
                }

                supabaseSession = session;
                supabaseUser = user;

                const row = await ensureProfile(user.id, user.email || null);
                profileRow = row;
                hydrateBrokerageFromRow(row);
                profileComplete = computeProfileComplete(row || {});
                kycDone = resolveKycBoolean(row || {});
                const existingPlan = await fetchExistingPlan(user.id);
                const brokerageRow = await fetchBrokerageAccountRow();
                if (
                    brokerageRow?.alpaca_account_id &&
                    (!profileRow?.alpaca_account_id || profileRow?.alpaca_account_id !== brokerageRow.alpaca_account_id)
                ) {
                    await updateProfileBrokerage(
                        {
                            alpaca_account_id: brokerageRow.alpaca_account_id,
                            alpaca_account_status: brokerageRow.alpaca_account_status || alpacaAccountStatus || null,
                        },
                        { silent: true },
                    );
                }
                paystackPlanKeys.forEach((planKey) => {
                    paymentCompletion[planKey] = row?.plan === planKey;
                });

                setFieldValue("first_name", row?.first_name);
                setFieldValue("last_name", row?.last_name);
                setFieldValue("phone", row?.phone);
                setFieldValue("address_line1", row?.address_line1);
                setFieldValue("address_line2", row?.address_line2);
                setFieldValue("address_city", row?.address_city);
                setFieldValue("address_state", row?.address_state);
                setFieldValue("address_postal_code", row?.address_postal_code);
                setFieldValue("dob", row?.dob);
                setFieldValue("id_number", row?.id_number);
                setFieldValue("tax_id_type", row?.tax_id_type);
                setFieldValue("tax_id_number", row?.tax_id_number);
                setFieldValue("country_birth", row?.country_birth);
                setFieldValue("nationality", row?.nationality);
                setFieldValue("country_residence", row?.country_residence);
                setFieldValue("employment_status", row?.employment_status);
                setFieldValue("occupation", row?.occupation);
                setFieldValue("employer", row?.employer);
                setFieldValue("source_of_funds", row?.source_of_funds);
                setFieldValue("annual_income_min", row?.annual_income_min);
                setFieldValue("annual_income_max", row?.annual_income_max);
                setFieldValue("liquid_net_worth_min", row?.liquid_net_worth_min);
                setFieldValue("liquid_net_worth_max", row?.liquid_net_worth_max);
                setFieldValue("total_net_worth_min", row?.total_net_worth_min);
                setFieldValue("total_net_worth_max", row?.total_net_worth_max);
                setFieldValue("experience_level", row?.experience_level);
                setFieldValue("risk_tolerance", row?.risk_tolerance);

                hydrateObjectives(row?.objectives || "");
                syncObjectivesHighlight();

                const pepEl = document.getElementById("alpacaPoliticallyExposed");
                if (pepEl) pepEl.checked = !!row?.pep;
                const pepFamilyEl = document.getElementById("alpacaFamilyExposed");
                if (pepFamilyEl) pepFamilyEl.checked = !!row?.pep_family;
                const controlPersonEl = document.getElementById("alpacaControlPerson");
                if (controlPersonEl) controlPersonEl.checked = !!row?.control_person;
                const brokerAffiliationEl = document.getElementById("alpacaAffiliated");
                if (brokerAffiliationEl) brokerAffiliationEl.checked = !!row?.broker_affiliation;
                const amlCheckbox = document.querySelector('input[name="aml"]');
                if (amlCheckbox) amlCheckbox.checked = !!row?.aml_acknowledged;
                const objectivesAck = document.querySelector('input[name="objectives_ack"]');
                if (objectivesAck) objectivesAck.checked = !!row?.suitability_risk_ack;
                const disclosuresAck = document.querySelector('input[name="disclosures"]');
                if (disclosuresAck) disclosuresAck.checked = !!row?.suitability_accuracy_ack;

                const storedAgreements = deriveStoredAgreementKeys(row);
                document.querySelectorAll('[data-alpaca-agreement]').forEach((checkbox) => {
                    const key = checkbox?.dataset?.alpacaAgreement;
                    if (key && storedAgreements.has(key)) {
                        checkbox.checked = true;
                    }
                });

                setAvatarSrc(row?.avatar_url || null);
                setAvatarFilename(row?.avatar_url ? "Avatar on file" : "No file chosen");
                avatarRemove?.classList.toggle("hidden", !row?.avatar_url);

                if (alpacaAccountId) {
                    updateAlpacaStatus("success", {
                        message: `Brokerage account already exists (ID: ${alpacaAccountId}).`,
                        response: { id: alpacaAccountId, status: alpacaAccountStatus || "on file" },
                    });
                } else {
                    renderBrokerageAccountSummary();
                }

                profileComplete = computeProfileComplete(row);
                kycDone = resolveKycBoolean(row);

                samsubExternalUserId = row?.samsub_external_user_id || row?.kyc_external_user_id || user.id || null;
                samsubApplicantId = row?.samsub_applicant_id || row?.kyc_reference || row?.kyc_applicant_id || null;

                const profileLink = !kycDone ? row?.samsub_websdk_url || null : null;
                if (profileLink) {
                    applySamsubLink(profileLink, { message: samsubLinkMessageDefault });
                } else {
                    applySamsubLink(null);
                }

                samsubLastGeneratedAt = row?.samsub_last_updated ? new Date(row.samsub_last_updated) : null;
                samsubLinkTtlSecs = SAMSUB_WEBSDK_DEFAULT_TTL;

                renderSamsubSteps();

                if (row?.samsub_last_updated) {
                    updateSamsubLastChecked(new Date(row.samsub_last_updated));
                } else {
                    updateSamsubLastChecked(null);
                }

                const normalizedStatus =
                    typeof row?.samsub_status === "string"
                        ? row.samsub_status.toLowerCase()
                        : typeof row?.kyc_status === "string"
                        ? row.kyc_status.toLowerCase()
                        : null;

                if (kycDone) {
                    setSamsubStatus("complete", {
                        showCheck: true,
                        preserveLastChecked: true,
                        lastChecked: row?.samsub_last_updated ? new Date(row.samsub_last_updated) : undefined,
                    });
                } else if (normalizedStatus === "pending") {
                    setSamsubStatus("pending", {
                        showCheck: !!samsubApplicantId,
                        preserveLastChecked: true,
                        message: "SamSub is reviewing your documents.",
                    });
                } else if (normalizedStatus === "failed") {
                    setSamsubStatus("failed", {
                        showCheck: !!samsubApplicantId,
                        preserveLastChecked: true,
                        message: "SamSub needs more information. Retry your verification.",
                    });
                } else if (
                    normalizedStatus === "verified" ||
                    normalizedStatus === "completed" ||
                    normalizedStatus === "complete"
                ) {
                    setSamsubStatus("complete", {
                        showCheck: true,
                        preserveLastChecked: true,
                        message: "Your identity is verified. You're all set!",
                    });
                } else if (samsubApplicantId && profileLink) {
                    setSamsubStatus("link_ready", {
                        showCheck: true,
                        preserveLastChecked: true,
                        message: "We saved your SamSub link. Complete the verification to continue.",
                    });
                } else if (samsubApplicantId) {
                    setSamsubStatus("pending", {
                        showCheck: true,
                        preserveLastChecked: true,
                        message: "SamSub is reviewing your documents.",
                    });
                } else {
                    setSamsubStatus("idle", { preserveLastChecked: true });
                }

                syncSamsubStartButton();
                syncKycContinueButton();

                autoCompleteStepsFromProfile(profileRow);

                const initialStep = determineInitialStep(row);
                for (let step = 1; step < initialStep; step += 1) {
                    completedSteps.add(step);
                }

                activateStep(initialStep);
            } catch (error) {
                console.error(error);
                banner(error.message || "Could not load your profile.", "err");
            }
        })();
    </script>
    <!-- Put this once (allowed by your CSP) -->
    <script src="https://static.sumsub.com/idensic/static/sumsub-kyc.js" nonce="ALGOHIVE"></script>
    <div id="sumsub-sdk" style="display:none;"></div>

    <!-- add once; your CSP must allow this script host (see note below) -->
</body>

</html>
