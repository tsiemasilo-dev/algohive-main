<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AlgoHive — Reset password</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --olive: #7e8d52;
      --olive-700: #576138;
      --ink: #0B1215;
    }
    body { background: #f6f7f6; }
    .preloader {
      position: fixed;
      inset: 0;
      z-index: 50;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: #f6f7f6;
      color: var(--ink);
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      transition: opacity .45s ease;
    }
    .preloader__logo {
      height: 3rem;
      width: auto;
      animation: heroSlideUp .6s ease-out, preloaderPulse 2.4s ease-in-out .45s infinite;
    }
    .preloader__brand {
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      animation: heroSlideUp .6s ease-out .08s both;
    }
    .preloader__tagline {
      font-size: .95rem;
      color: rgba(11, 18, 21, 0.68);
      animation: heroSlideUp .6s ease-out .14s both;
    }
    .preloader--hide {
      opacity: 0;
      pointer-events: none;
    }
    .btn-shine { position: relative; overflow: hidden; transition: transform .25s ease, box-shadow .25s ease; }
    .btn-shine::before { content: ""; position: absolute; inset: 0; pointer-events: none; background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.7) 50%, transparent 100%); transform: translateX(-120%); transition: transform .8s ease; }
    .btn-shine:hover::before { transform: translateX(120%); }
    .btn-shine:hover { transform: translateY(-1px); box-shadow: 0 10px 24px -16px rgba(11,18,21,0.4); }
    .btn-shine:disabled { box-shadow: none; transform: none; }
    .btn-shine:disabled::before { display: none; }
    .auth-left { animation: heroSlideUp .7s ease-out .25s both; }
    .auth-right { animation: heroScaleIn .9s cubic-bezier(.2,.8,.2,1) .35s both; }
    @keyframes heroScaleIn { 0% { transform: scale(1.06); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes heroSlideUp { 0% { transform: translateY(16px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
    @keyframes preloaderPulse { 0%, 100% { opacity: .45; } 50% { opacity: 1; } }
    .swap-anim { animation: heroSlideUp .5s ease both; }
    .testimonial-block {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      padding: 0.5rem 0;
    }
    .testimonial-quote {
      font-size: clamp(1.4rem, 2.3vw, 1.85rem);
      line-height: 1.4;
      font-weight: 600;
      color: #0b1215;
    }
    .testimonial-quote .highlight {
      color: var(--olive);
    }
    .testimonial-author {
      display: flex;
      align-items: center;
      gap: 0.85rem;
      color: rgba(11,18,21,0.64);
    }
    .testimonial-avatar {
      height: 52px;
      width: 52px;
      border-radius: 9999px;
      object-fit: cover;
      flex-shrink: 0;
      box-shadow: 0 14px 40px -22px rgba(11, 18, 21, 0.45);
    }
    .orb-gradient {
      background-image: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.75), rgba(255,255,255,0) 60%),
                        radial-gradient(circle at 80% 20%, rgba(126,141,82,0.18), rgba(255,255,255,0) 55%),
                        radial-gradient(circle at 50% 80%, rgba(126,141,82,0.12), rgba(255,255,255,0) 55%);
    }
  </style>
  <script nonce="ALGOHIVE">
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
</head>

<body class="min-h-screen antialiased text-slate-900">
  <div id="preloader" class="preloader">
    <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png" alt="AlgoHive logo" class="preloader__logo" />
    <span class="preloader__brand">AlgoHive</span>
    <span class="preloader__tagline">Where Smart Capital Gathers</span>
  </div>
  <div class="flex min-h-screen flex-col bg-transparent lg:flex-row lg:items-stretch">
    <!-- Left: Reset -->
    <main class="auth-left relative mx-auto w-full max-w-2xl bg-white px-6 py-12 shadow-sm sm:px-10 sm:py-14 lg:flex lg:min-h-screen lg:max-w-lg lg:flex-col lg:justify-between lg:px-16 lg:py-20 lg:shadow">
      <!-- Brand -->
      <div class="flex items-center gap-2">
        <img src="https://static.wixstatic.com/media/ac771e_af06d86a7a1f4abd87e52e45f3bcbd96~mv2.png" alt="AlgoHive" class="h-8 w-auto" />
        <span class="text-lg font-semibold tracking-tight text-[var(--ink)]">AlgoHive</span>
      </div>

      <!-- Reset content -->
      <div class="mt-10 flex-1 lg:mt-16">
        <header class="mb-9 space-y-3">
          <p class="text-xs font-semibold uppercase tracking-[0.35em] text-[var(--olive)]">Reset password</p>
          <h1 class="text-3xl font-semibold text-slate-900 sm:text-[34px]">Set a new password</h1>
          <p class="text-sm text-slate-500">Choose a strong password and confirm it below to secure your account.</p>
        </header>

        <!-- Messages -->
        <div id="msg" class="hidden mb-5 max-w-md rounded-lg border px-3 py-2 text-sm text-left"></div>

        <section class="space-y-8">
          <form id="reset-form" class="space-y-5 text-left sm:max-w-md">
            <div class="space-y-2">
              <label class="text-sm font-medium text-slate-700" for="new-password">New password</label>
              <input id="new-password" name="password" type="password" placeholder="Create a strong password" autocomplete="new-password" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[rgba(126,141,82,0.25)]" required />
              <div id="password-strength" class="hidden mt-2">
                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                  <div id="strength-bar" class="h-full transition-all duration-300" style="width: 0%; background: #ef4444;"></div>
                </div>
                <p id="strength-text" class="text-xs mt-1 text-slate-500">Password strength: <span id="strength-label">Weak</span></p>
              </div>
              <ul id="password-requirements" class="mt-2 text-xs text-slate-500 space-y-1">
                <li id="req-length" class="flex items-center gap-2"><span class="w-3 h-3 rounded-full border border-slate-300 flex items-center justify-center text-[8px]"></span>At least 8 characters</li>
                <li id="req-upper" class="flex items-center gap-2"><span class="w-3 h-3 rounded-full border border-slate-300 flex items-center justify-center text-[8px]"></span>One uppercase letter (A-Z)</li>
                <li id="req-lower" class="flex items-center gap-2"><span class="w-3 h-3 rounded-full border border-slate-300 flex items-center justify-center text-[8px]"></span>One lowercase letter (a-z)</li>
                <li id="req-number" class="flex items-center gap-2"><span class="w-3 h-3 rounded-full border border-slate-300 flex items-center justify-center text-[8px]"></span>One number (0-9)</li>
                <li id="req-special" class="flex items-center gap-2"><span class="w-3 h-3 rounded-full border border-slate-300 flex items-center justify-center text-[8px]"></span>One special character (!@#$%^&*)</li>
              </ul>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-slate-700" for="confirm-password">Confirm password</label>
              <input id="confirm-password" name="confirm_password" type="password" placeholder="Re-enter your password" autocomplete="new-password" class="w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm shadow-sm transition focus:border-[var(--olive)] focus:outline-none focus:ring-2 focus:ring-[rgba(126,141,82,0.25)]" required />
              <p id="confirm-hint" class="hidden text-xs font-medium text-rose-600">Passwords must match.</p>
            </div>
            <label class="flex items-start gap-3 rounded-2xl bg-slate-50/90 p-4 text-xs text-slate-600">
              <input id="agree" type="checkbox" class="mt-0.5 h-4 w-4 rounded border-slate-300 text-[var(--olive)] focus:ring-[var(--olive)]" />
              <span>
                I agree to the
                <a href="/terms.html" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Terms &amp; Conditions</a>,
                <a href="/privacy.html" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Privacy Policy</a>,
                <a href="/risk.html" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Risk Disclosure</a>, and
                <a href="/investment-disclaimer.html" class="font-semibold text-[var(--olive)] hover:text-[var(--olive-700)]">Investment Disclaimer</a>.
              </span>
            </label>
            <button id="reset-btn" type="submit" class="btn-shine w-full rounded-2xl bg-[var(--olive)] px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-[var(--olive-700)] disabled:cursor-not-allowed disabled:opacity-60" disabled>
              Update password
            </button>
            <p class="text-[11px] leading-relaxed text-slate-500">We’ll update your credentials and sign you back in so you can continue with AlgoHive.</p>
          </form>
        </section>
      </div>

      <!-- Notice -->
      <footer class="mt-14 border-t border-slate-100 pt-6 text-left text-[11px] leading-5 text-slate-500">
        AlgoHive (<b>FSP 55118</b>) is an authorised Financial Services Provider. All investment activity carries risk, including the possible loss of capital and liquidity constraints. Any information provided here is educational in nature, does not constitute personalised financial advice, and should not be relied on as a recommendation to buy or sell securities. Please consider whether investing is appropriate for your circumstances and consult an independent adviser where necessary.
      </footer>
    </main>

    <!-- Right: Preview -->
    <aside class="auth-right relative hidden w-full bg-[#f7f9ff] px-6 py-14 shadow-inner lg:flex lg:flex-1 lg:items-stretch lg:rounded-none lg:px-20 lg:py-20">
      <div class="absolute inset-0 orb-gradient opacity-95"></div>
      <div class="relative z-10 ml-auto flex w-full max-w-5xl flex-col items-start gap-12">
        <section class="w-full max-w-xl space-y-6 text-left text-slate-700">
          <article class="testimonial-block">
            <p class="testimonial-quote">“We lift the veil so <span class="highlight">every strategy is in the open.</span>”</p>
            <div class="testimonial-author">
              <img
                src="https://aazofjsssobejhkyyiqv.supabase.co/storage/v1/object/public/AlgoHive/Media%20Assets/1673431038869.jpeg"
                alt="Lonwabo Damane"
                class="testimonial-avatar"
              />
              <div>
                <p class="text-sm font-semibold text-slate-900">Lonwabo Damane</p>
                <p class="text-[11px] uppercase tracking-[0.3em] text-slate-500">CEO · AlgoHive</p>
              </div>
            </div>
          </article>
        </section>
        <figure class="relative w-full overflow-hidden rounded-[10px] bg-[#0b1215] shadow-[0_45px_120px_-60px_rgba(11,18,21,0.45)]">
          <video
            class="block w-full"
            autoplay
            loop
            muted
            playsinline
            preload="auto"
          >
            <source src="https://aazofjsssobejhkyyiqv.supabase.co/storage/v1/object/public/AlgoHive/Media%20Assets/Screen%20Recording%202025-11-05%20at%2018.14.15.mov" />
            Your browser does not support the video tag.
          </video>
        </figure>

      </div>
    </aside>
  </div>

  <script type="module" nonce="ALGOHIVE">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://aazofjsssobejhkyyiqv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhem9manNzc29iZWpoa3l5aXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMTI1NDUsImV4cCI6MjA3MzY4ODU0NX0.guYlxaV5RwTlTVFoUhpER0KWEIGPay8svLsxMwyRUyM";

    // IMPORTANT: Use detectSessionInUrl: false to prevent Supabase from auto-processing
    // and redirecting. We'll handle the recovery tokens manually.
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { 
        persistSession: true, 
        autoRefreshToken: true, 
        detectSessionInUrl: false  // Prevent auto-processing of URL tokens
      }
    });

    // Capture tokens from URL IMMEDIATELY before anything else runs
    const capturedHash = window.location.hash;
    const capturedSearch = window.location.search;

    const preloader = document.getElementById("preloader");
    window.addEventListener("load", () => {
      if (!preloader) return;
      preloader.classList.add("preloader--hide");
      setTimeout(() => preloader.remove(), 450);
    });

    const msg = document.getElementById("msg");
    const form = document.getElementById("reset-form");
    const passwordInput = document.getElementById("new-password");
    const confirmInput = document.getElementById("confirm-password");
    const confirmHint = document.getElementById("confirm-hint");
    const agree = document.getElementById("agree");
    const btn = document.getElementById("reset-btn");

    const REQUIRED_PROFILE_FIELDS = [
      "first_name", "last_name", "phone", "dob", "id_number", "nationality",
      "country_residence", "employment_status", "occupation", "employer",
      "income_bracket", "source_of_funds", "net_worth_range", "experience_level",
      "risk_tolerance", "objectives",
    ];
    const hasValue = (value) => String(value ?? "").trim().length > 0;
    const computeProfileComplete = (row) =>
      REQUIRED_PROFILE_FIELDS.every((key) => hasValue(row?.[key]));
    const resolveKycBoolean = (row) => {
      const v = row?.kyc_status;
      if (typeof v === "boolean") return v;
      if (typeof v === "string")
        return ["verified", "approved", "done", "passed", "kyc_done"].includes(v.toLowerCase());
      return false;
    };
    const gateBannerMessage = (profileComplete, kycDone) => {
      if (!profileComplete && !kycDone) return "Please finish Additional Info and complete KYC first.";
      if (!profileComplete) return "Please finish Additional Info first.";
      if (!kycDone) return "Please complete KYC first.";
      return "";
    };

    async function redirectAfterReset(preferred = "/home.html") {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        location.replace(preferred);
        return;
      }

      location.replace(preferred);
    }

    function showMsg(text, type = "info") {
      msg.classList.remove("hidden", "bg-rose-50", "text-rose-700", "border-rose-200", "bg-emerald-50", "text-emerald-700", "border-emerald-200");
      msg.classList.add("border", "border-slate-200", "bg-white", "text-slate-600");
      if (type === "success") {
        msg.classList.add("bg-emerald-50", "text-emerald-700", "border-emerald-200");
        msg.classList.remove("bg-white", "text-slate-600", "border-slate-200");
      }
      if (type === "error") {
        msg.classList.add("bg-rose-50", "text-rose-700", "border-rose-200");
        msg.classList.remove("bg-white", "text-slate-600", "border-slate-200");
      }
      msg.textContent = text;
    }

    function hideMsg() {
      msg.classList.add("hidden");
      msg.textContent = "";
    }

    function setLoading(on) {
      btn.disabled = on;
      btn.textContent = on ? "Updating…" : "Update password";
    }

    // Password validation
    const passwordStrengthDiv = document.getElementById("password-strength");
    const strengthBar = document.getElementById("strength-bar");
    const strengthLabel = document.getElementById("strength-label");
    const reqLength = document.getElementById("req-length");
    const reqUpper = document.getElementById("req-upper");
    const reqLower = document.getElementById("req-lower");
    const reqNumber = document.getElementById("req-number");
    const reqSpecial = document.getElementById("req-special");

    function isPasswordValid(password) {
      return password.length >= 8 &&
        /[A-Z]/.test(password) &&
        /[a-z]/.test(password) &&
        /[0-9]/.test(password) &&
        /[!@#$%^&*()\-_=+{}\[\]|;:,.<>?\/]/.test(password);
    }

    function updatePasswordStrength(password) {
      if (!password) {
        passwordStrengthDiv.classList.add("hidden");
        return;
      }
      passwordStrengthDiv.classList.remove("hidden");

      const checks = {
        length: password.length >= 8,
        upper: /[A-Z]/.test(password),
        lower: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*()\-_=+{}\[\]|;:,.<>?\/]/.test(password)
      };

      // Update requirement indicators
      const updateReq = (el, valid) => {
        const icon = el.querySelector("span");
        if (valid) {
          el.classList.add("text-[var(--olive)]");
          el.classList.remove("text-slate-500");
          icon.style.background = "var(--olive)";
          icon.style.borderColor = "var(--olive)";
          icon.innerHTML = "✓";
          icon.style.color = "white";
        } else {
          el.classList.remove("text-[var(--olive)]");
          el.classList.add("text-slate-500");
          icon.style.background = "";
          icon.style.borderColor = "";
          icon.innerHTML = "";
        }
      };

      updateReq(reqLength, checks.length);
      updateReq(reqUpper, checks.upper);
      updateReq(reqLower, checks.lower);
      updateReq(reqNumber, checks.number);
      updateReq(reqSpecial, checks.special);

      // Calculate strength
      const passed = Object.values(checks).filter(Boolean).length;
      let strength = "Weak", color = "#ef4444", width = "25%";
      if (passed >= 5) { strength = "Very Strong"; color = "#10b981"; width = "100%"; }
      else if (passed >= 4) { strength = "Strong"; color = "#22c55e"; width = "75%"; }
      else if (passed >= 3) { strength = "Medium"; color = "#f59e0b"; width = "50%"; }

      strengthBar.style.width = width;
      strengthBar.style.background = color;
      strengthLabel.textContent = strength;
      strengthLabel.style.color = color;
    }

    function updateConfirmHint() {
      const pass = passwordInput.value.trim();
      const confirm = confirmInput.value.trim();
      const mismatch = confirm.length > 0 && pass !== confirm;
      confirmHint.classList.toggle("hidden", !mismatch);
      return !mismatch && pass.length > 0 && confirm.length > 0;
    }

    function updateButtonState() {
      const passwordsMatch = updateConfirmHint();
      const hasValues = passwordInput.value.trim().length > 0 && confirmInput.value.trim().length > 0;
      const passwordValid = isPasswordValid(passwordInput.value.trim());
      const canSubmit = passwordsMatch && hasValues && agree.checked && passwordValid;
      btn.disabled = !canSubmit;
    }

    passwordInput.addEventListener("input", () => {
      updatePasswordStrength(passwordInput.value);
      updateButtonState();
      hideMsg();
    });
    confirmInput.addEventListener("input", () => {
      updateButtonState();
      hideMsg();
    });
    agree.addEventListener("change", () => {
      updateButtonState();
      hideMsg();
    });

    async function ensureRecoverySession() {
      // First check for existing session
      let { data: { session } } = await supabase.auth.getSession();
      if (session) {
        console.log("Found existing session");
        return session;
      }

      // Try to extract tokens from CAPTURED URL hash (before any modifications)
      const hash = new URLSearchParams(capturedHash.replace(/^#/, ""));
      const type = hash.get("type");
      const access_token = hash.get("access_token");
      const refresh_token = hash.get("refresh_token");

      console.log("Recovery attempt - type:", type, "has_access_token:", !!access_token, "has_refresh_token:", !!refresh_token);

      if (type === "recovery" && access_token && refresh_token) {
        const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
        if (error) {
          console.error("setSession error:", error);
          return null;
        }
        console.log("Session set successfully from hash tokens");
        return data.session;
      }

      // Also check CAPTURED URL query params (some Supabase versions use this)
      const params = new URLSearchParams(capturedSearch);
      const queryType = params.get("type");
      const queryAccessToken = params.get("access_token");
      const queryRefreshToken = params.get("refresh_token");

      if (queryType === "recovery" && queryAccessToken && queryRefreshToken) {
        const { data, error } = await supabase.auth.setSession({ 
          access_token: queryAccessToken, 
          refresh_token: queryRefreshToken 
        });
        if (error) {
          console.error("setSession error:", error);
          return null;
        }
        console.log("Session set successfully from query tokens");
        return data.session;
      }

      console.log("No recovery tokens found in URL");
      return null;
    }

    // Listen for auth state changes
    supabase.auth.onAuthStateChange((event, session) => {
      console.log("Auth state changed:", event);
      if (event === "PASSWORD_RECOVERY" || event === "SIGNED_IN") {
        if (session) {
          hideMsg();
          form.classList.remove("hidden");
        }
      }
    });

    // Initialize
    const session = await ensureRecoverySession();
    if (session) {
      // Clear the URL hash for cleaner appearance (but we already have the session)
      if (window.history.replaceState) {
        window.history.replaceState(null, '', window.location.pathname);
      }
      form.classList.remove("hidden");
    } else {
      showMsg("Recovery link invalid or expired. Please request a new password reset link.", "error");
      form.classList.add("hidden");
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideMsg();

      const pass = passwordInput.value.trim();
      const confirm = confirmInput.value.trim();
      if (pass !== confirm) {
        updateButtonState();
        showMsg("Passwords must match before we can update them.", "error");
        return;
      }
      if (!isPasswordValid(pass)) {
        showMsg("Please ensure your password meets all the security requirements.", "error");
        return;
      }
      if (!agree.checked) {
        showMsg("Please accept the Terms, Privacy, Risk and Investment Disclaimer.", "error");
        return;
      }

      try {
        setLoading(true);
        const { error } = await supabase.auth.updateUser({ password: pass });
        if (error) throw error;
        showMsg("Password updated. Redirecting…", "success");
        await redirectAfterReset();
      } catch (err) {
        showMsg(err.message || "Failed to update password.", "error");
      } finally {
        setLoading(false);
        updateButtonState();
      }
    });

    updateButtonState();
  </script>
</body>
</html>
